{% extends "base.html" %}

{% block content %}
<style>
/* –°—Ç–∏–ª—ñ —É—á–Ω—ñ–≤ –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–º —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–æ–º */
#studentsTable {
    margin-top: 20px;
}

/* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
#studentsTable th:nth-child(1), #studentsTable td:nth-child(1) { min-width: 120px; } /* –ü–Ü–ë */
#studentsTable th:nth-child(2), #studentsTable td:nth-child(2) { min-width: 100px; } /* –í—ñ–∫/–ö–ª–∞—Å */
#studentsTable th:nth-child(3), #studentsTable td:nth-child(3) { min-width: 130px; } /* –¢–µ–ª–µ—Ñ–æ–Ω–∏ */
#studentsTable th:nth-child(4), #studentsTable td:nth-child(4) { min-width: 120px; } /* –ú—ñ—Å—Ü–µ */
#studentsTable th:nth-child(5), #studentsTable td:nth-child(5) { min-width: 200px; } /* –ü—ñ–ª—å–≥–∏ */
#studentsTable th:nth-child(6), #studentsTable td:nth-child(6) { min-width: 100px; } /* –î—ñ—ó */

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑ —è—Å–∫—Ä–∞–≤–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤ */
#studentsTable thead th {
    white-space: nowrap;
    padding: 12px 8px;
}

/* –§—ñ–ª—å—Ç—Ä–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ */
#studentsTable .filter-row td {
    padding: 8px 6px;
}

#studentsTable .filter-input,
#studentsTable .filter-select {
    font-size: 0.85rem;
    padding: 4px 8px;
    min-width: 90px;
}

/* –ë–µ–π–¥–∂—ñ –ø—ñ–ª—å–≥ */
.benefit-badge {
    font-size: 0.7rem;
    margin: 1px;
    padding: 2px 6px;
}

/* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
#studentsTable .btn-group .btn {
    margin: 0 1px;
    padding: 4px 8px;
}
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —É—á–Ω—è–º–∏</h2>
    <div class="btn-group">
        <button type="button" class="btn btn-success" onclick="openAddStudentModal()">
            <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ —É—á–Ω—è
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="exportStudentsData()">
            <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç
        </button>
    </div>
</div>

<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="studentsTable">
                <thead>
                    <tr>
                        <th>–ü–Ü–ë</th>
                        <th>–í—ñ–∫/–ö–ª–∞—Å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω–∏</th>
                        <th>–ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</th>
                        <th>–ü—ñ–ª—å–≥–∏</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                    <!-- –†—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
                    <tr class="filter-row">
                        <td>
                            <input type="text" class="form-control form-control-sm filter-input" id="filterName" 
                                   placeholder="–ü–æ—à—É–∫ –ø–æ –ü–Ü–ë..." onkeyup="filterStudents()">
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm filter-input" id="filterAgeGrade" 
                                   placeholder="–í—ñ–∫ –∞–±–æ –∫–ª–∞—Å..." onkeyup="filterStudents()">
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm filter-input" id="filterPhone" 
                                   placeholder="–¢–µ–ª–µ—Ñ–æ–Ω..." onkeyup="filterStudents()">
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterLocation" onchange="filterStudents()">
                                <option value="">–í—Å—ñ –º—ñ—Å—Ü—è</option>
                                <option value="–°–µ–ª–æ">–°–µ–ª–æ</option>
                                <option value="–°–ú–¢">–°–ú–¢</option>
                                <option value="–ú—ñ—Å—Ç–æ">–ú—ñ—Å—Ç–æ</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterBenefit" onchange="filterStudents()">
                                <option value="">–í—Å—ñ –ø—ñ–ª—å–≥–∏</option>
                                <option value="benefit_low_income">–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ</option>
                                <option value="benefit_large_family">–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ</option>
                                <option value="benefit_military_family">–°—ñ–º'—è –ó–°–£</option>
                                <option value="benefit_internally_displaced">–í–ü–û</option>
                                <option value="benefit_orphan">–°–∏—Ä–æ—Ç–∞/–ø—ñ–¥ –æ–ø—ñ–∫–æ—é</option>
                                <option value="benefit_disability">–î–∏—Ç–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é</option>
                                <option value="benefit_social_risk">–°–ñ–û</option>
                                <option value="no_benefits">–ë–µ–∑ –ø—ñ–ª—å–≥</option>
                            </select>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetStudentFilters()" title="–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </td>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <!-- –î–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            </div>
            <div class="card-body" id="studentsStats">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—ñ–ª—å–≥–∞—Ö</h5>
            </div>
            <div class="card-body" id="benefitsStats">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—ñ–ª—å–≥–∞—Ö –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —É—á–Ω—è -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStudentModalLabel">
                    <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ —É—á–Ω—è
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
                    <h6 class="mb-3">üë§ –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addFirstName" class="form-label">–Ü–º'—è *</label>
                                <input type="text" class="form-control" id="addFirstName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addLastName" class="form-label">–ü—Ä—ñ–∑–≤–∏—â–µ *</label>
                                <input type="text" class="form-control" id="addLastName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="addBirthDate" class="form-label">–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                                <input type="date" class="form-control" id="addBirthDate">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="addAge" class="form-label">–í—ñ–∫</label>
                                <input type="number" class="form-control" id="addAge" min="5" max="18">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="addGrade" class="form-label">–ö–ª–∞—Å —É —à–∫–æ–ª—ñ</label>
                                <input type="text" class="form-control" id="addGrade" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 5-–ê">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addPhoneChild" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –¥–∏—Ç–∏–Ω–∏</label>
                        <input type="tel" class="form-control" id="addPhoneChild" placeholder="+380...">
                    </div>
                    
                    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–∞—Ç—å–∫—ñ–≤ -->
                    <h6 class="mb-3 mt-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–∞—Ç—å–∫—ñ–≤</h6>
                    <div class="mb-3">
                        <label for="addParentName" class="form-label">–ü–Ü–ë –±–∞—Ç—å–∫–∞/–º–∞—Ç–µ—Ä—ñ</label>
                        <input type="text" class="form-control" id="addParentName">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addPhoneMother" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Ç–µ—Ä—ñ</label>
                                <input type="tel" class="form-control" id="addPhoneMother" placeholder="+380...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addPhoneFather" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –±–∞—Ç—å–∫–∞</label>
                                <input type="tel" class="form-control" id="addPhoneFather" placeholder="+380...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è -->
                    <h6 class="mb-3 mt-4">üè† –ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addLocation" class="form-label">–ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</label>
                                <input type="text" class="form-control" id="addLocation" placeholder="–ù–∞–∑–≤–∞ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addSettlementType" class="form-label">–¢–∏–ø –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É</label>
                                <select class="form-select" id="addSettlementType">
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø</option>
                                    <option value="–°–µ–ª–æ">–°–µ–ª–æ</option>
                                    <option value="–°–ú–¢">–°–ú–¢ (—Å–µ–ª–∏—â–µ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É)</option>
                                    <option value="–ú—ñ—Å—Ç–æ">–ú—ñ—Å—Ç–æ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addAddress" class="form-label">–ê–¥—Ä–µ—Å–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</label>
                        <textarea class="form-control" id="addAddress" rows="2" placeholder="–ü–æ–≤–Ω–∞ –∞–¥—Ä–µ—Å–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è"></textarea>
                    </div>
                    
                    <!-- –ü—ñ–ª—å–≥–∏ -->
                    <h6 class="mb-3 mt-4">üè∑Ô∏è –ü—ñ–ª—å–≥–∏ —Ç–∞ —Å—Ç–∞—Ç—É—Å</h6>
                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> –û–±–µ—Ä—ñ—Ç—å –≤—Å—ñ –ø—ñ–ª—å–≥–∏ —è–∫—ñ —Å—Ç–æ—Å—É—é—Ç—å—Å—è —Ü—ñ—î—ó –¥–∏—Ç–∏–Ω–∏. –¶—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∑–≤—ñ—Ç–Ω–æ—Å—Ç—ñ.</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="addBenefitLowIncome">
                                <label class="form-check-label" for="addBenefitLowIncome">
                                    <span class="badge bg-warning">–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="addBenefitLargeFamily">
                                <label class="form-check-label" for="addBenefitLargeFamily">
                                    <span class="badge bg-info">–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="addBenefitMilitaryFamily">
                                <label class="form-check-label" for="addBenefitMilitaryFamily">
                                    <span class="badge bg-success">–°—ñ–º'—è –ó–°–£</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="addBenefitInternallyDisplaced">
                                <label class="form-check-label" for="addBenefitInternallyDisplaced">
                                    <span class="badge bg-primary">–í–ü–û</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="addBenefitOrphan">
                                <label class="form-check-label" for="addBenefitOrphan">
                                    <span class="badge bg-secondary">–°–∏—Ä–æ—Ç–∞/–ø—ñ–¥ –æ–ø—ñ–∫–æ—é</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="addBenefitDisability">
                                <label class="form-check-label" for="addBenefitDisability">
                                    <span class="badge bg-danger">–î–∏—Ç–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="addBenefitSocialRisk">
                                <label class="form-check-label" for="addBenefitSocialRisk">
                                    <span class="badge bg-dark">–°–ñ–û</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-success" onclick="saveNewStudent()">
                    <i class="bi bi-check-lg"></i> –î–æ–¥–∞—Ç–∏ —É—á–Ω—è
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—á–Ω—è -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStudentModalLabel">
                    <i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —É—á–Ω—è
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <input type="hidden" id="editStudentId">
                    <!-- –ü–æ–≤—Ç–æ—Ä—é—î–º–æ —Ç—É —Å–∞–º—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É —â–æ —ñ –≤ addStudentModal, –∞–ª–µ –∑ editXxx id -->
                    <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
                    <h6 class="mb-3">üë§ –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFirstName" class="form-label">–Ü–º'—è *</label>
                                <input type="text" class="form-control" id="editFirstName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLastName" class="form-label">–ü—Ä—ñ–∑–≤–∏—â–µ *</label>
                                <input type="text" class="form-control" id="editLastName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editBirthDate" class="form-label">–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                                <input type="date" class="form-control" id="editBirthDate">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editAge" class="form-label">–í—ñ–∫</label>
                                <input type="number" class="form-control" id="editAge" min="5" max="18">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editGrade" class="form-label">–ö–ª–∞—Å —É —à–∫–æ–ª—ñ</label>
                                <input type="text" class="form-control" id="editGrade" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 5-–ê">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editPhoneChild" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –¥–∏—Ç–∏–Ω–∏</label>
                        <input type="tel" class="form-control" id="editPhoneChild" placeholder="+380...">
                    </div>
                    
                    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–∞—Ç—å–∫—ñ–≤ -->
                    <h6 class="mb-3 mt-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–∞—Ç—å–∫—ñ–≤</h6>
                    <div class="mb-3">
                        <label for="editParentName" class="form-label">–ü–Ü–ë –±–∞—Ç—å–∫–∞/–º–∞—Ç–µ—Ä—ñ</label>
                        <input type="text" class="form-control" id="editParentName">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPhoneMother" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Ç–µ—Ä—ñ</label>
                                <input type="tel" class="form-control" id="editPhoneMother" placeholder="+380...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPhoneFather" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –±–∞—Ç—å–∫–∞</label>
                                <input type="tel" class="form-control" id="editPhoneFather" placeholder="+380...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è -->
                    <h6 class="mb-3 mt-4">üè† –ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLocation" class="form-label">–ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</label>
                                <input type="text" class="form-control" id="editLocation" placeholder="–ù–∞–∑–≤–∞ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSettlementType" class="form-label">–¢–∏–ø –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É</label>
                                <select class="form-select" id="editSettlementType">
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø</option>
                                    <option value="–°–µ–ª–æ">–°–µ–ª–æ</option>
                                    <option value="–°–ú–¢">–°–ú–¢ (—Å–µ–ª–∏—â–µ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É)</option>
                                    <option value="–ú—ñ—Å—Ç–æ">–ú—ñ—Å—Ç–æ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAddress" class="form-label">–ê–¥—Ä–µ—Å–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</label>
                        <textarea class="form-control" id="editAddress" rows="2" placeholder="–ü–æ–≤–Ω–∞ –∞–¥—Ä–µ—Å–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è"></textarea>
                    </div>
                    
                    <!-- –ü—ñ–ª—å–≥–∏ -->
                    <h6 class="mb-3 mt-4">üè∑Ô∏è –ü—ñ–ª—å–≥–∏ —Ç–∞ —Å—Ç–∞—Ç—É—Å</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="editBenefitLowIncome">
                                <label class="form-check-label" for="editBenefitLowIncome">
                                    <span class="badge bg-warning">–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="editBenefitLargeFamily">
                                <label class="form-check-label" for="editBenefitLargeFamily">
                                    <span class="badge bg-info">–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="editBenefitMilitaryFamily">
                                <label class="form-check-label" for="editBenefitMilitaryFamily">
                                    <span class="badge bg-success">–°—ñ–º'—è –ó–°–£</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="editBenefitInternallyDisplaced">
                                <label class="form-check-label" for="editBenefitInternallyDisplaced">
                                    <span class="badge bg-primary">–í–ü–û</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="editBenefitOrphan">
                                <label class="form-check-label" for="editBenefitOrphan">
                                    <span class="badge bg-secondary">–°–∏—Ä–æ—Ç–∞/–ø—ñ–¥ –æ–ø—ñ–∫–æ—é</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="editBenefitDisability">
                                <label class="form-check-label" for="editBenefitDisability">
                                    <span class="badge bg-danger">–î–∏—Ç–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="editBenefitSocialRisk">
                                <label class="form-check-label" for="editBenefitSocialRisk">
                                    <span class="badge bg-dark">–°–ñ–û</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-warning" onclick="updateStudent()">
                    <i class="bi bi-check-lg"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
let allStudents = [];

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
async function loadAllStudentsData() {
    try {
        showLoading(true);
        
        const response = await fetch('/api/students');
        if (!response.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤');
        }
        
        allStudents = await response.json();
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ
        displayStudents(allStudents);
        updateStudentsStats(allStudents);
        
        showLoading(false);
    } catch (error) {
        showLoading(false);
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤', 'danger');
    }
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
function displayStudents(students) {
    const tableBody = document.getElementById('studentsTableBody');
    
    if (students.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="bi bi-people"></i><br>
                    –°—Ç—É–¥–µ–Ω—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–¥–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏
                </td>
            </tr>`;
        return;
    }
    
    let bodyHTML = '';
    
    students.forEach(student => {
        // –§–æ—Ä–º—É—î–º–æ –ü–Ü–ë
        const fullName = `${student.first_name} ${student.last_name}`;
        
        // –í—ñ–∫ —Ç–∞ –∫–ª–∞—Å
        const ageGrade = `${student.age || '?'} —Ä. ${student.grade ? '(' + student.grade + ')' : ''}`;
        
        // –¢–µ–ª–µ—Ñ–æ–Ω–∏
        const phones = [
            student.phone_child && `üë∂ ${student.phone_child}`,
            student.phone_mother && `üë© ${student.phone_mother}`, 
            student.phone_father && `üë® ${student.phone_father}`
        ].filter(Boolean).join('<br>') || '-';
        
        // –ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è
        const location = student.settlement_type ? 
            `${student.settlement_type}${student.location ? ': ' + student.location : ''}` : 
            (student.location || '-');
        
        // –ü—ñ–ª—å–≥–∏ - —Ñ–æ—Ä–º—É—î–º–æ –±–µ–π–¥–∂—ñ
        const benefits = [];
        if (student.benefit_low_income) benefits.push('<span class="badge bg-warning benefit-badge">–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ</span>');
        if (student.benefit_large_family) benefits.push('<span class="badge bg-info benefit-badge">–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ</span>');
        if (student.benefit_military_family) benefits.push('<span class="badge bg-success benefit-badge">–°—ñ–º\'—è –ó–°–£</span>');
        if (student.benefit_internally_displaced) benefits.push('<span class="badge bg-primary benefit-badge">–í–ü–û</span>');
        if (student.benefit_orphan) benefits.push('<span class="badge bg-secondary benefit-badge">–°–∏—Ä–æ—Ç–∞</span>');
        if (student.benefit_disability) benefits.push('<span class="badge bg-danger benefit-badge">–Ü–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å</span>');
        if (student.benefit_social_risk) benefits.push('<span class="badge bg-dark benefit-badge">–°–ñ–û</span>');
        
        const benefitsDisplay = benefits.length > 0 ? benefits.join(' ') : '<span class="text-muted">–ë–µ–∑ –ø—ñ–ª—å–≥</span>';
        
        // HTML –¥–ª—è —Ä—è–¥–∫–∞
        bodyHTML += `
            <tr>
                <td><strong>${fullName}</strong></td>
                <td>${ageGrade}</td>
                <td><small>${phones}</small></td>
                <td><small>${location}</small></td>
                <td>${benefitsDisplay}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewStudent(${student.id})" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="editStudent(${student.id})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${student.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
    });
    
    tableBody.innerHTML = bodyHTML;
}

// –§—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
function filterStudents() {
    const nameFilter = document.getElementById('filterName').value.toLowerCase();
    const ageGradeFilter = document.getElementById('filterAgeGrade').value.toLowerCase();
    const phoneFilter = document.getElementById('filterPhone').value.toLowerCase();
    const locationFilter = document.getElementById('filterLocation').value;
    const benefitFilter = document.getElementById('filterBenefit').value;
    
    let filteredStudents = allStudents;
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –ü–Ü–ë
    if (nameFilter) {
        filteredStudents = filteredStudents.filter(student => {
            const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
            return fullName.includes(nameFilter);
        });
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≤—ñ–∫—É/–∫–ª–∞—Å—É
    if (ageGradeFilter) {
        filteredStudents = filteredStudents.filter(student => {
            const ageString = (student.age || '').toString();
            const gradeString = (student.grade || '').toLowerCase();
            return ageString.includes(ageGradeFilter) || gradeString.includes(ageGradeFilter);
        });
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    if (phoneFilter) {
        filteredStudents = filteredStudents.filter(student => {
            const phones = [student.phone_child, student.phone_mother, student.phone_father]
                .filter(Boolean).join(' ').toLowerCase();
            return phones.includes(phoneFilter);
        });
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É
    if (locationFilter) {
        filteredStudents = filteredStudents.filter(student => student.settlement_type === locationFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –ø—ñ–ª—å–≥–∞—Ö
    if (benefitFilter) {
        if (benefitFilter === 'no_benefits') {
            filteredStudents = filteredStudents.filter(student => {
                return !student.benefit_low_income && !student.benefit_large_family && 
                       !student.benefit_military_family && !student.benefit_internally_displaced &&
                       !student.benefit_orphan && !student.benefit_disability && !student.benefit_social_risk;
            });
        } else {
            filteredStudents = filteredStudents.filter(student => student[benefitFilter] === true);
        }
    }
    
    displayStudents(filteredStudents);
    updateStudentsStats(filteredStudents);
}

// –°–∫–∏–¥–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function resetStudentFilters() {
    document.getElementById('filterName').value = '';
    document.getElementById('filterAgeGrade').value = '';
    document.getElementById('filterPhone').value = '';
    document.getElementById('filterLocation').value = '';
    document.getElementById('filterBenefit').value = '';
    
    displayStudents(allStudents);
    updateStudentsStats(allStudents);
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStudentsStats(students = allStudents) {
    const total = students.length;
    
    // –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    document.getElementById('studentsStats').innerHTML = `
        <p><strong>–í—Å—å–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤:</strong> ${total}</p>
        <p><strong>–ó –ø—ñ–ª—å–≥–∞–º–∏:</strong> ${students.filter(s => s.benefit_low_income || s.benefit_large_family || s.benefit_military_family || s.benefit_internally_displaced || s.benefit_orphan || s.benefit_disability || s.benefit_social_risk).length}</p>
        <p><strong>–ë–µ–∑ –ø—ñ–ª—å–≥:</strong> ${students.filter(s => !s.benefit_low_income && !s.benefit_large_family && !s.benefit_military_family && !s.benefit_internally_displaced && !s.benefit_orphan && !s.benefit_disability && !s.benefit_social_risk).length}</p>
    `;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—ñ–ª—å–≥–∞—Ö
    const benefitStats = {
        '–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ': students.filter(s => s.benefit_low_income).length,
        '–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ': students.filter(s => s.benefit_large_family).length,
        '–°—ñ–º\'—è –ó–°–£': students.filter(s => s.benefit_military_family).length,
        '–í–ü–û': students.filter(s => s.benefit_internally_displaced).length,
        '–°–∏—Ä–æ—Ç–∞/–ø—ñ–¥ –æ–ø—ñ–∫–æ—é': students.filter(s => s.benefit_orphan).length,
        '–î–∏—Ç–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é': students.filter(s => s.benefit_disability).length,
        '–°–ñ–û': students.filter(s => s.benefit_social_risk).length
    };
    
    let benefitsHTML = '';
    for (const [benefit, count] of Object.entries(benefitStats)) {
        if (count > 0) {
            const percentage = ((count / total) * 100).toFixed(1);
            benefitsHTML += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${benefit}</span>
                    <span><strong>${count}</strong> <small class="text-muted">(${percentage}%)</small></span>
                </div>
            `;
        }
    }
    
    if (benefitsHTML === '') {
        benefitsHTML = '<p class="text-muted">–ù–µ–º–∞—î —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –ø—ñ–ª—å–≥–∞–º–∏</p>';
    }
    
    document.getElementById('benefitsStats').innerHTML = benefitsHTML;
}

// –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞
function openAddStudentModal() {
    // –û—á–∏—â–∞—î–º–æ —Ñ–æ—Ä–º—É
    document.getElementById('addStudentForm').reset();
    
    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    new bootstrap.Modal(document.getElementById('addStudentModal')).show();
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
async function saveNewStudent() {
    const formData = {
        first_name: document.getElementById('addFirstName').value,
        last_name: document.getElementById('addLastName').value,
        birth_date: document.getElementById('addBirthDate').value || null,
        age: parseInt(document.getElementById('addAge').value) || null,
        grade: document.getElementById('addGrade').value || null,
        phone_child: document.getElementById('addPhoneChild').value || null,
        parent_name: document.getElementById('addParentName').value || null,
        phone_mother: document.getElementById('addPhoneMother').value || null,
        phone_father: document.getElementById('addPhoneFather').value || null,
        location: document.getElementById('addLocation').value || null,
        settlement_type: document.getElementById('addSettlementType').value || null,
        address: document.getElementById('addAddress').value || null,
        benefit_low_income: document.getElementById('addBenefitLowIncome').checked,
        benefit_large_family: document.getElementById('addBenefitLargeFamily').checked,
        benefit_military_family: document.getElementById('addBenefitMilitaryFamily').checked,
        benefit_internally_displaced: document.getElementById('addBenefitInternallyDisplaced').checked,
        benefit_orphan: document.getElementById('addBenefitOrphan').checked,
        benefit_disability: document.getElementById('addBenefitDisability').checked,
        benefit_social_risk: document.getElementById('addBenefitSocialRisk').checked
    };
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
    if (!formData.first_name || !formData.last_name) {
        showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è (–Ü–º\'—è —Ç–∞ –ü—Ä—ñ–∑–≤–∏—â–µ)', 'danger');
        return;
    }
    
    try {
        const response = await fetch('/api/students', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞');
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
        await loadAllStudentsData();
        bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
        showAlert('–°—Ç—É–¥–µ–Ω—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ', 'success');
        
    } catch (error) {
        showAlert(error.message, 'danger');
    }
}

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞
function editStudent(id) {
    const student = allStudents.find(s => s.id === id);
    if (!student) {
        showAlert('–°—Ç—É–¥–µ–Ω—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'danger');
        return;
    }
    
    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ–æ—Ä–º—É –¥–∞–Ω–∏–º–∏
    document.getElementById('editStudentId').value = student.id;
    document.getElementById('editFirstName').value = student.first_name || '';
    document.getElementById('editLastName').value = student.last_name || '';
    document.getElementById('editBirthDate').value = student.birth_date || '';
    document.getElementById('editAge').value = student.age || '';
    document.getElementById('editGrade').value = student.grade || '';
    document.getElementById('editPhoneChild').value = student.phone_child || '';
    document.getElementById('editParentName').value = student.parent_name || '';
    document.getElementById('editPhoneMother').value = student.phone_mother || '';
    document.getElementById('editPhoneFather').value = student.phone_father || '';
    document.getElementById('editLocation').value = student.location || '';
    document.getElementById('editSettlementType').value = student.settlement_type || '';
    document.getElementById('editAddress').value = student.address || '';
    document.getElementById('editBenefitLowIncome').checked = student.benefit_low_income || false;
    document.getElementById('editBenefitLargeFamily').checked = student.benefit_large_family || false;
    document.getElementById('editBenefitMilitaryFamily').checked = student.benefit_military_family || false;
    document.getElementById('editBenefitInternallyDisplaced').checked = student.benefit_internally_displaced || false;
    document.getElementById('editBenefitOrphan').checked = student.benefit_orphan || false;
    document.getElementById('editBenefitDisability').checked = student.benefit_disability || false;
    document.getElementById('editBenefitSocialRisk').checked = student.benefit_social_risk || false;
    
    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞
async function updateStudent() {
    const studentId = parseInt(document.getElementById('editStudentId').value);
    const formData = {
        first_name: document.getElementById('editFirstName').value,
        last_name: document.getElementById('editLastName').value,
        birth_date: document.getElementById('editBirthDate').value || null,
        age: parseInt(document.getElementById('editAge').value) || null,
        grade: document.getElementById('editGrade').value || null,
        phone_child: document.getElementById('editPhoneChild').value || null,
        parent_name: document.getElementById('editParentName').value || null,
        phone_mother: document.getElementById('editPhoneMother').value || null,
        phone_father: document.getElementById('editPhoneFather').value || null,
        location: document.getElementById('editLocation').value || null,
        settlement_type: document.getElementById('editSettlementType').value || null,
        address: document.getElementById('editAddress').value || null,
        benefit_low_income: document.getElementById('editBenefitLowIncome').checked,
        benefit_large_family: document.getElementById('editBenefitLargeFamily').checked,
        benefit_military_family: document.getElementById('editBenefitMilitaryFamily').checked,
        benefit_internally_displaced: document.getElementById('editBenefitInternallyDisplaced').checked,
        benefit_orphan: document.getElementById('editBenefitOrphan').checked,
        benefit_disability: document.getElementById('editBenefitDisability').checked,
        benefit_social_risk: document.getElementById('editBenefitSocialRisk').checked
    };
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
    if (!formData.first_name || !formData.last_name) {
        showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è (–Ü–º\'—è —Ç–∞ –ü—Ä—ñ–∑–≤–∏—â–µ)', 'danger');
        return;
    }
    
    try {
        const response = await fetch(`/api/students/${studentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞');
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
        await loadAllStudentsData();
        bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
        showAlert('–°—Ç—É–¥–µ–Ω—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        
    } catch (error) {
        showAlert(error.message, 'danger');
    }
}

// –ü–µ—Ä–µ–≥–ª—è–¥ –¥–µ—Ç–∞–ª–µ–π —Å—Ç—É–¥–µ–Ω—Ç–∞
function viewStudent(id) {
    const student = allStudents.find(s => s.id === id);
    if (!student) {
        showAlert('–°—Ç—É–¥–µ–Ω—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'danger');
        return;
    }
    
    // –§–æ—Ä–º—É—î–º–æ HTML –∑ –¥–µ—Ç–∞–ª—è–º–∏
    const benefitsList = [];
    if (student.benefit_low_income) benefitsList.push('–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ');
    if (student.benefit_large_family) benefitsList.push('–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ');
    if (student.benefit_military_family) benefitsList.push('–°—ñ–º\'—è –ó–°–£');
    if (student.benefit_internally_displaced) benefitsList.push('–í–ü–û');
    if (student.benefit_orphan) benefitsList.push('–°–∏—Ä–æ—Ç–∞/–ø—ñ–¥ –æ–ø—ñ–∫–æ—é');
    if (student.benefit_disability) benefitsList.push('–î–∏—Ç–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é');
    if (student.benefit_social_risk) benefitsList.push('–°–ñ–û');
    
    const detailsHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>üë§ –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h6>
                <p><strong>–ü–Ü–ë:</strong> ${student.first_name} ${student.last_name}</p>
                <p><strong>–í—ñ–∫:</strong> ${student.age || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>–ö–ª–∞—Å:</strong> ${student.grade || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è:</strong> ${student.birth_date || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –¥–∏—Ç–∏–Ω–∏:</strong> ${student.phone_child || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
            </div>
            <div class="col-md-6">
                <h6>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ë–∞—Ç—å–∫–∏ —Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∏</h6>
                <p><strong>–ü–Ü–ë –±–∞—Ç—å–∫—ñ–≤:</strong> ${student.parent_name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Ç–µ—Ä—ñ:</strong> ${student.phone_mother || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –±–∞—Ç—å–∫–∞:</strong> ${student.phone_father || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <h6>üè† –ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</h6>
                <p><strong>–¢–∏–ø –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É:</strong> ${student.settlement_type || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>–ú—ñ—Å—Ü–µ:</strong> ${student.location || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>–ê–¥—Ä–µ—Å–∞:</strong> ${student.address || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
            </div>
            <div class="col-md-6">
                <h6>üè∑Ô∏è –ü—ñ–ª—å–≥–∏</h6>
                ${benefitsList.length > 0 ? 
                    benefitsList.map(b => `<span class="badge bg-primary me-1">${b}</span>`).join('') : 
                    '<span class="text-muted">–ë–µ–∑ –ø—ñ–ª—å–≥</span>'}
            </div>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—É—î–º–æ —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ (—Å—Ç–≤–æ—Ä—é—î–º–æ —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î)
    let modal = document.getElementById('viewStudentModal');
    if (!modal) {
        const modalHTML = `
            <div class="modal fade" id="viewStudentModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">–î–µ—Ç–∞–ª—ñ —Å—Ç—É–¥–µ–Ω—Ç–∞</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="studentDetailsBody">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('viewStudentModal');
    }
    
    document.getElementById('studentDetailsBody').innerHTML = detailsHTML;
    new bootstrap.Modal(modal).show();
}

// –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞
async function deleteStudent(id) {
    const student = allStudents.find(s => s.id === id);
    if (!student) {
        showAlert('–°—Ç—É–¥–µ–Ω—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'danger');
        return;
    }
    
    if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ "${student.first_name} ${student.last_name}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/students/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞');
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
        await loadAllStudentsData();
        showAlert('–°—Ç—É–¥–µ–Ω—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
        
    } catch (error) {
        showAlert(error.message, 'danger');
    }
}

// –ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
function exportStudentsData() {
    // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ –∑–∞–ø–∏—Å–∏ (–ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó)
    const currentStudents = getCurrentlyDisplayedStudents();
    exportStudentsToCSV(currentStudents, 'students_data');
}

function getCurrentlyDisplayedStudents() {
    // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ç—ñ —Å–∞–º—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ —â–æ —ñ –≤ filterStudents()
    const nameFilter = document.getElementById('filterName').value.toLowerCase();
    const ageGradeFilter = document.getElementById('filterAgeGrade').value.toLowerCase();
    const phoneFilter = document.getElementById('filterPhone').value.toLowerCase();
    const locationFilter = document.getElementById('filterLocation').value;
    const benefitFilter = document.getElementById('filterBenefit').value;
    
    let filtered = allStudents;
    
    if (nameFilter) {
        filtered = filtered.filter(s => `${s.first_name} ${s.last_name}`.toLowerCase().includes(nameFilter));
    }
    if (ageGradeFilter) {
        filtered = filtered.filter(s => (s.age || '').toString().includes(ageGradeFilter) || (s.grade || '').toLowerCase().includes(ageGradeFilter));
    }
    if (phoneFilter) {
        filtered = filtered.filter(s => [s.phone_child, s.phone_mother, s.phone_father].filter(Boolean).join(' ').toLowerCase().includes(phoneFilter));
    }
    if (locationFilter) {
        filtered = filtered.filter(s => s.settlement_type === locationFilter);
    }
    if (benefitFilter) {
        if (benefitFilter === 'no_benefits') {
            filtered = filtered.filter(s => !s.benefit_low_income && !s.benefit_large_family && !s.benefit_military_family && !s.benefit_internally_displaced && !s.benefit_orphan && !s.benefit_disability && !s.benefit_social_risk);
        } else {
            filtered = filtered.filter(s => s[benefitFilter] === true);
        }
    }
    
    return filtered;
}

function exportStudentsToCSV(students, filename) {
    if (students.length === 0) {
        showAlert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'warning');
        return;
    }
    
    const exportData = students.map(student => {
        const benefits = [];
        if (student.benefit_low_income) benefits.push('–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ');
        if (student.benefit_large_family) benefits.push('–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ');
        if (student.benefit_military_family) benefits.push('–°—ñ–º\'—è –ó–°–£');
        if (student.benefit_internally_displaced) benefits.push('–í–ü–û');
        if (student.benefit_orphan) benefits.push('–°–∏—Ä–æ—Ç–∞/–ø—ñ–¥ –æ–ø—ñ–∫–æ—é');
        if (student.benefit_disability) benefits.push('–î–∏—Ç–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é');
        if (student.benefit_social_risk) benefits.push('–°–ñ–û');
        
        return {
            '–Ü–º\'—è': student.first_name,
            '–ü—Ä—ñ–∑–≤–∏—â–µ': student.last_name,
            '–í—ñ–∫': student.age || '',
            '–ö–ª–∞—Å': student.grade || '',
            '–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è': student.birth_date || '',
            '–¢–µ–ª–µ—Ñ–æ–Ω –¥–∏—Ç–∏–Ω–∏': student.phone_child || '',
            '–ü–Ü–ë –±–∞—Ç—å–∫—ñ–≤': student.parent_name || '',
            '–¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Ç–µ—Ä—ñ': student.phone_mother || '',
            '–¢–µ–ª–µ—Ñ–æ–Ω –±–∞—Ç—å–∫–∞': student.phone_father || '',
            '–¢–∏–ø –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É': student.settlement_type || '',
            '–ú—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è': student.location || '',
            '–ê–¥—Ä–µ—Å–∞': student.address || '',
            '–ü—ñ–ª—å–≥–∏': benefits.join(', ') || '–ë–µ–∑ –ø—ñ–ª—å–≥'
        };
    });
    
    const csvContent = convertToCSV(exportData);
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert(`–ï–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${students.length} —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤`, 'success');
}

function convertToCSV(data) {
    if (data.length === 0) return '';
    const headers = Object.keys(data[0]);
    const csvRows = [headers.join(',')];
    
    data.forEach(row => {
        const values = headers.map(header => {
            const value = row[header];
            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
        });
        csvRows.push(values.join(','));
    });
    
    return csvRows.join('\n');
}

// –§—É–Ω–∫—Ü—ñ—ó –¥–æ–ø–æ–º—ñ–∂–Ω—ñ
function showAlert(message, type) {
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toastDiv = document.createElement('div');
    toastDiv.id = toastId;
    toastDiv.className = `toast align-items-center text-bg-${type} border-0`;
    toastDiv.role = 'alert';
    toastDiv.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toastDiv);
    
    const toast = new bootstrap.Toast(toastDiv, { autohide: true, delay: 5000 });
    toast.show();
    
    toastDiv.addEventListener('hidden.bs.toast', () => {
        toastDiv.remove();
    });
}

function showLoading(show = true) {
    let spinner = document.getElementById('loadingSpinner');
    if (!spinner && show) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></div>';
        spinner.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;';
        document.body.appendChild(spinner);
    }
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', () => {
    loadAllStudentsData();
});
</script>
{% endblock %}
