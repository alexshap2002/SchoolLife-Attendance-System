{% extends "base.html" %}

{% block content %}
<style>
/* –°—Ç–∏–ª—ñ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤ */
#conductedLessonsTable {
    margin-top: 20px;
}

/* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
#conductedLessonsTable th:nth-child(1), #conductedLessonsTable td:nth-child(1) { min-width: 120px; } /* –î–∞—Ç–∞ */
#conductedLessonsTable th:nth-child(2), #conductedLessonsTable td:nth-child(2) { min-width: 150px; } /* –í—á–∏—Ç–µ–ª—å */
#conductedLessonsTable th:nth-child(3), #conductedLessonsTable td:nth-child(3) { min-width: 120px; } /* –ì—É—Ä—Ç–æ–∫ */
#conductedLessonsTable th:nth-child(4), #conductedLessonsTable td:nth-child(4) { min-width: 100px; } /* –ü—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å */
#conductedLessonsTable th:nth-child(5), #conductedLessonsTable td:nth-child(5) { min-width: 80px; }  /* –í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å */
#conductedLessonsTable th:nth-child(6), #conductedLessonsTable td:nth-child(6) { min-width: 100px; } /* –ó–∞—Ä–ø–ª–∞—Ç–∞ */
#conductedLessonsTable th:nth-child(7), #conductedLessonsTable td:nth-child(7) { min-width: 200px; } /* –ü—Ä–∏–º—ñ—Ç–∫–∏ */
#conductedLessonsTable th:nth-child(8), #conductedLessonsTable td:nth-child(8) { min-width: 100px; } /* –î—ñ—ó */

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑ —è—Å–∫—Ä–∞–≤–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤ */
#conductedLessonsTable thead th {
    white-space: nowrap;
    padding: 12px 8px;
}

/* –§—ñ–ª—å—Ç—Ä–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ */
#conductedLessonsTable .filter-row td {
    padding: 8px 6px;
}

#conductedLessonsTable .filter-input,
#conductedLessonsTable .filter-select {
    font-size: 0.85rem;
    padding: 4px 8px;
    min-width: 90px;
}

/* –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ */
.attendance-progress {
    width: 100%;
    height: 20px;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.stats-card {
    margin-top: 20px;
}

/* –ë–µ–π–¥–∂—ñ —Å—Ç–∞—Ç—É—Å—É */
.salary-status {
    font-size: 0.8rem;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ */
.students-attendance-list {
    max-height: 300px;
    overflow-y: auto;
}

.student-attendance-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.student-attendance-item:hover {
    background-color: #e9ecef;
}

.student-info {
    flex-grow: 1;
    font-weight: 500;
}

.attendance-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.attendance-status-btn {
    min-width: 80px;
    font-size: 0.875rem;
    font-weight: 600;
}

.attendance-status-btn.present {
    background-color: #198754;
    border-color: #198754;
}

.attendance-status-btn.absent {
    background-color: #6c757d;
    border-color: #6c757d;
}

.remove-student-btn {
    color: #dc3545;
    border-color: #dc3545;
    font-size: 0.875rem;
}

.remove-student-btn:hover {
    background-color: #dc3545;
    color: white;
}

.attendance-stats-badge {
    background-color: #0d6efd;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}
</style>

<!-- –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –∑–∞–º—ñ—Å—Ç—å –ø–æ–¥–≤—ñ–π–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
<div class="mt-4 pt-3"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìö –ü—Ä–æ–≤–µ–¥–µ–Ω—ñ —É—Ä–æ–∫–∏</h2>
    <div class="btn-group">
        <button type="button" class="btn btn-success" onclick="openCreateLessonModal()">
            <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ —É—Ä–æ–∫
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="exportLessonsData()">
            <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç
        </button>
        <button type="button" class="btn btn-warning" onclick="showUncalculatedLessons()">
            <i class="bi bi-calculator"></i> –ë–µ–∑ –∑–∞—Ä–ø–ª–∞—Ç–∏
        </button>
    </div>
</div>

<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="conductedLessonsTable">
                <thead>
                    <tr>
                        <th colspan="2">–î–∞—Ç–∞ —É—Ä–æ–∫—É</th>
                        <th>–í—á–∏—Ç–µ–ª—å</th>
                        <th>–ì—É—Ä—Ç–æ–∫</th>
                        <th>–ü—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å</th>
                        <th>–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</th>
                        <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                        <th>–ü—Ä–∏–º—ñ—Ç–∫–∏</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                    <!-- –†—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
                    <tr class="filter-row">
                        <td>
                            <input type="date" class="form-control form-control-sm filter-input" id="filterDateFrom" 
                                   placeholder="–î–∞—Ç–∞ –∑" onchange="handleDateRangeChange()">
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm filter-input" id="filterDateTo" 
                                   placeholder="–î–∞—Ç–∞ –ø–æ" onchange="handleDateRangeChange()">
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterTeacher" onchange="filterLessons()">
                                <option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterClub" onchange="filterLessons()">
                                <option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm filter-input" id="filterMinPresent" 
                                   placeholder="–ú—ñ–Ω. –ø—Ä–∏—Å—É—Ç–Ω—ñ—Ö..." min="0" onkeyup="filterLessons()">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm filter-input" id="filterMinRate" 
                                   placeholder="–ú—ñ–Ω. %..." min="0" max="100" onkeyup="filterLessons()">
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterSalaryStatus" onchange="filterLessons()">
                                <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                                <option value="calculated">–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞</option>
                                <option value="not_calculated">–ù–µ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞</option>
                                <option value="valid">–í–∞–ª—ñ–¥–Ω–∞ –¥–ª—è –∑–∞—Ä–ø–ª–∞—Ç–∏</option>
                                <option value="invalid">–ù–µ –≤–∞–ª—ñ–¥–Ω–∞</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm filter-input" id="filterNotes" 
                                   placeholder="–ü–æ—à—É–∫ –≤ –ø—Ä–∏–º—ñ—Ç–∫–∞—Ö..." onkeyup="filterLessons()">
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetLessonFilters()" title="–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </td>
                    </tr>
                </thead>
                <tbody id="lessonsTableBody">
                    <!-- –î–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-card">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                </div>
                <div class="card-body" id="lessonsStats">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–ü–æ –≤—á–∏—Ç–µ–ª—è—Ö</h5>
                </div>
                <div class="card-body" id="teachersStats">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—á–∏—Ç–µ–ª—è—Ö –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–ü–æ –≥—É—Ä—Ç–∫–∞—Ö</h5>
                </div>
                <div class="card-body" id="clubsStats">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—É—Ä—Ç–∫–∞—Ö –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É -->
<div class="modal fade" id="createLessonModal" tabindex="-1" aria-labelledby="createLessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createLessonModalLabel">
                    <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–π —É—Ä–æ–∫
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    –¶—è —Ñ–æ—Ä–º–∞ –¥–æ–∑–≤–æ–ª—è—î –≤—Ä—É—á–Ω—É –¥–æ–¥–∞—Ç–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–π —É—Ä–æ–∫, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ —É—Ä–æ–∫ –≤—ñ–¥–±—É–≤—Å—è, –∞–ª–µ –Ω–µ –±—É–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –≤—ñ–¥–º—ñ—Ç–∫–∏ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.
                </div>
                
                <!-- –§–æ—Ä–º–∞ –≤–∏–±–æ—Ä—É —Ç–∏–ø—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è -->
                <div class="mb-4">
                    <div class="btn-group w-100" role="group" aria-label="–¢–∏–ø —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è">
                        <input type="radio" class="btn-check" name="createType" id="createTypeEvent" value="event" checked>
                        <label class="btn btn-outline-primary" for="createTypeEvent">–ó –≥–æ—Ç–æ–≤–æ–≥–æ —É—Ä–æ–∫—É</label>
                        
                        <input type="radio" class="btn-check" name="createType" id="createTypeManual" value="manual">
                        <label class="btn btn-outline-success" for="createTypeManual">–ù–æ–≤–∏–π –≤—Ä—É—á–Ω—É</label>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑ lesson_event -->
                <div id="eventForm" class="form-section">
                    <form id="createLessonEventForm">
                    <div class="mb-3">
                            <label for="createLessonEventId" class="form-label">–ì–æ—Ç–æ–≤–∏–π —É—Ä–æ–∫ (LessonEvent) *</label>
                        <select class="form-select" id="createLessonEventId" required>
                                <option value="">–û–±–µ—Ä—ñ—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π —É—Ä–æ–∫</option>
                        </select>
                            <div class="form-text">–û–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫ –∑ Telegram –±–æ—Ç–∞ –¥–ª—è —è–∫–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å</div>
                    </div>
                    <div class="mb-3">
                            <label for="createEventNotes" class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∏</label>
                            <textarea class="form-control" id="createEventNotes" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –ø—Ä–æ —É—Ä–æ–∫"></textarea>
                    </div>
                </form>
                </div>

                <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤—Ä—É—á–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è -->
                <div id="manualForm" class="form-section" style="display: none;">
                    <form id="createManualLessonForm">
                        <div class="row">
                            <!-- –ö–æ–ª–æ–Ω–∫–∞ –≤–∏–±–æ—Ä—É —Ä–æ–∑–∫–ª–∞–¥—É -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-calendar3"></i> –†–æ–∑–∫–ª–∞–¥ —Ç–∞ —á–∞—Å</h6>
                                    </div>
                                    <div class="card-body">
                    <div class="mb-3">
                                            <label for="createScheduleId" class="form-label">–†–æ–∑–∫–ª–∞–¥/–ì—É—Ä—Ç–æ–∫ *</label>
                                            <select class="form-select" id="createScheduleId" required onchange="loadScheduleStudents()">
                                                <option value="">–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥</option>
                                            </select>
                                            <div class="form-text">–í–∏–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥ (–≤—á–∏—Ç–µ–ª—å + –≥—É—Ä—Ç–æ–∫ + —á–∞—Å)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="createLessonDate" class="form-label">–î–∞—Ç–∞ —Ç–∞ —á–∞—Å —É—Ä–æ–∫—É *</label>
                                            <input type="datetime-local" class="form-control" id="createLessonDate" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="createDuration" class="form-label">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤–∏–ª–∏–Ω)</label>
                                            <input type="number" class="form-control" id="createDuration" min="5" max="300" placeholder="60">
                                            <div class="form-text">–ó–∞–ª–∏—à–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è</div>
                                        </div>
                                        
                                        
                                        <div class="mb-3">
                                            <label for="createManualNotes" class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∏</label>
                                            <textarea class="form-control" id="createManualNotes" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –ø—Ä–æ —É—Ä–æ–∫"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="createAutoPayroll" checked>
                                                <label class="form-check-label" for="createAutoPayroll">
                                                    <i class="bi bi-cash-coin text-success"></i> <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É</strong>
                                                </label>
                                                <div class="form-text">–Ø–∫—â–æ –≤—ñ–¥–º—ñ—á–µ–Ω–æ, –∑–∞—Ä–ø–ª–∞—Ç–∞ –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞ –≤—á–∏—Ç–µ–ª—é –∑–∞ —Ü–µ–π —É—Ä–æ–∫ (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –ø—Ä–∏—Å—É—Ç–Ω—ñ —Å—Ç—É–¥–µ–Ω—Ç–∏)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- –ö–æ–ª–æ–Ω–∫–∞ –≤–∏–±–æ—Ä—É —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="bi bi-people"></i> –ü—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h6>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-success" onclick="markAllPresent()">
                                                <i class="bi bi-check-all"></i> –í—Å—ñ –ø—Ä–∏—Å—É—Ç–Ω—ñ
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" onclick="markAllAbsent()">
                                                <i class="bi bi-x-circle"></i> –í—Å—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="studentsAttendanceList">
                                            <div class="text-muted text-center py-4">
                                                <i class="bi bi-arrow-left"></i> –°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥
                                            </div>
                                        </div>
                                        
                                        <div id="attendanceStats" class="mt-3" style="display: none;">
                                            <div class="alert alert-light">
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <div class="h5 mb-0 text-success" id="presentCount">0</div>
                                                        <small>–ü—Ä–∏—Å—É—Ç–Ω—ñ</small>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="h5 mb-0 text-danger" id="absentCount">0</div>
                                                        <small>–í—ñ–¥—Å—É—Ç–Ω—ñ</small>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="h5 mb-0 text-primary" id="totalCount">0</div>
                                                        <small>–í—Å—å–æ–≥–æ</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-success" onclick="saveNewLesson()">
                    <i class="bi bi-check-lg"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ —É—Ä–æ–∫
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –¥–µ—Ç–∞–ª–µ–π —É—Ä–æ–∫—É -->
<div class="modal fade" id="viewLessonModal" tabindex="-1" aria-labelledby="viewLessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewLessonModalLabel">
                    <i class="bi bi-eye"></i> –î–µ—Ç–∞–ª—ñ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ–≥–æ —É—Ä–æ–∫—É
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-info-circle"></i> –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless table-sm">
                                    <tr><th width="40%">–î–∞—Ç–∞ —É—Ä–æ–∫—É:</th><td id="viewLessonDate">-</td></tr>
                                    <tr><th>–í—á–∏—Ç–µ–ª—å:</th><td id="viewLessonTeacher">-</td></tr>
                                    <tr><th>–ì—É—Ä—Ç–æ–∫:</th><td id="viewLessonClub">-</td></tr>
                                    <tr><th>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</th><td id="viewLessonDuration">-</td></tr>
                                    <tr><th>–¢–µ–º–∞ —É—Ä–æ–∫—É:</th><td id="viewLessonTopic">-</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> –í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h4 class="text-primary mb-0" id="viewTotalStudents">0</h4>
                                        <small>–í—Å—å–æ–≥–æ —É—á–Ω—ñ–≤</small>
                                    </div>
                                    <div class="col-4">
                                        <h4 class="text-success mb-0" id="viewPresentStudents">0</h4>
                                        <small>–ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö</small>
                                    </div>
                                    <div class="col-4">
                                        <h4 class="text-danger mb-0" id="viewAbsentStudents">0</h4>
                                        <small>–í—ñ–¥—Å—É—Ç–Ω—ñ—Ö</small>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 25px;">
                                    <div class="progress-bar bg-success" role="progressbar" id="viewAttendanceBar" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –°–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤ -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-people"></i> –°–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <div id="viewStudentsList">
                                    <div class="text-center text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –ü—Ä–∏–º—ñ—Ç–∫–∏ -->
                <div class="row mt-3" id="viewNotesSection" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-journal-text"></i> –ü—Ä–∏–º—ñ—Ç–∫–∏</h6>
                            </div>
                            <div class="card-body">
                                <p id="viewLessonNotes" class="mb-0">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <button type="button" class="btn btn-warning" onclick="editLessonFromView()">
                    <i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É -->
<div class="modal fade" id="editLessonModal" tabindex="-1" aria-labelledby="editLessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editLessonModalLabel">
                    <i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–π —É—Ä–æ–∫
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editLessonForm">
                    <input type="hidden" id="editLessonId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLessonDate" class="form-label">–î–∞—Ç–∞ —É—Ä–æ–∫—É *</label>
                                <input type="datetime-local" class="form-control" id="editLessonDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLessonDuration" class="form-label">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤–∏–ª–∏–Ω) *</label>
                                <input type="number" class="form-control" id="editLessonDuration" min="15" max="300" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –°–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤ –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è -->
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-people"></i> –°–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤ —Ç–∞ —ó—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å
                                </label>
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—é</span>
                                        <div id="editAttendanceStats" class="small text-muted">
                                            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                                        </div>
                                    </div>
                                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                        <div id="editStudentsList" class="students-attendance-list">
                                            <div class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm me-2"></div>
                                                –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –°–∫—Ä–∏—Ç—ñ –ø–æ–ª—è –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ —ñ—Å–Ω—É—é—á–æ—é –ª–æ–≥—ñ–∫–æ—é -->
                    <input type="hidden" id="editTotalStudents">
                    <input type="hidden" id="editPresentStudents">
                    <input type="hidden" id="editAbsentStudents">
                    
                    <div class="mb-3">
                        <label for="editLessonTopicEdit" class="form-label">–¢–µ–º–∞ —É—Ä–æ–∫—É</label>
                        <input type="text" class="form-control" id="editLessonTopicEdit" placeholder="–¢–µ–º–∞ –∞–±–æ –æ–ø–∏—Å —É—Ä–æ–∫—É">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editLessonNotesEdit" class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∏</label>
                        <textarea class="form-control" id="editLessonNotesEdit" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –ø—Ä–æ —É—Ä–æ–∫"></textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editSalaryCalculated">
                        <label class="form-check-label" for="editSalaryCalculated">
                            –ó–∞—Ä–ø–ª–∞—Ç–∞ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-warning" onclick="saveEditedLesson()">
                    <i class="bi bi-check-lg"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
let allConductedLessons = [];
let allTeachers = [];
let allClubs = [];

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö
async function loadConductedLessons() {
    try {
        showLoading(true);
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        
        const dateFrom = weekAgo.toISOString().split('T')[0];
        const dateTo = today.toISOString().split('T')[0];
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –ø–æ–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
        document.getElementById('filterDateFrom').value = dateFrom;
        document.getElementById('filterDateTo').value = dateTo;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å
        const [lessonsResponse, teachersResponse, clubsResponse] = await Promise.all([
            fetch(`/api/conducted_lessons?start_date=${dateFrom}&end_date=${dateTo}`),
            fetch('/api/teachers'),
            fetch('/api/clubs')
        ]);
        
        if (!lessonsResponse.ok || !teachersResponse.ok || !clubsResponse.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
        }
        
        allConductedLessons = await lessonsResponse.json();
        allTeachers = await teachersResponse.json();
        allClubs = await clubsResponse.json();
        
        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏
        fillLessonFilters();
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ
        displayLessons(allConductedLessons);
        updateLessonsStats(allConductedLessons);
        
        showLoading(false);
    } catch (error) {
        showLoading(false);
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤', 'danger');
    }
}

// –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ –¥—ñ–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç - —Ä–æ–±–∏—Ç—å –Ω–æ–≤–∏–π API –∑–∞–ø–∏—Ç
async function handleDateRangeChange() {
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    
    if (!dateFrom || !dateTo) {
        console.log('‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –æ–±–∏–¥–≤—ñ –¥–∞—Ç–∏');
        return;
    }
    
    try {
        showLoading(true);
        
        console.log(`üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑–∞ –ø–µ—Ä—ñ–æ–¥: ${dateFrom} - ${dateTo}`);
        
        // –†–æ–±–∏–º–æ –Ω–æ–≤–∏–π API –∑–∞–ø–∏—Ç –∑ –Ω–æ–≤–∏–º –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º
        const lessonsResponse = await fetch(`/api/conducted_lessons?start_date=${dateFrom}&end_date=${dateTo}`);
        
        if (!lessonsResponse.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
        }
        
        allConductedLessons = await lessonsResponse.json();
        console.log(`‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${allConductedLessons.length} —É—Ä–æ–∫—ñ–≤`);
        
        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —ñ–Ω—à—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –ø–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ
        filterLessons();
        
        showLoading(false);
    } catch (error) {
        showLoading(false);
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: ' + error.message, 'danger');
    }
}

// –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function fillLessonFilters() {
    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—É –≤—á–∏—Ç–µ–ª—ñ–≤
    const filterTeacher = document.getElementById('filterTeacher');
    filterTeacher.innerHTML = '<option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>';
    
    allTeachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.full_name;
        filterTeacher.appendChild(option);
    });
    
    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—É –≥—É—Ä—Ç–∫—ñ–≤
    const filterClub = document.getElementById('filterClub');
    filterClub.innerHTML = '<option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>';
    
    allClubs.forEach(club => {
        const option = document.createElement('option');
        option.value = club.id;
        option.textContent = club.name;
        filterClub.appendChild(option);
    });
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É—Ä–æ–∫—ñ–≤
function displayLessons(lessons) {
    const tableBody = document.getElementById('lessonsTableBody');
    
    if (lessons.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted">
                    <i class="bi bi-book"></i><br>
                    –ü—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–¥–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏
                </td>
            </tr>`;
        return;
    }
    
    let bodyHTML = '';
    
    lessons.forEach(lesson => {
        // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏
        const lessonDate = new Date(lesson.lesson_date).toLocaleDateString('uk-UA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ
        const attendanceText = `${lesson.present_students}/${lesson.total_students}`;
        const attendanceRate = lesson.attendance_rate;
        
        // –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
        const progressClass = attendanceRate >= 80 ? 'bg-success' : 
                             attendanceRate >= 60 ? 'bg-warning' : 'bg-danger';
        const progressBar = `
            <div class="progress attendance-progress">
                <div class="progress-bar ${progressClass}" role="progressbar" 
                     style="width: ${attendanceRate}%" 
                     aria-valuenow="${attendanceRate}" aria-valuemin="0" aria-valuemax="100">
                    ${attendanceRate.toFixed(1)}%
                </div>
            </div>
        `;
        
        // –°—Ç–∞—Ç—É—Å –∑–∞—Ä–ø–ª–∞—Ç–∏
        let salaryStatus = '';
        if (lesson.is_salary_calculated) {
            salaryStatus = '<span class="badge bg-success salary-status">–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞</span>';
        } else if (lesson.is_valid_for_salary) {
            salaryStatus = '<span class="badge bg-warning salary-status">–û—á—ñ–∫—É—î</span>';
        } else {
            salaryStatus = '<span class="badge bg-secondary salary-status">–ù–µ –≤–∞–ª—ñ–¥–Ω–∞</span>';
        }
        
        // HTML –¥–ª—è —Ä—è–¥–∫–∞
        bodyHTML += `
            <tr>
                <td colspan="2"><small>${lessonDate}</small></td>
                <td><strong>${lesson.teacher_name}</strong></td>
                <td>${lesson.club_name}</td>
                <td>
                    <strong>${attendanceText}</strong><br>
                    <small class="text-muted">${lesson.total_students} –∑–∞–ø–∏—Å–∞–Ω–∏—Ö</small>
                </td>
                <td>${progressBar}</td>
                <td>${salaryStatus}</td>
                <td><small>${lesson.notes || '-'}</small></td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewLesson(${lesson.id})" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="editLesson(${lesson.id})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ${!lesson.is_salary_calculated && lesson.is_valid_for_salary ? 
                            `<button type="button" class="btn btn-sm btn-outline-success" onclick="markSalaryCalculated(${lesson.id})" title="–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É">
                                <i class="bi bi-check"></i>
                            </button>` : ''}
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteLesson(${lesson.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏ —É—Ä–æ–∫">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
    });
    
    tableBody.innerHTML = bodyHTML;
}

// –§—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—ñ–≤
function filterLessons() {
    const teacherFilter = parseInt(document.getElementById('filterTeacher').value);
    const clubFilter = parseInt(document.getElementById('filterClub').value);
    const minPresentFilter = parseInt(document.getElementById('filterMinPresent').value);
    const minRateFilter = parseFloat(document.getElementById('filterMinRate').value);
    const salaryStatusFilter = document.getElementById('filterSalaryStatus').value;
    const notesFilter = document.getElementById('filterNotes').value.toLowerCase();
    
    let filteredLessons = allConductedLessons;
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ —Ç–µ–ø–µ—Ä —á–µ—Ä–µ–∑ handleDateRangeChange() - –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ç—É—Ç
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≤—á–∏—Ç–µ–ª—é
    if (teacherFilter) {
        filteredLessons = filteredLessons.filter(lesson => lesson.teacher_id === teacherFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≥—É—Ä—Ç–∫—É
    if (clubFilter) {
        filteredLessons = filteredLessons.filter(lesson => lesson.club_id === clubFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ–π –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø—Ä–∏—Å—É—Ç–Ω—ñ—Ö
    if (!isNaN(minPresentFilter)) {
        filteredLessons = filteredLessons.filter(lesson => lesson.present_students >= minPresentFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–º—É –≤—ñ–¥—Å–æ—Ç–∫—É –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
    if (!isNaN(minRateFilter)) {
        filteredLessons = filteredLessons.filter(lesson => lesson.attendance_rate >= minRateFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –∑–∞—Ä–ø–ª–∞—Ç–∏
    if (salaryStatusFilter) {
        filteredLessons = filteredLessons.filter(lesson => {
            switch (salaryStatusFilter) {
                case 'calculated':
                    return lesson.is_salary_calculated;
                case 'not_calculated':
                    return !lesson.is_salary_calculated;
                case 'valid':
                    return lesson.is_valid_for_salary;
                case 'invalid':
                    return !lesson.is_valid_for_salary;
                default:
                    return true;
            }
        });
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –ø—Ä–∏–º—ñ—Ç–∫–∞—Ö
    if (notesFilter) {
        filteredLessons = filteredLessons.filter(lesson => {
            const notes = (lesson.notes || '').toLowerCase();
            const topic = (lesson.lesson_topic || '').toLowerCase();
            return notes.includes(notesFilter) || topic.includes(notesFilter);
        });
    }
    
    displayLessons(filteredLessons);
    updateLessonsStats(filteredLessons);
}

// –°–∫–∏–¥–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function resetLessonFilters() {
    document.getElementById('filterDate').value = '';
    document.getElementById('filterTeacher').value = '';
    document.getElementById('filterClub').value = '';
    document.getElementById('filterMinPresent').value = '';
    document.getElementById('filterMinRate').value = '';
    document.getElementById('filterSalaryStatus').value = '';
    document.getElementById('filterNotes').value = '';
    
    displayLessons(allConductedLessons);
    updateLessonsStats(allConductedLessons);
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateLessonsStats(lessons = allConductedLessons) {
    const total = lessons.length;
    const totalStudents = lessons.reduce((sum, lesson) => sum + lesson.total_students, 0);
    const presentStudents = lessons.reduce((sum, lesson) => sum + lesson.present_students, 0);
    const absentStudents = lessons.reduce((sum, lesson) => sum + lesson.absent_students, 0);
    const calculatedSalary = lessons.filter(l => l.is_salary_calculated).length;
    const validForSalary = lessons.filter(l => l.is_valid_for_salary).length;
    
    const avgAttendance = totalStudents > 0 ? ((presentStudents / totalStudents) * 100).toFixed(1) : 0;
    
    // –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    document.getElementById('lessonsStats').innerHTML = `
        <p><strong>–í—Å—å–æ–≥–æ —É—Ä–æ–∫—ñ–≤:</strong> ${total}</p>
        <p><strong>–°–µ—Ä–µ–¥–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å:</strong> ${avgAttendance}%</p>
        <p><strong>–ó–∞—Ä–ø–ª–∞—Ç–∞ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞:</strong> ${calculatedSalary}/${validForSalary}</p>
        <p><strong>–í—Å—å–æ–≥–æ –ø—Ä–∏—Å—É—Ç–Ω—ñ—Ö:</strong> ${presentStudents}</p>
    `;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—á–∏—Ç–µ–ª—è—Ö
    const teachersStats = {};
    lessons.forEach(lesson => {
        if (!teachersStats[lesson.teacher_name]) {
            teachersStats[lesson.teacher_name] = {
                lessons: 0,
                present: 0,
                total: 0
            };
        }
        teachersStats[lesson.teacher_name].lessons++;
        teachersStats[lesson.teacher_name].present += lesson.present_students;
        teachersStats[lesson.teacher_name].total += lesson.total_students;
    });
    
    let teachersHTML = '';
    for (const [teacherName, stats] of Object.entries(teachersStats)) {
        const rate = stats.total > 0 ? ((stats.present / stats.total) * 100).toFixed(1) : 0;
        teachersHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <strong>${teacherName}</strong><br>
                    <small>${stats.lessons} —É—Ä–æ–∫—ñ–≤</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary">${rate}%</span><br>
                    <small>${stats.present}/${stats.total}</small>
                </div>
            </div>
        `;
    }
    
    if (teachersHTML === '') {
        teachersHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</p>';
    }
    
    document.getElementById('teachersStats').innerHTML = teachersHTML;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—É—Ä—Ç–∫–∞—Ö
    const clubsStats = {};
    lessons.forEach(lesson => {
        if (!clubsStats[lesson.club_name]) {
            clubsStats[lesson.club_name] = {
                lessons: 0,
                present: 0,
                total: 0
            };
        }
        clubsStats[lesson.club_name].lessons++;
        clubsStats[lesson.club_name].present += lesson.present_students;
        clubsStats[lesson.club_name].total += lesson.total_students;
    });
    
    let clubsHTML = '';
    for (const [clubName, stats] of Object.entries(clubsStats)) {
        const rate = stats.total > 0 ? ((stats.present / stats.total) * 100).toFixed(1) : 0;
        clubsHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <strong>${clubName}</strong><br>
                    <small>${stats.lessons} —É—Ä–æ–∫—ñ–≤</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-info">${rate}%</span><br>
                    <small>${stats.present}/${stats.total}</small>
                </div>
            </div>
        `;
    }
    
    if (clubsHTML === '') {
        clubsHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</p>';
    }
    
    document.getElementById('clubsStats').innerHTML = clubsHTML;
}

// –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
let availableSchedules = [];
let scheduleStudents = [];

// –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É
async function openCreateLessonModal() {
    try {
        // –û—á–∏—â—É—î–º–æ —Ñ–æ—Ä–º–∏
        resetCreateForms();
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ä–æ–∑–∫–ª–∞–¥–∏ –¥–ª—è –≤—Ä—É—á–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
        await loadAvailableSchedules();
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ñ lesson events –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑ –≥–æ—Ç–æ–≤–æ–≥–æ
        await loadCompletedLessonEvents();
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('createLessonDate').value = localDateTime;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    new bootstrap.Modal(document.getElementById('createLessonModal')).show();
        
    } catch (error) {
        console.error('Error opening create lesson modal:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É', 'danger');
    }
}

// –°–∫–∏–¥–∞–Ω–Ω—è —Ñ–æ—Ä–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
function resetCreateForms() {
    // –°–∫–∏–¥—É—î–º–æ radio buttons
    document.getElementById('createTypeEvent').checked = true;
    document.getElementById('createTypeManual').checked = false;
    
    // –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É –∑ lesson event, –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Ä—É—á–Ω—É
    document.getElementById('eventForm').style.display = 'block';
    document.getElementById('manualForm').style.display = 'none';
    
    // –û—á–∏—â—É—î–º–æ –ø–æ–ª—è
    document.getElementById('createLessonEventForm').reset();
    document.getElementById('createManualLessonForm').reset();
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —á–µ–∫–±–æ–∫—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    document.getElementById('createAutoPayroll').checked = true;
    
    // –û—á–∏—â—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
    document.getElementById('studentsAttendanceList').innerHTML = '<div class="text-muted text-center py-4"><i class="bi bi-arrow-left"></i> –°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥</div>';
    document.getElementById('attendanceStats').style.display = 'none';
}

// –ü–æ–∫–∞–∑–∞—Ç–∏ —É—Ä–æ–∫–∏ –±–µ–∑ –∑–∞—Ä–ø–ª–∞—Ç–∏
function showUncalculatedLessons() {
    document.getElementById('filterSalaryStatus').value = 'not_calculated';
    filterLessons();
    showAlert('–ü–æ–∫–∞–∑–∞–Ω–æ —Ç—ñ–ª—å–∫–∏ —É—Ä–æ–∫–∏ –±–µ–∑ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ—ó –∑–∞—Ä–ø–ª–∞—Ç–∏', 'info');
}

// –ü–µ—Ä–µ–≥–ª—è–¥ –¥–µ—Ç–∞–ª–µ–π —É—Ä–æ–∫—É
async function viewLesson(id) {
    const lesson = allConductedLessons.find(l => l.id === id);
    if (!lesson) {
        showAlert('–£—Ä–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'danger');
        return;
    }
    
    try {
        // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
        document.getElementById('viewLessonDate').textContent = new Date(lesson.lesson_date).toLocaleString('uk-UA');
        document.getElementById('viewLessonTeacher').textContent = lesson.teacher_name || '–ù–µ–≤—ñ–¥–æ–º–æ';
        document.getElementById('viewLessonClub').textContent = lesson.club_name || '–ù–µ–≤—ñ–¥–æ–º–æ';
        document.getElementById('viewLessonDuration').textContent = lesson.lesson_duration_minutes ? `${lesson.lesson_duration_minutes} —Ö–≤` : '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
        document.getElementById('viewLessonTopic').textContent = lesson.lesson_topic || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
        document.getElementById('viewTotalStudents').textContent = lesson.total_students || 0;
        document.getElementById('viewPresentStudents').textContent = lesson.present_students || 0;
        document.getElementById('viewAbsentStudents').textContent = lesson.absent_students || 0;
        
        // –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä
        const attendancePercent = lesson.total_students > 0 ? Math.round((lesson.present_students / lesson.total_students) * 100) : 0;
        const progressBar = document.getElementById('viewAttendanceBar');
        progressBar.style.width = `${attendancePercent}%`;
        progressBar.textContent = `${attendancePercent}%`;
        
        // –ü—Ä–∏–º—ñ—Ç–∫–∏
        const notesSection = document.getElementById('viewNotesSection');
        const notesText = document.getElementById('viewLessonNotes');
        if (lesson.notes && lesson.notes.trim()) {
            notesText.textContent = lesson.notes;
            notesSection.style.display = 'block';
        } else {
            notesSection.style.display = 'none';
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —É—á–Ω—ñ–≤
        if (lesson.lesson_event_id) {
            loadStudentsForLesson(lesson.lesson_event_id);
        } else {
            document.getElementById('viewStudentsList').innerHTML = '<div class="text-muted text-center">–°–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π</div>';
        }
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        document.getElementById('viewLessonModal').setAttribute('data-lesson-id', id);
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        new bootstrap.Modal(document.getElementById('viewLessonModal')).show();
        
    } catch (error) {
        console.error('Error viewing lesson:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π —É—Ä–æ–∫—É', 'danger');
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —É—á–Ω—ñ–≤ –¥–ª—è —É—Ä–æ–∫—É
async function loadStudentsForLesson(lessonEventId) {
    try {
        document.getElementById('viewStudentsList').innerHTML = `
            <div class="text-center text-muted">
                <div class="spinner-border spinner-border-sm me-2"></div>
                –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤...
            </div>
        `;
        
        const response = await fetch(`/api/attendance?lesson_event_id=${lessonEventId}&limit=100`);
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ');
        
        const attendanceData = await response.json();
        
        if (attendanceData.length === 0) {
            document.getElementById('viewStudentsList').innerHTML = '<div class="text-muted text-center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</div>';
            return;
        }
        
        // –ì—Ä—É–ø—É—î–º–æ —É—á–Ω—ñ–≤ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º
        const presentStudents = attendanceData.filter(a => a.status === 'PRESENT');
        const absentStudents = attendanceData.filter(a => a.status === 'ABSENT');
        
        let studentsHtml = '';
        
        if (presentStudents.length > 0) {
            studentsHtml += '<h6 class="text-success mb-2"><i class="bi bi-check-circle"></i> –ü—Ä–∏—Å—É—Ç–Ω—ñ —É—á–Ω—ñ:</h6>';
            studentsHtml += '<ul class="list-unstyled mb-3">';
            presentStudents.forEach(student => {
                studentsHtml += `<li class="text-success"><i class="bi bi-person-check"></i> ${student.student.first_name} ${student.student.last_name}</li>`;
            });
            studentsHtml += '</ul>';
        }
        
        if (absentStudents.length > 0) {
            studentsHtml += '<h6 class="text-danger mb-2"><i class="bi bi-x-circle"></i> –í—ñ–¥—Å—É—Ç–Ω—ñ —É—á–Ω—ñ:</h6>';
            studentsHtml += '<ul class="list-unstyled">';
            absentStudents.forEach(student => {
                studentsHtml += `<li class="text-danger"><i class="bi bi-person-x"></i> ${student.student.first_name} ${student.student.last_name}</li>`;
            });
            studentsHtml += '</ul>';
        }
        
        document.getElementById('viewStudentsList').innerHTML = studentsHtml;
        
    } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('viewStudentsList').innerHTML = '<div class="text-danger text-center">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —É—á–Ω—ñ–≤</div>';
    }
}

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É
async function editLesson(id) {
    const lesson = allConductedLessons.find(l => l.id === id);
    if (!lesson) {
        showAlert('–£—Ä–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'danger');
        return;
    }
    
    try {
        // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        document.getElementById('editLessonId').value = lesson.id;
        
        // –î–∞—Ç–∞ —ñ —á–∞—Å
        if (lesson.lesson_date) {
            const lessonDate = new Date(lesson.lesson_date);
            const localISOTime = new Date(lessonDate.getTime() - lessonDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('editLessonDate').value = localISOTime;
        }
        
        // –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å
        document.getElementById('editLessonDuration').value = lesson.lesson_duration_minutes || 60;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤ –∑–∞–º—ñ—Å—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∏—Ö —Ü–∏—Ñ—Ä
        await loadStudentsForLessonEdit(lesson.id);
        
        // –¢–µ–º–∞ —ñ –ø—Ä–∏–º—ñ—Ç–∫–∏
        document.getElementById('editLessonTopicEdit').value = lesson.lesson_topic || '';
        document.getElementById('editLessonNotesEdit').value = lesson.notes || '';
        
        // –°—Ç–∞—Ç—É—Å –∑–∞—Ä–ø–ª–∞—Ç–∏
        document.getElementById('editSalaryCalculated').checked = lesson.is_salary_calculated || false;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        new bootstrap.Modal(document.getElementById('editLessonModal')).show();
        
    } catch (error) {
        console.error('Error editing lesson:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–æ—Ä–º–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è', 'danger');
    }
}

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É
function editLessonFromView() {
    const modal = document.getElementById('viewLessonModal');
    const lessonId = modal.getAttribute('data-lesson-id');
    
    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø–µ—Ä–µ–≥–ª—è–¥—É
    bootstrap.Modal.getInstance(modal).hide();
    
    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    setTimeout(() => editLesson(parseInt(lessonId)), 300);
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ–≥–æ —É—Ä–æ–∫—É
async function saveEditedLesson() {
    const lessonId = parseInt(document.getElementById('editLessonId').value);
    
    // –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö —Ñ–æ—Ä–º–∏
    const formData = {
        lesson_date: document.getElementById('editLessonDate').value,
        lesson_duration_minutes: parseInt(document.getElementById('editLessonDuration').value),
        total_students: parseInt(document.getElementById('editTotalStudents').value),
        present_students: parseInt(document.getElementById('editPresentStudents').value),
        absent_students: parseInt(document.getElementById('editAbsentStudents').value),
        lesson_topic: document.getElementById('editLessonTopicEdit').value || null,
        notes: document.getElementById('editLessonNotesEdit').value || null,
        is_salary_calculated: document.getElementById('editSalaryCalculated').checked
    };
    
    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
    if (!formData.lesson_date || !formData.lesson_duration_minutes || formData.total_students < 0 || formData.present_students < 0) {
        showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ', 'danger');
        return;
    }
    
    if (formData.present_students > formData.total_students) {
        showAlert('–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–∏—Å—É—Ç–Ω—ñ—Ö –Ω–µ –º–æ–∂–µ –ø–µ—Ä–µ–≤–∏—â—É–≤–∞—Ç–∏ –∑–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É—á–Ω—ñ–≤', 'danger');
        return;
    }
    
    try {
        const response = await fetch(`/api/conducted_lessons/${lessonId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω');
        }
        
        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        bootstrap.Modal.getInstance(document.getElementById('editLessonModal')).hide();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
        await loadConductedLessons();
        showAlert('–ó–º—ñ–Ω–∏ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ', 'success');
        
    } catch (error) {
        console.error('Error saving lesson:', error);
        showAlert(error.message, 'danger');
    }
}

// –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É —è–∫ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω—É
async function markSalaryCalculated(id) {
    if (!confirm('–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É –∑–∞ —Ü–µ–π —É—Ä–æ–∫ —è–∫ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω—É?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/conducted_lessons/${id}/mark_salary_calculated`, {
            method: 'PUT'
        });
        
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É');
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
        await loadConductedLessons();
        showAlert('–°—Ç–∞—Ç—É—Å –∑–∞—Ä–ø–ª–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        
    } catch (error) {
        showAlert(error.message, 'danger');
    }
}

// –ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö
function exportLessonsData() {
    try {
        // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É
        const exportData = allConductedLessons.map(lesson => ({
            '–î–∞—Ç–∞ —É—Ä–æ–∫—É': new Date(lesson.lesson_date).toLocaleString('uk-UA'),
            '–í—á–∏—Ç–µ–ª—å': lesson.teacher_name || '',
            '–ì—É—Ä—Ç–æ–∫': lesson.club_name || '',
            '–¢–µ–º–∞ —É—Ä–æ–∫—É': lesson.lesson_topic || '',
            '–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤)': lesson.lesson_duration_minutes || '',
            '–í—Å—å–æ–≥–æ —É—á–Ω—ñ–≤': lesson.total_students || 0,
            '–ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö': lesson.present_students || 0,
            '–í—ñ–¥—Å—É—Ç–Ω—ñ—Ö': lesson.absent_students || 0,
            '–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å (%)': lesson.total_students > 0 ? Math.round((lesson.present_students / lesson.total_students) * 100) : 0,
            '–ó–∞—Ä–ø–ª–∞—Ç–∞ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞': lesson.is_salary_calculated ? '–¢–∞–∫' : '–ù—ñ',
            '–ü—Ä–∏–º—ñ—Ç–∫–∏': lesson.notes || ''
        }));
        
        if (exportData.length === 0) {
            showAlert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'warning');
            return;
        }
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ Excel —Ñ–∞–π–ª –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é XLSX.js
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–æ–≤–µ–¥–µ–Ω—ñ —É—Ä–æ–∫–∏');
        
        // –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ —è–∫ .xlsx —Ñ–∞–π–ª
        XLSX.writeFile(wb, `conducted_lessons_${new Date().toISOString().split('T')[0]}.xlsx`);
        
        showAlert(`–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${exportData.length} –∑–∞–ø–∏—Å—ñ–≤ —É Excel —Ñ–∞–π–ª`, 'success');
        
    } catch (error) {
        console.error('Error exporting data:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É –¥–∞–Ω–∏—Ö', 'danger');
    }
}

// –§—É–Ω–∫—Ü—ñ—ó –¥–æ–ø–æ–º—ñ–∂–Ω—ñ
function showAlert(message, type) {
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toastDiv = document.createElement('div');
    toastDiv.id = toastId;
    toastDiv.className = `toast align-items-center text-bg-${type} border-0`;
    toastDiv.role = 'alert';
    toastDiv.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toastDiv);
    
    const toast = new bootstrap.Toast(toastDiv, { autohide: true, delay: 5000 });
    toast.show();
    
    toastDiv.addEventListener('hidden.bs.toast', () => {
        toastDiv.remove();
    });
}

function showLoading(show = true) {
    let spinner = document.getElementById('loadingSpinner');
    if (!spinner && show) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></div>';
        spinner.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;';
        document.body.appendChild(spinner);
    }
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

// –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è radio buttons
document.addEventListener('DOMContentLoaded', () => {
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
    loadConductedLessons();
    
    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ç–∏–ø—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
    document.querySelectorAll('input[name="createType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'event') {
                document.getElementById('eventForm').style.display = 'block';
                document.getElementById('manualForm').style.display = 'none';
            } else {
                document.getElementById('eventForm').style.display = 'none';
                document.getElementById('manualForm').style.display = 'block';
            }
        });
    });
});

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—ñ–≤
async function loadAvailableSchedules() {
    try {
        const response = await fetch('/api/conducted_lessons/available-schedules');
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—ñ–≤');
        
        availableSchedules = await response.json();
        
        const select = document.getElementById('createScheduleId');
        select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥</option>';
        
        availableSchedules.forEach(schedule => {
            const option = document.createElement('option');
            option.value = schedule.id;
            option.textContent = schedule.display_name;
            option.setAttribute('data-student-count', schedule.student_count);
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading schedules:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—ñ–≤', 'danger');
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö lesson events
async function loadCompletedLessonEvents() {
    try {
        // TODO: –î–æ–¥–∞—Ç–∏ API endpoint –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö lesson events
        // –ó–ê–ì–õ–£–®–ö–ê: –≤—ñ–¥–∫–ª—é—á–∞—î–º–æ lesson events –ø–æ–∫–∏ —â–æ
        console.log('üí° –ó–∞–≤–µ—Ä—à–µ–Ω—ñ lesson events —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ');
        
        const select = document.getElementById('createLessonEventId');
        select.innerHTML = '<option value="">–§—É–Ω–∫—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</option>';
        
    } catch (error) {
        console.error('Error loading lesson events:', error);
        // –ù–µ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ–π API –º–æ–∂–µ —â–µ –Ω–µ —ñ—Å–Ω—É–≤–∞—Ç–∏
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É
async function loadScheduleStudents() {
    const scheduleId = document.getElementById('createScheduleId').value;
    console.log('üîç loadScheduleStudents called with scheduleId:', scheduleId);
    
    if (!scheduleId) {
        document.getElementById('studentsAttendanceList').innerHTML = '<div class="text-muted text-center py-4"><i class="bi bi-arrow-left"></i> –°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥</div>';
        document.getElementById('attendanceStats').style.display = 'none';
        return;
    }
    
    try {
        showLoading(true);
        
        const url = `/api/conducted_lessons/schedule/${scheduleId}/students`;
        console.log('üì° Fetching students from:', url);
        
        const response = await fetch(url);
        console.log('üì® Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Response error:', errorText);
            throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤: ${response.status} ${errorText}`);
        }
        
        scheduleStudents = await response.json();
        console.log('üë• Loaded students:', scheduleStudents);
        
        if (scheduleStudents.length === 0) {
            document.getElementById('studentsAttendanceList').innerHTML = '<div class="text-muted text-center py-4">–£ —Ü—å–æ–º—É —Ä–æ–∑–∫–ª–∞–¥—ñ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å–∞–Ω–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</div>';
            document.getElementById('attendanceStats').style.display = 'none';
            return;
        }
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ —á–µ–∫–±–æ–∫—Å–∞–º–∏
        let studentsHTML = '';
        scheduleStudents.forEach((student, index) => {
            studentsHTML += `
                <div class="form-check d-flex justify-content-between align-items-center py-2 px-3 rounded mb-2" style="background-color: #f8f9fa;">
                    <div class="form-check">
                        <input class="form-check-input student-attendance" type="checkbox" 
                               id="student_${student.id}" value="${student.id}" 
                               data-student-name="${student.full_name}" checked
                               onchange="updateAttendanceStats()">
                        <label class="form-check-label" for="student_${student.id}">
                            <strong>${student.full_name}</strong>
                            ${student.phone_parent ? '<br><small class="text-muted">' + student.phone_parent + '</small>' : ''}
                        </label>
                    </div>
                    <div class="attendance-status">
                        <span class="badge bg-success">–ü—Ä–∏—Å—É—Ç–Ω—ñ–π</span>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('studentsAttendanceList').innerHTML = studentsHTML;
        document.getElementById('attendanceStats').style.display = 'block';
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateAttendanceStats();
        
    } catch (error) {
        console.error('‚ùå Error loading students:', error);
        document.getElementById('studentsAttendanceList').innerHTML = `<div class="text-danger text-center py-4">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤: ${error.message}</div>`;
        showAlert(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤: ${error.message}`, 'danger');
    } finally {
        showLoading(false);
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ
function updateAttendanceStats() {
    const checkboxes = document.querySelectorAll('.student-attendance');
    const total = checkboxes.length;
    const present = Array.from(checkboxes).filter(cb => cb.checked).length;
    const absent = total - present;
    
    document.getElementById('totalCount').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ badge'—ñ –±—ñ–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
    checkboxes.forEach(checkbox => {
        const statusElement = checkbox.closest('.form-check').parentElement.querySelector('.attendance-status span');
        if (checkbox.checked) {
            statusElement.textContent = '–ü—Ä–∏—Å—É—Ç–Ω—ñ–π';
            statusElement.className = 'badge bg-success';
        } else {
            statusElement.textContent = '–í—ñ–¥—Å—É—Ç–Ω—ñ–π';
            statusElement.className = 'badge bg-danger';
        }
    });
}

// –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤—Å—ñ—Ö —è–∫ –ø—Ä–∏—Å—É—Ç–Ω—ñ—Ö
function markAllPresent() {
    document.querySelectorAll('.student-attendance').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateAttendanceStats();
}

// –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤—Å—ñ—Ö —è–∫ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö
function markAllAbsent() {
    document.querySelectorAll('.student-attendance').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateAttendanceStats();
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫—É
async function saveNewLesson() {
    const createType = document.querySelector('input[name="createType"]:checked').value;
    
    try {
        showLoading(true);
        
        if (createType === 'event') {
            await saveNewLessonFromEvent();
        } else {
            await saveManualLesson();
        }
        
        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        bootstrap.Modal.getInstance(document.getElementById('createLessonModal')).hide();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
        await loadConductedLessons();
        showAlert('–£—Ä–æ–∫ —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ', 'success');
        
    } catch (error) {
        console.error('Error saving lesson:', error);
        showAlert(error.message, 'danger');
    } finally {
        showLoading(false);
    }
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É—Ä–æ–∫—É –∑ lesson event
async function saveNewLessonFromEvent() {
    const lessonEventId = document.getElementById('createLessonEventId').value;
    const notes = document.getElementById('createEventNotes').value;
    
    if (!lessonEventId) {
        throw new Error('–û–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É');
    }
    
    const response = await fetch('/api/conducted_lessons', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lesson_event_id: parseInt(lessonEventId),
            notes: notes || null
        })
    });
    
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.detail || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É');
    }
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—Ä—É—á–Ω–æ–≥–æ —É—Ä–æ–∫—É
async function saveManualLesson() {
    const scheduleId = document.getElementById('createScheduleId').value;
    const lessonDate = document.getElementById('createLessonDate').value;
    const duration = document.getElementById('createDuration').value;
    const notes = document.getElementById('createManualNotes').value;
    const autoPayroll = document.getElementById('createAutoPayroll').checked;
    
    if (!scheduleId) {
        throw new Error('–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥');
    }
    
    if (!lessonDate) {
        throw new Error('–í–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É —Ç–∞ —á–∞—Å —É—Ä–æ–∫—É');
    }
    
    // –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ –ø—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
    const attendanceData = [];
    document.querySelectorAll('.student-attendance').forEach(checkbox => {
        attendanceData.push({
            student_id: parseInt(checkbox.value),
            status: checkbox.checked ? 'present' : 'absent'
        });
    });
    
    if (attendanceData.length === 0) {
        throw new Error('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –¥–ª—è —É—Ä–æ–∫—É');
    }
    
    const response = await fetch('/api/conducted_lessons/manual', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            schedule_id: parseInt(scheduleId),
            lesson_date: new Date(lessonDate).toISOString(),
            student_attendance: attendanceData,
            notes: notes || null,
            lesson_duration_minutes: duration ? parseInt(duration) : null,
            auto_calculate_payroll: autoPayroll
        })
    });
    
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.detail || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—Ä—É—á–Ω–æ–≥–æ —É—Ä–æ–∫—É');
    }
}

// –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–≤–µ–¥–µ–Ω–æ–≥–æ —É—Ä–æ–∫—É
async function deleteLesson(lessonId) {
    try {
        // –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
        const warningResponse = await fetch(`/api/conducted_lessons/${lessonId}`, {
            method: 'DELETE'
        });
        
        if (!warningResponse.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —É—Ä–æ–∫');
        }
        
        const warningData = await warningResponse.json();
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–µ–∫—Ç–Ω–∞
        if (!warningData) {
            throw new Error('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
        if (warningData.error) {
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –∑ –¥–µ—Ç–∞–ª—å–Ω–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é
            const lesson = warningData.conducted_lesson || {};
            const deps = warningData.dependencies || {};
            
            const confirmMessage = `‚ö†Ô∏è –£–í–ê–ì–ê! –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–≤–µ–¥–µ–Ω–æ–≥–æ —É—Ä–æ–∫—É:\n\n` +
                `üìö –£—Ä–æ–∫: ${lesson.club_name || '–í–∏–¥–∞–ª–µ–Ω–∏–π –≥—É—Ä—Ç–æ–∫'}\n` +
                `üë®‚Äçüè´ –í—á–∏—Ç–µ–ª—å: ${lesson.teacher_name || 'N/A'}\n` +
                `üìÖ –î–∞—Ç–∞: ${lesson.lesson_date || 'N/A'}\n` +
                `üë• –ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö: ${lesson.present_students || 0}/${lesson.total_students || 0}\n\n` +
                `üóëÔ∏è –ë–£–î–ï –í–ò–î–ê–õ–ï–ù–û:\n` +
                `‚Ä¢ ${deps.attendance_records || 0} –∑–∞–ø–∏—Å—ñ–≤ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ\n` +
                `‚Ä¢ ${deps.payroll_records || 0} –∑–∞–ø–∏—Å—ñ–≤ –∑–∞—Ä–ø–ª–∞—Ç–∏\n\n` +
                `${warningData.warning || '‚ö†Ô∏è –í–∏–¥–∞–ª–µ–Ω–Ω—è —î –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∏–º!'}\n\n` +
                `–¶—è –¥—ñ—è —î –ù–ï–ó–í–û–†–û–¢–ù–û–Æ!\n\n` +
                `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —É—Ä–æ–∫?`;
            
            if (confirm(confirmMessage)) {
                // –í–∏–¥–∞–ª—è—î–º–æ –∑ force=true
                const deleteResponse = await fetch(`/api/conducted_lessons/${lessonId}?force=true`, {
                    method: 'DELETE'
                });
                
                if (!deleteResponse.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —É—Ä–æ–∫—É');
                }
                
                const deleteData = await deleteResponse.json();
                
                if (deleteData.success) {
                    showAlert(`‚úÖ ${deleteData.message}. –í–∏–¥–∞–ª–µ–Ω–æ: ${deleteData.deleted.attendance_records} –≤—ñ–¥–º—ñ—Ç–æ–∫, ${deleteData.deleted.payroll_records} –∑–∞—Ä–ø–ª–∞—Ç`, 'success');
                    await loadConductedLessons(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
                } else {
                    throw new Error('–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞');
                }
            }
        } else {
            // –£—Ä–æ–∫ –Ω–µ –º–∞—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π - –≤–∏–¥–∞–ª—è—î–º–æ –≤—ñ–¥—Ä–∞–∑—É
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —É—Ä–æ–∫?')) {
                showAlert('‚úÖ –£—Ä–æ–∫ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
                await loadConductedLessons();
            }
        }
        
    } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —É—Ä–æ–∫—É: ${error.message}`, 'danger');
    }
}

// === –ù–û–í–Ü –§–£–ù–ö–¶–Ü–á –î–õ–Ø –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –í–Ü–î–í–Ü–î–£–í–ê–ù–û–°–¢–Ü ===

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —É—á–Ω—ñ–≤ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É
async function loadStudentsForLessonEdit(lessonId) {
    const studentsList = document.getElementById('editStudentsList');
    const statsElement = document.getElementById('editAttendanceStats');
    
    try {
        // –ü–æ–∫–∞–∑—É—î–º–æ –ª–æ–∞–¥–µ—Ä
        studentsList.innerHTML = `
            <div class="text-center text-muted">
                <div class="spinner-border spinner-border-sm me-2"></div>
                –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤...
            </div>
        `;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —É—á–Ω—ñ–≤
        const response = await fetch(`/api/conducted_lessons/${lessonId}/students`);
        if (!response.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —É—á–Ω—ñ–≤');
        }
        
        const students = await response.json();
        
        if (students.length === 0) {
            studentsList.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-people"></i><br>
                    –£—á–Ω—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è —Ü—å–æ–≥–æ —É—Ä–æ–∫—É
                </div>
            `;
            return;
        }
        
        // –û–±—á–∏—Å–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const totalStudents = students.length;
        const presentStudents = students.filter(s => s.status === 'PRESENT').length;
        const absentStudents = totalStudents - presentStudents;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Å–∫—Ä–∏—Ç—ñ –ø–æ–ª—è –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
        document.getElementById('editTotalStudents').value = totalStudents;
        document.getElementById('editPresentStudents').value = presentStudents;
        document.getElementById('editAbsentStudents').value = absentStudents;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫—É
        statsElement.innerHTML = `
            <span class="attendance-stats-badge">
                ${presentStudents}/${totalStudents} –ø—Ä–∏—Å—É—Ç–Ω—ñ—Ö (${Math.round(presentStudents/totalStudents*100)}%)
            </span>
        `;
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤
        let studentsHTML = '';
        students.forEach(student => {
            const isPresent = student.status === 'PRESENT';
            studentsHTML += `
                <div class="student-attendance-item" data-student-id="${student.student_id}">
                    <div class="student-info">
                        <i class="bi bi-person"></i> ${student.full_name}
                    </div>
                    <div class="attendance-controls">
                        <button type="button" 
                                class="btn btn-sm attendance-status-btn ${isPresent ? 'present btn-success' : 'absent btn-secondary'}"
                                onclick="toggleStudentAttendance(${lessonId}, ${student.student_id}, '${isPresent ? 'ABSENT' : 'PRESENT'}')">
                            ${isPresent ? 'PRESENT' : 'ABSENT'}
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger remove-student-btn"
                                onclick="removeStudentFromLesson(${lessonId}, ${student.student_id}, '${student.full_name}')"
                                title="–í–∏–¥–∞–ª–∏—Ç–∏ —É—á–Ω—è –∑ —É—Ä–æ–∫—É">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        studentsList.innerHTML = studentsHTML;
        
    } catch (error) {
        console.error('Error loading students:', error);
        studentsList.innerHTML = `
            <div class="text-center text-danger">
                <i class="bi bi-exclamation-triangle"></i><br>
                –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}
            </div>
        `;
    }
}

// –ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ —É—á–Ω—è
async function toggleStudentAttendance(lessonId, studentId, newStatus) {
    try {
        const response = await fetch(`/api/conducted_lessons/${lessonId}/students/${studentId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É');
        }
        
        const result = await response.json();
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤
        await loadStudentsForLessonEdit(lessonId);
        
        showAlert(`‚úÖ ${result.message}`, 'success');
        
    } catch (error) {
        console.error('Error toggling attendance:', error);
        showAlert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'danger');
    }
}

// –í–∏–¥–∞–ª–µ–Ω–Ω—è —É—á–Ω—è –∑ —É—Ä–æ–∫—É
async function removeStudentFromLesson(lessonId, studentId, studentName) {
    if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ "${studentName}" –∑ —Ü—å–æ–≥–æ —É—Ä–æ–∫—É?\n\n–£–í–ê–ì–ê: –¶–µ —Ç–∞–∫–æ–∂ –≤–∏–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –¥–ª—è —Ü—å–æ–≥–æ —É—á–Ω—è.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/conducted_lessons/${lessonId}/students/${studentId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —É—á–Ω—è');
        }
        
        const result = await response.json();
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —É—á–Ω—ñ–≤
        await loadStudentsForLessonEdit(lessonId);
        
        showAlert(`‚úÖ ${result.message}`, 'success');
        
    } catch (error) {
        console.error('Error removing student:', error);
        showAlert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'danger');
    }
}

</script>
{% endblock %}
