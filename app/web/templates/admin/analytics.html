{% extends "base.html" %}

{% block content %}
<style>
/* –°—Ç–∏–ª—ñ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –≤ —Å—Ç–∏–ª—ñ —Ç–∞–±–ª–∏—Ü—å –≤—á–∏—Ç–µ–ª—ñ–≤/—É—á–Ω—ñ–≤ */
.analytics-table {
    margin-top: 20px;
}

/* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
.analytics-table th:nth-child(1), .analytics-table td:nth-child(1) { min-width: 120px; } /* –ü—Ä—ñ–∑–≤–∏—â–µ */
.analytics-table th:nth-child(2), .analytics-table td:nth-child(2) { min-width: 100px; } /* –Ü–º'—è */
.analytics-table th:nth-child(3), .analytics-table td:nth-child(3) { min-width: 100px; } /* –î.–ù. */
.analytics-table th:nth-child(4), .analytics-table td:nth-child(4) { min-width: 80px; } /* –ö–ª–∞—Å */
.analytics-table th:nth-child(5), .analytics-table td:nth-child(5) { min-width: 120px; } /* –¢–µ–ª.–±–∞—Ç—å–∫–∞ */
.analytics-table th:nth-child(6), .analytics-table td:nth-child(6) { min-width: 120px; } /* –¢–µ–ª.–º–∞—Ç–µ—Ä—ñ */
.analytics-table th:nth-child(7), .analytics-table td:nth-child(7) { min-width: 120px; } /* –¢–µ–ª.–¥–∏—Ç–∏–Ω–∏ */

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑ —è—Å–∫—Ä–∞–≤–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤ */
.analytics-table thead th {
    white-space: nowrap;
    padding: 12px 8px;
}

/* –§—ñ–ª—å—Ç—Ä–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ */
.analytics-table .filter-row td {
    padding: 8px 6px;
}

.analytics-table .filter-input,
.analytics-table .filter-select {
    font-size: 0.85rem;
    padding: 4px 8px;
    min-width: 90px;
}

/* –î–∞—Ç–∏ —É—Ä–æ–∫—ñ–≤ - —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è */
.analytics-table .lesson-date {
    text-align: center;
    font-size: 1.2rem;
    min-width: 80px;
}

/* STICKY COLUMNS - –§—ñ–∫—Å–æ–≤–∞–Ω—ñ —Å—Ç–æ–≤–ø—Ü—ñ "–ü—Ä—ñ–∑–≤–∏—â–µ" —Ç–∞ "–Ü–º'—è" —è–∫ –≤ —Ç–∞–±–ª–∏—Ü—ñ —É—á–Ω—ñ–≤ */
.table-responsive {
    position: relative;
}

/* –§—ñ–∫—Å–∞—Ü—ñ—è –ø–µ—Ä—à–æ–≥–æ —Å—Ç–æ–≤–ø—Ü—è (–ü—Ä—ñ–∑–≤–∏—â–µ) */
.analytics-table th:nth-child(1), 
.analytics-table td:nth-child(1) { 
    position: sticky;
    left: 0;
    z-index: 10;
    background-color: #ffffff;
    width: 120px;
    min-width: 120px;
    max-width: 120px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1); /* —Ç—ñ–Ω—å —Å–ø—Ä–∞–≤–∞ */
    border-right: 1px solid #dee2e6; /* –ª–µ–≥–∫–∞ –º–µ–∂–∞ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 8px 6px;
    font-weight: 500; /* —Ç—Ä–æ—Ö–∏ –∂–∏—Ä–Ω—ñ—à–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∏–¥–∏–º–æ—Å—Ç—ñ */
}

/* –§—ñ–∫—Å–∞—Ü—ñ—è –¥—Ä—É–≥–æ–≥–æ —Å—Ç–æ–≤–ø—Ü—è (–Ü–º'—è) */
.analytics-table th:nth-child(2), 
.analytics-table td:nth-child(2) { 
    position: sticky;
    left: 120px; /* –∑–º—ñ—â–µ–Ω–Ω—è –Ω–∞ —à–∏—Ä–∏–Ω—É –ø–µ—Ä—à–æ–≥–æ —Å—Ç–æ–≤–ø—Ü—è */
    z-index: 10;
    background-color: #ffffff;
    width: 100px;
    min-width: 100px;
    max-width: 100px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1); /* —Ç—ñ–Ω—å —Å–ø—Ä–∞–≤–∞ */
    border-right: 2px solid #007bff; /* —Å–∏–Ω—è –º–µ–∂–∞ –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∏–¥–∏–º–æ—Å—Ç—ñ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 8px 6px;
    font-weight: 500;
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ sticky —Å—Ç–æ–≤–ø—Ü—ñ–≤ –º–∞—é—Ç—å –≤–∏—â–∏–π z-index */
.analytics-table thead th:nth-child(1),
.analytics-table thead th:nth-child(2) {
    z-index: 11;
    background-color: #f8f9fa; /* —Ç—Ä–æ—Ö–∏ —Å—ñ—Ä–∏–π —Ñ–æ–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ */
}

/* –§—ñ–ª—å—Ç—Ä–∏ –≤ sticky —Å—Ç–æ–≤–ø—Ü—è—Ö */
.analytics-table .filter-row td:nth-child(1),
.analytics-table .filter-row td:nth-child(2) {
    background-color: #f8f9fa;
    z-index: 10;
}

/* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è sticky —Å—Ç–æ–≤–ø—Ü—ñ–≤ */
.analytics-table tbody tr:hover td:nth-child(1),
.analytics-table tbody tr:hover td:nth-child(2) {
    background-color: #f1f3f4 !important; /* —Å–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π –ø—Ä–∏ hover */
}

/* –í—ñ–∑—É–∞–ª—å–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —â–æ —Å—Ç–æ–≤–ø—Ü—ñ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ */
.analytics-table th:nth-child(1):after {
    content: " üìå";
    font-size: 0.8em;
    opacity: 0.6;
}

.analytics-table th:nth-child(2):after {
    content: " üìå";
    font-size: 0.8em;
    opacity: 0.6;
}

/* –†–µ–≥—É–ª—è—Ä–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏ (–Ω–µ sticky) */
.analytics-table th:nth-child(3), .analytics-table td:nth-child(3) { min-width: 100px; } /* –î.–ù. */
.analytics-table th:nth-child(4), .analytics-table td:nth-child(4) { min-width: 80px; } /* –ö–ª–∞—Å */
.analytics-table th:nth-child(5), .analytics-table td:nth-child(5) { min-width: 120px; } /* –¢–µ–ª.–±–∞—Ç—å–∫–∞ */
.analytics-table th:nth-child(6), .analytics-table td:nth-child(6) { min-width: 120px; } /* –¢–µ–ª.–º–∞—Ç–µ—Ä—ñ */
.analytics-table th:nth-child(7), .analytics-table td:nth-child(7) { min-width: 120px; } /* –¢–µ–ª.–¥–∏—Ç–∏–Ω–∏ */
</style>

<!-- –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –∑–∞–º—ñ—Å—Ç—å –ø–æ–¥–≤—ñ–π–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
<div class="mt-4 pt-3"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="exportAnalyticsData()" id="exportBtn" disabled>
            <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç Excel
        </button>
        <button class="btn btn-info" onclick="showAnalyticsHelp()">
            <i class="bi bi-question-circle"></i> –î–æ–≤—ñ–¥–∫–∞
        </button>
    </div>
</div>

<!-- –°–µ–ª–µ–∫—Ç–æ—Ä –≥—É—Ä—Ç–∫–∞ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label for="clubFilter" class="form-label">–û–±–µ—Ä—ñ—Ç—å –≥—É—Ä—Ç–æ–∫ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É:</label>
                <select class="form-select" id="clubFilter" onchange="loadAnalyticsData()">
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≥—É—Ä—Ç–æ–∫ --</option>
                    {% for club in clubs %}
                    <option value="{{ club.id }}">{{ club.name }} ({{ club.location }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <div class="text-muted" id="analyticsStats"></div>
            </div>
            <div class="col-md-4 d-flex align-items-end justify-content-end">
                <button class="btn btn-primary" onclick="loadAnalyticsData()" id="loadBtn" disabled>
                    <i class="bi bi-table"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ (–ø–æ –æ–¥–Ω—ñ–π –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É) -->
<div id="analyticsCard" style="display: none;">
    <div id="analyticsTablesContainer">
        <!-- –¢–∞–±–ª–∏—Ü—ñ –±—É–¥—É—Ç—å –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É -->
    </div>
</div>

<!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
<div class="card text-center py-5" id="placeholder">
    <div class="card-body">
        <i class="bi bi-table text-muted" style="font-size: 3rem;"></i>
        <h5 class="text-muted mt-3">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –ø–æ —Ä–æ–∑–∫–ª–∞–¥–∞—Ö</h5>
        <p class="text-muted">
            –û–±–µ—Ä—ñ—Ç—å –≥—É—Ä—Ç–æ–∫ —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ.<br>
            <strong>–ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞:</strong> –ö–æ–∂–µ–Ω –∞–∫—Ç–∏–≤–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –≥—É—Ä—Ç–∫–∞ –æ—Ç—Ä–∏–º–∞—î –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é<br>
            (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫ 17:00" —ñ "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫ 18:00" - –æ–∫—Ä–µ–º—ñ —Ç–∞–±–ª–∏—Ü—ñ).
        </p>
    </div>
</div>

<!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
<div class="text-center py-5" id="loadingIndicator" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
    </div>
    <p class="text-muted mt-3">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö...</p>
</div>

{% endblock %}

{% block scripts %}
<script>
let analyticsData = null;

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const clubFilter = document.getElementById('clubFilter');
    const loadBtn = document.getElementById('loadBtn');
    clubFilter.addEventListener('change', function() {
        loadBtn.disabled = !this.value;
    });
});

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö
async function loadAnalyticsData() {
    const clubId = document.getElementById('clubFilter').value;
    if (!clubId) {
        showAlert('–û–±–µ—Ä—ñ—Ç—å –≥—É—Ä—Ç–æ–∫ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö', 'warning');
        return;
    }

    try {
        showLoading(true);
        hideElements(['placeholder', 'analyticsCard']);
        
        const response = await fetch(`/api/analytics/club/${clubId}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        analyticsData = await response.json();
        showLoading(false);
        
        console.log('üìä [ANALYTICS] –û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ:', analyticsData);
        
        if (!analyticsData.schedules || analyticsData.schedules.length === 0) {
            showAlert('–î–ª—è —Ü—å–æ–≥–æ –≥—É—Ä—Ç–∫–∞ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—ñ–≤ –∑ —É—á–Ω—è–º–∏', 'info');
            return;
        }
        
        renderAnalyticsTable();
        
    } catch (error) {
        showLoading(false);
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö: ' + error.message, 'danger');
    }
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
function renderAnalyticsTable() {
    buildAnalyticsTables();
    showElements(['analyticsCard']);
    updateAnalyticsStats();
    document.getElementById('exportBtn').disabled = false;
}

// –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞–±–ª–∏—Ü—å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ (–æ–∫—Ä–µ–º–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É)
function buildAnalyticsTables() {
    const container = document.getElementById('analyticsTablesContainer');
    if (!container) {
        console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π');
        return;
    }
    
    container.innerHTML = ''; // –û—á–∏—â—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    
    if (!analyticsData.schedules || analyticsData.schedules.length === 0) {
        container.innerHTML = '<div class="alert alert-info">–ù–µ–º–∞—î —Ä–æ–∑–∫–ª–∞–¥—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</div>';
        return;
    }
    
    // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É
    analyticsData.schedules.forEach((schedule, scheduleIndex) => {
        const scheduleCard = document.createElement('div');
        scheduleCard.className = 'card shadow mb-4';
        scheduleCard.id = `scheduleCard_${scheduleIndex}`;
        
        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header bg-primary text-white';
        cardHeader.innerHTML = `
            <h5 class="mb-0">
                <i class="bi bi-calendar3"></i> 
                ${schedule.schedule_name} 
                ${schedule.teacher ? `(${schedule.teacher.name})` : ''}
                <span class="badge bg-light text-dark ms-2">${schedule.group_name}</span>
            </h5>
            <small>–£—á–Ω—ñ–≤: ${schedule.students.length} | –ü—Ä–æ–≤–µ–¥–µ–Ω–æ —É—Ä–æ–∫—ñ–≤: ${schedule.lesson_dates.length}</small>
        `;
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        
        if (schedule.students.length === 0) {
            cardBody.innerHTML = '<div class="alert alert-warning">–ù–∞ —Ü–µ–π —Ä–æ–∑–∫–ª–∞–¥ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å–∞–Ω–∏—Ö —É—á–Ω—ñ–≤</div>';
        } else if (schedule.lesson_dates.length === 0) {
            cardBody.innerHTML = '<div class="alert alert-info">–î–ª—è —Ü—å–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É —â–µ –Ω–µ–º–∞—î –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤</div>';
        } else {
            const tableResponsive = document.createElement('div');
            tableResponsive.className = 'table-responsive';
            
            const table = document.createElement('table');
            table.className = 'table table-hover table-sm analytics-table';
            table.id = `analyticsTable_${scheduleIndex}`;
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ
            const thead = document.createElement('thead');
            thead.innerHTML = buildTableHeader(schedule, scheduleIndex);
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç—ñ–ª–æ —Ç–∞–±–ª–∏—Ü—ñ
            const tbody = document.createElement('tbody');
            tbody.id = `analyticsTableBody_${scheduleIndex}`;
            tbody.innerHTML = buildTableBody(schedule, scheduleIndex);
            
            table.appendChild(thead);
            table.appendChild(tbody);
            tableResponsive.appendChild(table);
            cardBody.appendChild(tableResponsive);
        }
        
        scheduleCard.appendChild(cardHeader);
        scheduleCard.appendChild(cardBody);
        container.appendChild(scheduleCard);
    });
}

// –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É
function buildTableHeader(schedule, scheduleIndex) {
    let headerHTML = `
        <tr class="table-dark">
            <th>–ü—Ä—ñ–∑–≤–∏—â–µ</th>
            <th>–Ü–º'—è</th>
            <th>–î.–ù.</th>
            <th>–ö–ª–∞—Å</th>
            <th>–¢–µ–ª. –±–∞—Ç—å–∫–∞</th>
            <th>–¢–µ–ª. –º–∞—Ç–µ—Ä—ñ</th>
            <th>–¢–µ–ª. –¥–∏—Ç–∏–Ω–∏</th>`;
    
    // –î–æ–¥–∞—î–º–æ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –¥–∞—Ç —É—Ä–æ–∫—ñ–≤
    schedule.lesson_dates.forEach(date => {
        headerHTML += `<th class="text-center lesson-date" title="–£—Ä–æ–∫ –≤—ñ–¥ ${date}">${date}</th>`;
    });
    
    headerHTML += `</tr>`;
    
    // –î–æ–¥–∞—î–º–æ —Ä—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    headerHTML += `
        <tr class="filter-row bg-light">
            <td>
                <input type="text" class="form-control form-control-sm filter-input" 
                       id="filterLastName_${scheduleIndex}" 
                       placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ" 
                       onkeyup="filterScheduleData(${scheduleIndex})">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm filter-input" 
                       id="filterFirstName_${scheduleIndex}" 
                       placeholder="–Ü–º'—è" 
                       onkeyup="filterScheduleData(${scheduleIndex})">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm filter-input" 
                       id="filterBirthDate_${scheduleIndex}" 
                       placeholder="–î.–ù." 
                       onkeyup="filterScheduleData(${scheduleIndex})">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm filter-input" 
                       id="filterClass_${scheduleIndex}" 
                       placeholder="–ö–ª–∞—Å" 
                       onkeyup="filterScheduleData(${scheduleIndex})">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm filter-input" 
                       id="filterPhoneFather_${scheduleIndex}" 
                       placeholder="–¢–µ–ª. –±–∞—Ç—å–∫–∞" 
                       onkeyup="filterScheduleData(${scheduleIndex})">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm filter-input" 
                       id="filterPhoneMother_${scheduleIndex}" 
                       placeholder="–¢–µ–ª. –º–∞—Ç–µ—Ä—ñ" 
                       onkeyup="filterScheduleData(${scheduleIndex})">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm filter-input" 
                       id="filterPhoneChild_${scheduleIndex}" 
                       placeholder="–¢–µ–ª. –¥–∏—Ç–∏–Ω–∏" 
                       onkeyup="filterScheduleData(${scheduleIndex})">
            </td>`;
    
    // –î–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –¥–ª—è –¥–∞—Ç —É—Ä–æ–∫—ñ–≤
    schedule.lesson_dates.forEach((date, dateIndex) => {
        headerHTML += `
            <td class="text-center">
                <select class="form-select form-select-sm filter-select" 
                        id="filterLesson_${scheduleIndex}_${dateIndex}" 
                        onchange="filterScheduleData(${scheduleIndex})">
                    <option value="">–í—Å—ñ</option>
                    <option value="present">‚úÖ –ü—Ä–∏—Å—É—Ç–Ω—ñ</option>
                    <option value="absent">‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ</option>
                    <option value="no_mark">‚ö™ –ë–µ–∑ –≤—ñ–¥–º—ñ—Ç–∫–∏</option>
                </select>
            </td>`;
    });
    
    headerHTML += `</tr>`;
    
    return headerHTML;
}

// –°—Ç–≤–æ—Ä—é—î–º–æ —Ç—ñ–ª–æ —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É  
function buildTableBody(schedule, scheduleIndex) {
    let bodyHTML = '';
    
    schedule.students.forEach(student => {
        bodyHTML += `
            <tr id="studentRow_${scheduleIndex}_${student.id}">
                <td title="${student.last_name}">${student.last_name}</td>
                <td title="${student.first_name}">${student.first_name}</td>
                <td>${student.birth_date}</td>
                <td>${student.school_class}</td>
                <td>${student.phone_father || '‚Äî'}</td>
                <td>${student.phone_mother || '‚Äî'}</td>
                <td>${student.phone_child || '‚Äî'}</td>`;
        
        // –î–æ–¥–∞—î–º–æ –≤—ñ–¥–º—ñ—Ç–∫–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
        student.attendance.forEach(attendance => {
            let icon, bgColor, title;
            
            if (attendance.status === 'PRESENT') {
                icon = '‚úÖ';
                bgColor = '#d4edda';
                title = `${student.first_name} –±—É–≤ –ø—Ä–∏—Å—É—Ç–Ω—ñ–π ${attendance.date}`;
            } else if (attendance.status === 'ABSENT') {
                icon = '‚ùå';
                bgColor = '#f8d7da';
                title = `${student.first_name} –±—É–≤ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π ${attendance.date}`;
            } else {
                icon = '‚ö™';
                bgColor = '#f8f9fa';
                title = `–í—ñ–¥–º—ñ—Ç–∫–∏ –¥–ª—è ${student.first_name} –Ω–∞ ${attendance.date} –Ω–µ–º–∞—î`;
            }
            
            bodyHTML += `
                <td class="text-center lesson-date" 
                    style="background-color: ${bgColor}; cursor: pointer;" 
                    title="${title}"
                    onclick="toggleAttendanceFromAnalytics(${student.id}, ${attendance.lesson_event_id})">
                    ${icon}
                </td>`;
        });
        
        bodyHTML += `</tr>`;
    });
    
    return bodyHTML;
}

// –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É
function filterScheduleData(scheduleIndex) {
    const schedule = analyticsData.schedules[scheduleIndex];
    if (!schedule) return;
    
    // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    const filters = {
        lastName: document.getElementById(`filterLastName_${scheduleIndex}`)?.value.toLowerCase() || '',
        firstName: document.getElementById(`filterFirstName_${scheduleIndex}`)?.value.toLowerCase() || '',
        birthDate: document.getElementById(`filterBirthDate_${scheduleIndex}`)?.value.toLowerCase() || '',
        schoolClass: document.getElementById(`filterClass_${scheduleIndex}`)?.value.toLowerCase() || '',
        phoneFather: document.getElementById(`filterPhoneFather_${scheduleIndex}`)?.value.toLowerCase() || '',
        phoneMother: document.getElementById(`filterPhoneMother_${scheduleIndex}`)?.value.toLowerCase() || '',
        phoneChild: document.getElementById(`filterPhoneChild_${scheduleIndex}`)?.value.toLowerCase() || ''
    };
    
    // –û—Ç—Ä–∏–º—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –¥–ª—è –¥–∞—Ç —É—Ä–æ–∫—ñ–≤
    const lessonFilters = {};
    schedule.lesson_dates.forEach((date, dateIndex) => {
        const filterElement = document.getElementById(`filterLesson_${scheduleIndex}_${dateIndex}`);
        if (filterElement) {
            lessonFilters[dateIndex] = filterElement.value;
        }
    });
    
    // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —É—á–Ω—ñ–≤
    schedule.students.forEach(student => {
        const row = document.getElementById(`studentRow_${scheduleIndex}_${student.id}`);
        if (!row) return;
        
        let showRow = true;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
        if (filters.lastName && !student.last_name.toLowerCase().includes(filters.lastName)) showRow = false;
        if (filters.firstName && !student.first_name.toLowerCase().includes(filters.firstName)) showRow = false;
        if (filters.birthDate && !student.birth_date.toLowerCase().includes(filters.birthDate)) showRow = false;
        if (filters.schoolClass && !student.school_class.toLowerCase().includes(filters.schoolClass)) showRow = false;
        if (filters.phoneFather && !(student.phone_father || '').toLowerCase().includes(filters.phoneFather)) showRow = false;
        if (filters.phoneMother && !(student.phone_mother || '').toLowerCase().includes(filters.phoneMother)) showRow = false;
        if (filters.phoneChild && !(student.phone_child || '').toLowerCase().includes(filters.phoneChild)) showRow = false;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
        for (const [dateIndex, filterValue] of Object.entries(lessonFilters)) {
            if (!filterValue) continue;
            
            const attendance = student.attendance[parseInt(dateIndex)];
            if (!attendance) continue;
            
            let statusMatch = false;
            if (filterValue === 'present' && attendance.status === 'PRESENT') statusMatch = true;
            if (filterValue === 'absent' && attendance.status === 'ABSENT') statusMatch = true;
            if (filterValue === 'no_mark' && !attendance.status) statusMatch = true;
            
            if (!statusMatch) {
                showRow = false;
                break;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateAnalyticsStats() {
    if (!analyticsData || !analyticsData.schedules) return;
    
    let totalStudents = 0;
    let totalLessons = 0;
    
    analyticsData.schedules.forEach(schedule => {
        totalStudents += schedule.students.length;
        totalLessons += schedule.lesson_dates.length;
    });
    
    const statsElement = document.getElementById('analyticsStats');
    if (statsElement) {
        statsElement.innerHTML = `
            <div><strong>${analyticsData.club.name}</strong></div>
            <div>–†–æ–∑–∫–ª–∞–¥—ñ–≤: ${analyticsData.schedules.length} | –£—á–Ω—ñ–≤: ${totalStudents} | –£—Ä–æ–∫—ñ–≤: ${totalLessons}</div>
        `;
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –∑ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
async function toggleAttendanceFromAnalytics(studentId, lessonEventId) {
    try {
        const response = await fetch(`/api/attendance/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                student_id: studentId,
                lesson_event_id: lessonEventId
            })
        });
        
        if (response.ok) {
            // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
            await loadAnalyticsData();
        } else {
            throw new Error('Failed to toggle attendance');
        }
    } catch (error) {
        console.error('Error toggling attendance:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ', 'danger');
    }
}

// –ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö
function exportAnalyticsData() {
    if (!analyticsData) {
        showAlert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'warning');
        return;
    }
    
    showAlert('–ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö –ø–æ–∫–∏ —â–æ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ', 'info');
}

// –î–æ–≤—ñ–¥–∫–∞
function showAnalyticsHelp() {
    showAlert(`
        <h6>üìä –ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ</h6>
        <p><strong>–©–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è:</strong></p>
        <ul>
            <li>–ö–æ–∂–µ–Ω –∞–∫—Ç–∏–≤–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –≥—É—Ä—Ç–∫–∞ –º–∞—î –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é</li>
            <li>–£—á–Ω—ñ –≥—Ä—É–ø—É—é—Ç—å—Å—è –ø–æ —Ä–æ–∑–∫–ª–∞–¥–∞—Ö, –∞ –Ω–µ –∑–º—ñ—à—É—é—Ç—å—Å—è</li>
            <li>–í—ñ–¥–º—ñ—Ç–∫–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ —Ç—ñ–ª—å–∫–∏ –¥–ª—è —É—Ä–æ–∫—ñ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É</li>
        </ul>
        <p><strong>–ü—Ä–∏–∫–ª–∞–¥:</strong> –Ø–∫—â–æ –≥—É—Ä—Ç–æ–∫ "–¢–∞–Ω—Ü—ñ" –º–∞—î —Ä–æ–∑–∫–ª–∞–¥–∏ "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫ 17:00" —ñ "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫ 18:00", 
        —Ç–æ –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ 2 –æ–∫—Ä–µ–º—ñ —Ç–∞–±–ª–∏—Ü—ñ –∑ —É—á–Ω—è–º–∏ —Ç–∞ –≤—ñ–¥–º—ñ—Ç–∫–∞–º–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —á–∞—Å—É.</p>
    `, 'info');
}

// –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
function showLoading(show) {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) {
        indicator.style.display = show ? 'block' : 'none';
    }
}

function hideElements(elementIds) {
    elementIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'none';
    });
}

function showElements(elementIds) {
    elementIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'block';
    });
}

function showAlert(message, type = 'info') {
    // –ü—Ä–æ—Å—Ç–∏–π alert –∑–∞–º—ñ—Å—Ç—å —Å–∫–ª–∞–¥–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å
    alert(message);
}
</script>
{% endblock %}
