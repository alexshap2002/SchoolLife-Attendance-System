{% extends "base.html" %}

{% block content %}
<style>
/* –°—Ç–∏–ª—ñ —Ç–∞—Ä–∏—Ñ—ñ–≤ –≤ —Å—Ç–∏–ª—ñ —ñ–Ω—à–∏—Ö —Ç–∞–±–ª–∏—Ü—å */
#payRatesTable {
    margin-top: 20px;
}

/* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
#payRatesTable th:nth-child(1), #payRatesTable td:nth-child(1) { min-width: 150px; } /* –í—á–∏—Ç–µ–ª—å */
#payRatesTable th:nth-child(2), #payRatesTable td:nth-child(2) { min-width: 120px; } /* –¢–∏–ø —Ç–∞—Ä–∏—Ñ—É */
#payRatesTable th:nth-child(3), #payRatesTable td:nth-child(3) { min-width: 100px; } /* –°—É–º–∞ */
#payRatesTable th:nth-child(4), #payRatesTable td:nth-child(4) { min-width: 120px; } /* –ê–∫—Ç–∏–≤–Ω–∏–π –∑ */
#payRatesTable th:nth-child(5), #payRatesTable td:nth-child(5) { min-width: 120px; } /* –ê–∫—Ç–∏–≤–Ω–∏–π –¥–æ */
#payRatesTable th:nth-child(6), #payRatesTable td:nth-child(6) { min-width: 100px; } /* –°—Ç–∞—Ç—É—Å */
#payRatesTable th:nth-child(7), #payRatesTable td:nth-child(7) { min-width: 100px; } /* –î—ñ—ó */

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑ —è—Å–∫—Ä–∞–≤–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤ */
#payRatesTable thead th {
    white-space: nowrap;
    padding: 12px 8px;
}

/* –§—ñ–ª—å—Ç—Ä–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ */
#payRatesTable .filter-row td {
    padding: 8px 6px;
}

#payRatesTable .filter-input,
#payRatesTable .filter-select {
    font-size: 0.85rem;
    padding: 4px 8px;
    min-width: 90px;
}

/* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
#payRatesTable .btn-group .btn {
    margin: 0 1px;
    padding: 4px 8px;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.stats-card {
    margin-top: 20px;
}
</style>

<!-- –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –∑–∞–º—ñ—Å—Ç—å –ø–æ–¥–≤—ñ–π–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
<div class="mt-4 pt-3"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üí∞ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ–∞–º–∏</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPayRateModal">
        <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ
    </button>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">–¢–∞—Ä–∏—Ñ–∏ –æ–ø–ª–∞—Ç–∏ –≤—á–∏—Ç–µ–ª—ñ–≤</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="payRatesTable">
                <thead>
                    <tr>
                        <th>–í—á–∏—Ç–µ–ª—å</th>
                        <th>–¢–∏–ø —Ç–∞—Ä–∏—Ñ—É</th>
                        <th>–°—É–º–∞</th>
                        <th>–ê–∫—Ç–∏–≤–Ω–∏–π –∑</th>
                        <th>–ê–∫—Ç–∏–≤–Ω–∏–π –¥–æ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                    <!-- –†—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
                    <tr class="filter-row">
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterTeacher" onchange="filterPayRates()">
                                <option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterRateType" onchange="filterPayRates()">
                                <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                                <option value="PER_LESSON">–ó–∞ –∑–∞–Ω—è—Ç—Ç—è</option>
                                <option value="PER_PRESENT">–ó–∞ –ø—Ä–∏—Å—É—Ç–Ω—å–æ–≥–æ</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm filter-input" id="filterAmount" 
                                   placeholder="–°—É–º–∞ –≤—ñ–¥..." min="0" step="0.01" onkeyup="filterPayRates()">
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm filter-input" id="filterActiveFrom" 
                                   onchange="filterPayRates()">
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm filter-input" id="filterActiveTo" 
                                   onchange="filterPayRates()">
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterStatus" onchange="filterPayRates()">
                                <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                                <option value="active">–ê–∫—Ç–∏–≤–Ω—ñ</option>
                                <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ñ</option>
                            </select>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetPayRateFilters()" title="–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </td>
                    </tr>
                </thead>
                <tbody id="payRatesTableBody">
                    <!-- –î–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row stats-card">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞—Ä–∏—Ñ—ñ–≤</h5>
            </div>
            <div class="card-body" id="payRatesStats">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–°–µ—Ä–µ–¥–Ω—ñ —Ç–∞—Ä–∏—Ñ–∏</h5>
            </div>
            <div class="card-body" id="payRatesAvgStats">
                <!-- –°–µ—Ä–µ–¥–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É -->
<div class="modal fade" id="addPayRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–∞—Ä–∏—Ñ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPayRateForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addTeacherId" class="form-label">–í—á–∏—Ç–µ–ª—å</label>
                        <select class="form-select" id="addTeacherId" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addRateType" class="form-label">–¢–∏–ø —Ç–∞—Ä–∏—Ñ—É</label>
                        <select class="form-select" id="addRateType" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø</option>
                            <option value="PER_LESSON">–ó–∞ –∑–∞–Ω—è—Ç—Ç—è</option>
                            <option value="PER_PRESENT">–ó–∞ –ø—Ä–∏—Å—É—Ç–Ω—å–æ–≥–æ —É—á–Ω—è</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addAmount" class="form-label">–°—É–º–∞ (‚Ç¥)</label>
                        <input type="number" class="form-control" id="addAmount" min="0" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="addActiveFrom" class="form-label">–ê–∫—Ç–∏–≤–Ω–∏–π –∑</label>
                        <input type="date" class="form-control" id="addActiveFrom" required>
                    </div>
                    <div class="mb-3">
                        <label for="addActiveTo" class="form-label">–ê–∫—Ç–∏–≤–Ω–∏–π –¥–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                        <input type="date" class="form-control" id="addActiveTo">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É -->
<div class="modal fade" id="editPayRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editPayRateForm">
                <input type="hidden" id="editPayRateId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editTeacherName" class="form-label">–í—á–∏—Ç–µ–ª—å</label>
                        <input type="text" class="form-control" id="editTeacherName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editRateType" class="form-label">–¢–∏–ø —Ç–∞—Ä–∏—Ñ—É</label>
                        <select class="form-select" id="editRateType" required>
                            <option value="PER_LESSON">–ó–∞ –∑–∞–Ω—è—Ç—Ç—è</option>
                            <option value="PER_PRESENT">–ó–∞ –ø—Ä–∏—Å—É—Ç–Ω—å–æ–≥–æ —É—á–Ω—è</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">–°—É–º–∞ (‚Ç¥)</label>
                        <input type="number" class="form-control" id="editAmount" min="0" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="editActiveFrom" class="form-label">–ê–∫—Ç–∏–≤–Ω–∏–π –∑</label>
                        <input type="date" class="form-control" id="editActiveFrom" required>
                    </div>
                    <div class="mb-3">
                        <label for="editActiveTo" class="form-label">–ê–∫—Ç–∏–≤–Ω–∏–π –¥–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                        <input type="date" class="form-control" id="editActiveTo">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-warning">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
let allPayRates = [];
let allTeachers = [];

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö
async function loadAllPayRatesData() {
    try {
        showLoading(true);
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç–∞—Ä–∏—Ñ–∏ —Ç–∞ –≤—á–∏—Ç–µ–ª—ñ–≤ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ
        const [payRatesResponse, teachersResponse] = await Promise.all([
            fetch('/admin/pay_rates'), // –û—Ç—Ä–∏–º—É—î–º–æ HTML, –∞–ª–µ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–∞–Ω—ñ –∑ API
            fetch('/api/teachers')
        ]);
        
        if (!teachersResponse.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—á–∏—Ç–µ–ª—ñ–≤');
        }
        
        allTeachers = await teachersResponse.json();
        
        // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –¥–∞–Ω—ñ –∑ backend –≤ JSON-—Å—É–º—ñ—Å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
        allPayRates = [
            {% for rate in pay_rates %}
            {
                id: {{ rate.id }},
                teacher_id: {{ rate.teacher_id }},
                rate_type: "{{ rate.rate_type.value }}",
                amount_decimal: {{ rate.amount_decimal }},
                active_from: "{{ rate.active_from }}",
                active_to: {% if rate.active_to %}"{{ rate.active_to }}"{% else %}null{% endif %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏
        fillPayRateFilters();
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ
        displayPayRates(allPayRates);
        updatePayRateStats(allPayRates);
        
        showLoading(false);
    } catch (error) {
        showLoading(false);
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–∞—Ä–∏—Ñ—ñ–≤:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–∞—Ä–∏—Ñ—ñ–≤', 'danger');
    }
}

// –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function fillPayRateFilters() {
    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—É –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ —Ç–∞–±–ª–∏—Ü—ñ
    const filterTeacher = document.getElementById('filterTeacher');
    filterTeacher.innerHTML = '<option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>';
    
    allTeachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.full_name;
        filterTeacher.appendChild(option);
    });
    
    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è select –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É
    const addTeacherSelect = document.getElementById('addTeacherId');
    addTeacherSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>';
    
    allTeachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.full_name;
        addTeacherSelect.appendChild(option);
    });
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—ñ–≤
function displayPayRates(payRates) {
    const tableBody = document.getElementById('payRatesTableBody');
    
    if (payRates.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="bi bi-cash-coin"></i><br>
                    –¢–∞—Ä–∏—Ñ—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–¥–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏
                </td>
            </tr>`;
        return;
    }
    
    let bodyHTML = '';
    const today = new Date();
    
    payRates.forEach(rate => {
        const teacher = allTeachers.find(t => t.id === rate.teacher_id);
        const teacherName = teacher ? teacher.full_name : '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
        
        // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç
        const activeFrom = new Date(rate.active_from).toLocaleDateString('uk-UA');
        const activeTo = rate.active_to ? new Date(rate.active_to).toLocaleDateString('uk-UA') : '–ë–µ–∑—Å—Ç—Ä–æ–∫–æ–≤–æ';
        
        // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É
        const activeFromDate = new Date(rate.active_from);
        const activeToDate = rate.active_to ? new Date(rate.active_to) : null;
        const isActive = activeFromDate <= today && (!activeToDate || activeToDate >= today);
        
        // HTML –¥–ª—è —Ä—è–¥–∫–∞
        bodyHTML += `
            <tr>
                <td><strong>${teacherName}</strong></td>
                <td>
                    ${rate.rate_type === 'PER_LESSON' 
                        ? '<span class="badge bg-info">–ó–∞ –∑–∞–Ω—è—Ç—Ç—è</span>' 
                        : '<span class="badge bg-success">–ó–∞ –ø—Ä–∏—Å—É—Ç–Ω—å–æ–≥–æ</span>'}
                </td>
                <td><strong class="text-success">${rate.amount_decimal} ‚Ç¥</strong></td>
                <td>${activeFrom}</td>
                <td>${activeTo}</td>
                <td>
                    ${isActive 
                        ? '<span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∏–π</span>' 
                        : '<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π</span>'}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                onclick="editPayRate(${rate.id}, '${teacherName}', '${rate.rate_type}', ${rate.amount_decimal}, '${rate.active_from}', '${rate.active_to || ''}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                onclick="deletePayRate(${rate.id}, '${teacherName}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
    });
    
    tableBody.innerHTML = bodyHTML;
}

// –§—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—ñ–≤
function filterPayRates() {
    const teacherFilter = parseInt(document.getElementById('filterTeacher').value);
    const rateTypeFilter = document.getElementById('filterRateType').value;
    const amountFilter = parseFloat(document.getElementById('filterAmount').value);
    const activeFromFilter = document.getElementById('filterActiveFrom').value;
    const activeToFilter = document.getElementById('filterActiveTo').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    let filteredRates = allPayRates;
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≤—á–∏—Ç–µ–ª—é
    if (teacherFilter) {
        filteredRates = filteredRates.filter(rate => rate.teacher_id === teacherFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Ç–∞—Ä–∏—Ñ—É
    if (rateTypeFilter) {
        filteredRates = filteredRates.filter(rate => rate.rate_type === rateTypeFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—É–º—ñ (–≤—ñ–¥ –∑–∞–¥–∞–Ω–æ—ó —Å—É–º–∏ —ñ –≤–∏—â–µ)
    if (!isNaN(amountFilter)) {
        filteredRates = filteredRates.filter(rate => parseFloat(rate.amount_decimal) >= amountFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ "–∞–∫—Ç–∏–≤–Ω–∏–π –∑"
    if (activeFromFilter) {
        const filterDate = new Date(activeFromFilter);
        filteredRates = filteredRates.filter(rate => new Date(rate.active_from) >= filterDate);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ "–∞–∫—Ç–∏–≤–Ω–∏–π –¥–æ"
    if (activeToFilter) {
        const filterDate = new Date(activeToFilter);
        filteredRates = filteredRates.filter(rate => {
            if (!rate.active_to) return false; // –ë–µ–∑—Å—Ç—Ä–æ–∫–æ–≤—ñ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç—å —Ñ—ñ–ª—å—Ç—Ä –ø–æ –∫—ñ–Ω—Ü–µ–≤—ñ–π –¥–∞—Ç—ñ
            return new Date(rate.active_to) <= filterDate;
        });
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (statusFilter) {
        const today = new Date();
        filteredRates = filteredRates.filter(rate => {
            const activeFromDate = new Date(rate.active_from);
            const activeToDate = rate.active_to ? new Date(rate.active_to) : null;
            const isActive = activeFromDate <= today && (!activeToDate || activeToDate >= today);
            
            return statusFilter === 'active' ? isActive : !isActive;
        });
    }
    
    displayPayRates(filteredRates);
    updatePayRateStats(filteredRates);
}

// –°–∫–∏–¥–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function resetPayRateFilters() {
    document.getElementById('filterTeacher').value = '';
    document.getElementById('filterRateType').value = '';
    document.getElementById('filterAmount').value = '';
    document.getElementById('filterActiveFrom').value = '';
    document.getElementById('filterActiveTo').value = '';
    document.getElementById('filterStatus').value = '';
    
    displayPayRates(allPayRates);
    updatePayRateStats(allPayRates);
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updatePayRateStats(rates = allPayRates) {
    const total = rates.length;
    const perLessonCount = rates.filter(r => r.rate_type === 'PER_LESSON').length;
    const perPresentCount = rates.filter(r => r.rate_type === 'PER_PRESENT').length;
    
    const today = new Date();
    const activeCount = rates.filter(rate => {
        const activeFromDate = new Date(rate.active_from);
        const activeToDate = rate.active_to ? new Date(rate.active_to) : null;
        return activeFromDate <= today && (!activeToDate || activeToDate >= today);
    }).length;
    
    document.getElementById('payRatesStats').innerHTML = `
        <p><strong>–í—Å—å–æ–≥–æ —Ç–∞—Ä–∏—Ñ—ñ–≤:</strong> ${total}</p>
        <p><strong>–ó–∞ –∑–∞–Ω—è—Ç—Ç—è:</strong> ${perLessonCount}</p>
        <p><strong>–ó–∞ –ø—Ä–∏—Å—É—Ç–Ω—å–æ–≥–æ:</strong> ${perPresentCount}</p>
        <p><strong>–ê–∫—Ç–∏–≤–Ω–∏—Ö:</strong> ${activeCount}</p>
    `;
    
    // –°–µ—Ä–µ–¥–Ω—ñ —Ç–∞—Ä–∏—Ñ–∏
    if (rates.length > 0) {
        const totalAmount = rates.reduce((sum, rate) => sum + parseFloat(rate.amount_decimal), 0);
        const avgAmount = (totalAmount / rates.length).toFixed(2);
        
        const avgPerLesson = perLessonCount > 0 
            ? (rates.filter(r => r.rate_type === 'PER_LESSON')
                    .reduce((sum, rate) => sum + parseFloat(rate.amount_decimal), 0) / perLessonCount).toFixed(2)
            : 0;
            
        const avgPerPresent = perPresentCount > 0 
            ? (rates.filter(r => r.rate_type === 'PER_PRESENT')
                    .reduce((sum, rate) => sum + parseFloat(rate.amount_decimal), 0) / perPresentCount).toFixed(2)
            : 0;
        
        document.getElementById('payRatesAvgStats').innerHTML = `
            <p><strong>–°–µ—Ä–µ–¥–Ω—ñ–π —Ç–∞—Ä–∏—Ñ:</strong> ${avgAmount} ‚Ç¥</p>
            <p><strong>–°–µ—Ä–µ–¥–Ω—ñ–π –∑–∞ –∑–∞–Ω—è—Ç—Ç—è:</strong> ${avgPerLesson} ‚Ç¥</p>
            <p><strong>–°–µ—Ä–µ–¥–Ω—ñ–π –∑–∞ –ø—Ä–∏—Å—É—Ç–Ω—å–æ–≥–æ:</strong> ${avgPerPresent} ‚Ç¥</p>
        `;
    } else {
        document.getElementById('payRatesAvgStats').innerHTML = `
            <p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</p>
        `;
    }
}

// –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É
document.getElementById('addPayRateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        teacher_id: parseInt(document.getElementById('addTeacherId').value),
        rate_type: document.getElementById('addRateType').value,
        amount_decimal: parseFloat(document.getElementById('addAmount').value),
        active_from: document.getElementById('addActiveFrom').value,
        active_to: document.getElementById('addActiveTo').value || null
    };
    
    try {
        const response = await fetch('/api/pay_rates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showAlert('–¢–∞—Ä–∏—Ñ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addPayRateModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showAlert(error.detail || '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É', 'danger');
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ', 'danger');
    }
});

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É
function editPayRate(id, teacherName, rateType, amount, activeFrom, activeTo) {
    document.getElementById('editPayRateId').value = id;
    document.getElementById('editTeacherName').value = teacherName;
    document.getElementById('editRateType').value = rateType;
    document.getElementById('editAmount').value = amount;
    document.getElementById('editActiveFrom').value = activeFrom;
    document.getElementById('editActiveTo').value = activeTo;
    
    new bootstrap.Modal(document.getElementById('editPayRateModal')).show();
}

document.getElementById('editPayRateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('editPayRateId').value;
    const formData = {
        rate_type: document.getElementById('editRateType').value,
        amount_decimal: parseFloat(document.getElementById('editAmount').value),
        active_from: document.getElementById('editActiveFrom').value,
        active_to: document.getElementById('editActiveTo').value || null
    };
    
    try {
        const response = await fetch(`/api/pay_rates/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showAlert('–¢–∞—Ä–∏—Ñ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editPayRateModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showAlert(error.detail || '–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É', 'danger');
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ', 'danger');
    }
});

// –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É
async function deletePayRate(id, teacherName) {
    if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–∞—Ä–∏—Ñ –¥–ª—è –≤—á–∏—Ç–µ–ª—è "${teacherName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pay_rates/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('–¢–∞—Ä–∏—Ñ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showAlert(error.detail || '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É', 'danger');
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ', 'danger');
    }
}

// –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É —Å–ø–æ–≤—ñ—â–µ–Ω—å
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// –§—É–Ω–∫—Ü—ñ—è –ø–æ–∫–∞–∑—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
function showLoading(show = true) {
    let spinner = document.getElementById('loadingSpinner');
    if (!spinner && show) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></div>';
        spinner.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;';
        document.body.appendChild(spinner);
    }
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', () => {
    loadAllPayRatesData();
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('addActiveFrom').value = today;
});
</script>
{% endblock %}
