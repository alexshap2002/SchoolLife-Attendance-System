{% extends "base.html" %}

{% block title %}Історія змін - Адміністративна панель{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-clock-history me-2"></i>Історія змін системи</h2>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel me-1"></i> Експорт в Excel
            </button>
            <button type="button" class="btn btn-outline-danger" onclick="showDeleteOldDialog()">
                <i class="bi bi-trash me-1"></i> Видалити старі записи
            </button>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Всього записів</h6>
                    <h3 id="statTotal">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Створено</h6>
                    <h3 id="statCreate">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">Оновлено</h6>
                    <h3 id="statUpdate">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title">Видалено</h6>
                    <h3 id="statDelete">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Фільтри -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3"><i class="bi bi-funnel me-2"></i>Фільтри</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Пошук</label>
                    <input type="text" id="filterSearch" class="form-control" placeholder="Пошук по імені, опису...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Тип дії</label>
                    <select id="filterAction" class="form-select">
                        <option value="">Всі дії</option>
                        <option value="CREATE">Створення</option>
                        <option value="UPDATE">Оновлення</option>
                        <option value="DELETE">Видалення</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Тип сутності</label>
                    <select id="filterEntity" class="form-select">
                        <option value="">Всі типи</option>
                        <option value="student">Учні</option>
                        <option value="teacher">Вчителі</option>
                        <option value="club">Гуртки</option>
                        <option value="enrollment">Записи на гуртки</option>
                        <option value="schedule_enrollment">Записи на розклад</option>
                        <option value="schedule">Розклад</option>
                        <option value="conducted_lesson">Проведені уроки</option>
                        <option value="attendance">Відвідуваність</option>
                        <option value="payroll">Зарплата</option>
                        <option value="pay_rate">Ставки зарплати</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Дата від</label>
                    <input type="date" id="filterDateFrom" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Дата до</label>
                    <input type="date" id="filterDateTo" class="form-control">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()" title="Скинути фільтри (показати сьогодні)">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблиця логів -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="auditTable">
                    <thead>
                        <tr>
                            <th style="width: 150px;">Дата і час</th>
                            <th style="width: 120px;">Користувач</th>
                            <th style="width: 100px;">Дія</th>
                            <th style="width: 100px;">Тип</th>
                            <th style="width: 200px;">Об'єкт</th>
                            <th>Опис</th>
                            <th style="width: 80px;">Деталі</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Завантаження...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Пагінація -->
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Модальне вікно для деталей -->
<div class="modal fade" id="auditDetailModal" tabindex="-1" aria-labelledby="auditDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="auditDetailModalLabel">
                    <i class="bi bi-info-circle me-2"></i>Деталі запису історії
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="auditDetailContent">
                <!-- Динамічний контент -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрити</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальне вікно для видалення старих записів -->
<div class="modal fade" id="deleteOldModal" tabindex="-1" aria-labelledby="deleteOldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteOldModalLabel">
                    <i class="bi bi-trash me-2"></i>Видалення старих записів
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Видалити всі записи старіші за:</p>
                <select id="deleteOldDays" class="form-select">
                    <option value="365">1 рік (365 днів)</option>
                    <option value="730">2 роки (730 днів)</option>
                    <option value="1095">3 роки (1095 днів)</option>
                    <option value="180">6 місяців (180 днів)</option>
                    <option value="90">3 місяці (90 днів)</option>
                    <option value="30">1 місяць (30 днів)</option>
                </select>
                <div class="alert alert-warning mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Ця дія незворотня! Видалені записи неможливо відновити.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                <button type="button" class="btn btn-danger" onclick="deleteOldLogs()">
                    <i class="bi bi-trash me-1"></i> Видалити
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// === GLOBAL STATE ===
let currentPage = 1;
let pageSize = 50;
let totalLogs = 0;
let totalPages = 0;
let currentFilters = {};

// === ICONS ===
const ACTION_ICONS = {
    'CREATE': '<i class="bi bi-plus-circle-fill text-success"></i>',
    'UPDATE': '<i class="bi bi-pencil-fill text-warning"></i>',
    'DELETE': '<i class="bi bi-trash-fill text-danger"></i>'
};

const ACTION_BADGES = {
    'CREATE': '<span class="badge bg-success">Створено</span>',
    'UPDATE': '<span class="badge bg-warning text-dark">Оновлено</span>',
    'DELETE': '<span class="badge bg-danger">Видалено</span>'
};

const ENTITY_NAMES = {
    'student': 'Учень',
    'teacher': 'Вчитель',
    'club': 'Гурток',
    'enrollment': 'Запис на гурток',
    'schedule_enrollment': 'Запис на розклад',
    'schedule': 'Розклад',
    'conducted_lesson': 'Проведений урок',
    'attendance': 'Відвідуваність',
    'payroll': 'Зарплата',
    'pay_rate': 'Ставка зарплати'
};

// === LOAD DATA ===
async function loadAuditLogs(page = 1) {
    currentPage = page;
    
    const params = new URLSearchParams({
        page: currentPage,
        page_size: pageSize
    });
    
    // Додаємо фільтри
    if (currentFilters.search) params.append('search', currentFilters.search);
    if (currentFilters.action_type) params.append('action_type', currentFilters.action_type);
    if (currentFilters.entity_type) params.append('entity_type', currentFilters.entity_type);
    if (currentFilters.date_from) params.append('date_from', currentFilters.date_from + 'T00:00:00');
    if (currentFilters.date_to) params.append('date_to', currentFilters.date_to + 'T23:59:59');
    
    try {
        const response = await fetch(`/api/audit/logs?${params}`);
        if (!response.ok) {
            throw new Error('Failed to load audit logs');
        }
        
        const data = await response.json();
        totalLogs = data.total;
        totalPages = data.total_pages;
        
        displayAuditLogs(data.logs);
        renderPagination();
    } catch (error) {
        console.error('Error loading audit logs:', error);
        document.getElementById('auditTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Помилка завантаження даних
                </td>
            </tr>
        `;
    }
}

// === DISPLAY LOGS ===
function displayAuditLogs(logs) {
    const tbody = document.getElementById('auditTableBody');
    
    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="bi bi-inbox me-2"></i>
                    Записів не знайдено
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = logs.map(log => `
        <tr>
            <td>${formatDateTime(log.timestamp)}</td>
            <td>${escapeHtml(log.user_name)}</td>
            <td>${ACTION_BADGES[log.action_type] || log.action_type}</td>
            <td><span class="badge bg-secondary">${ENTITY_NAMES[log.entity_type] || log.entity_type}</span></td>
            <td>${escapeHtml(log.entity_name || '-')}</td>
            <td>${escapeHtml(log.description)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showAuditDetails(${log.id})">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// === PAGINATION ===
function renderPagination() {
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadAuditLogs(${currentPage - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAuditLogs(1); return false;">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadAuditLogs(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAuditLogs(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadAuditLogs(${currentPage + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

// === FILTERS ===
function applyFilters() {
    currentFilters = {
        search: document.getElementById('filterSearch').value.trim(),
        action_type: document.getElementById('filterAction').value,
        entity_type: document.getElementById('filterEntity').value,
        date_from: document.getElementById('filterDateFrom').value,
        date_to: document.getElementById('filterDateTo').value
    };
    
    loadAuditLogs(1); // Reset to first page
}

// === RESET FILTERS ===
function resetFilters() {
    const today = new Date().toISOString().split('T')[0];
    
    // Скидаємо всі поля
    document.getElementById('filterSearch').value = '';
    document.getElementById('filterAction').value = '';
    document.getElementById('filterEntity').value = '';
    document.getElementById('filterDateFrom').value = today;
    document.getElementById('filterDateTo').value = today;
    
    // Скидаємо фільтри
    currentFilters = {
        search: '',
        action_type: '',
        entity_type: '',
        date_from: today,
        date_to: today
    };
    
    loadAuditLogs(1);
}

// === DETAILS MODAL ===
async function showAuditDetails(logId) {
    try {
        const response = await fetch(`/api/audit/logs/${logId}`);
        if (!response.ok) {
            throw new Error('Failed to load audit log details');
        }
        
        const log = await response.json();
        
        let changesHtml = '<p class="text-muted">Немає даних про зміни</p>';
        if (log.changes_json) {
            changesHtml = '<pre class="bg-light p-3 rounded">' + 
                         JSON.stringify(log.changes_json, null, 2) + '</pre>';
        }
        
        document.getElementById('auditDetailContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-calendar-event me-2"></i>Дата і час</h6>
                    <p>${formatDateTime(log.timestamp)}</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-person me-2"></i>Користувач</h6>
                    <p>${escapeHtml(log.user_name)}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6><i class="bi bi-lightning me-2"></i>Тип дії</h6>
                    <p>${ACTION_BADGES[log.action_type] || log.action_type}</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-box me-2"></i>Тип сутності</h6>
                    <p><span class="badge bg-secondary">${ENTITY_NAMES[log.entity_type] || log.entity_type}</span></p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="bi bi-tag me-2"></i>Об'єкт</h6>
                    <p>${escapeHtml(log.entity_name || '-')}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="bi bi-file-text me-2"></i>Опис</h6>
                    <p>${escapeHtml(log.description)}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="bi bi-code-square me-2"></i>Деталі змін</h6>
                    ${changesHtml}
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('auditDetailModal'));
        modal.show();
    } catch (error) {
        console.error('Error loading audit log details:', error);
        alert('Помилка завантаження деталей запису');
    }
}

// === DELETE OLD LOGS ===
function showDeleteOldDialog() {
    const modal = new bootstrap.Modal(document.getElementById('deleteOldModal'));
    modal.show();
}

async function deleteOldLogs() {
    const days = document.getElementById('deleteOldDays').value;
    
    if (!confirm(`Ви впевнені, що хочете видалити всі записи старіші за ${days} днів? Ця дія незворотня!`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/audit/logs/old?days=${days}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete old logs');
        }
        
        const result = await response.json();
        alert(`Успішно видалено ${result.deleted_count} записів`);
        
        // Закриваємо модальне вікно
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteOldModal'));
        modal.hide();
        
        // Перезавантажуємо дані
        loadAuditLogs(1);
        loadStats();
    } catch (error) {
        console.error('Error deleting old logs:', error);
        alert('Помилка видалення старих записів');
    }
}

// === EXPORT TO EXCEL ===
async function exportToExcel() {
    try {
        // Завантажуємо всі записи (без пагінації)
        const params = new URLSearchParams({
            page: 1,
            page_size: 10000 // Максимум
        });
        
        // Додаємо фільтри
        if (currentFilters.search) params.append('search', currentFilters.search);
        if (currentFilters.action_type) params.append('action_type', currentFilters.action_type);
        if (currentFilters.entity_type) params.append('entity_type', currentFilters.entity_type);
        if (currentFilters.date_from) params.append('date_from', currentFilters.date_from + 'T00:00:00');
        if (currentFilters.date_to) params.append('date_to', currentFilters.date_to + 'T23:59:59');
        
        const response = await fetch(`/api/audit/logs?${params}`);
        if (!response.ok) {
            throw new Error('Failed to load audit logs for export');
        }
        
        const data = await response.json();
        
        // Конвертуємо в CSV
        const csvContent = convertToCSV(data.logs);
        
        // Скачуємо файл
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `audit_log_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Помилка експорту в Excel');
    }
}

function convertToCSV(logs) {
    const headers = ['Дата і час', 'Користувач', 'Дія', 'Тип', 'Об\'єкт', 'Опис'];
    const rows = logs.map(log => [
        formatDateTime(log.timestamp),
        log.user_name,
        log.action_type,
        ENTITY_NAMES[log.entity_type] || log.entity_type,
        log.entity_name || '-',
        log.description
    ]);
    
    const csvRows = [headers, ...rows];
    return csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
}

// === STATS ===
async function loadStats() {
    try {
        const response = await fetch('/api/audit/stats?days=30');
        if (!response.ok) {
            throw new Error('Failed to load stats');
        }
        
        const stats = await response.json();
        
        document.getElementById('statTotal').textContent = stats.total_logs;
        document.getElementById('statCreate').textContent = stats.actions.CREATE || 0;
        document.getElementById('statUpdate').textContent = stats.actions.UPDATE || 0;
        document.getElementById('statDelete').textContent = stats.actions.DELETE || 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// === UTILITIES ===
function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${day}.${month}.${year} ${hours}:${minutes}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// === EVENT LISTENERS ===
document.getElementById('filterSearch').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
        applyFilters();
    }
});

// === INIT ===
document.addEventListener('DOMContentLoaded', () => {
    // За замовчуванням показуємо тільки СЬОГОДНІ (щоб швидко завантажувалось)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('filterDateFrom').value = today;
    document.getElementById('filterDateTo').value = today;
    
    // Встановлюємо фільтри для завантаження
    currentFilters.date_from = today;
    currentFilters.date_to = today;
    
    loadAuditLogs(1);
    loadStats();
});
</script>

<style>
.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.table thead th {
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 10;
}

.pagination {
    margin-bottom: 0;
}

pre {
    max-height: 400px;
    overflow-y: auto;
}
</style>
{% endblock %}

