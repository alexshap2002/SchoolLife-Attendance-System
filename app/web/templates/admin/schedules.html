{% extends "base.html" %}

{% block content %}
<!-- –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –∑–∞–º—ñ—Å—Ç—å –ø–æ–¥–≤—ñ–π–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
<div class="mt-4 pt-3"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìÖ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥–æ–º</h2>
    <div class="btn-group">
        <button type="button" class="btn btn-primary" onclick="openAddScheduleModal()">
            <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è
        </button>
        <button type="button" class="btn btn-outline-success" onclick="exportSchedulesExcel()">
            <i class="bi bi-file-earmark-spreadsheet"></i> –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
        </button>
    </div>
</div>

<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead id="schedulesTableHead">
                    <!-- –ë—É–¥–µ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </thead>
                <tbody id="schedulesTableBody">
                    <!-- –ë—É–¥–µ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–æ–∑–∫–ª–∞–¥—É</h5>
                </div>
                <div class="card-body">
                    <p><strong>–í—Å—å–æ–≥–æ –∑–∞–Ω—è—Ç—å:</strong> {{ schedules|length }}</p>
                    <p><strong>–ê–∫—Ç–∏–≤–Ω–∏—Ö:</strong> {{ schedules|selectattr('active')|list|length }}</p>
                    <p><strong>–ù–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö:</strong> {{ schedules|rejectattr('active')|list|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –¥–Ω—è—Ö</h5>
                </div>
                <div class="card-body">
                    {% set weekdays = {1: "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", 2: "–í—ñ–≤—Ç–æ—Ä–æ–∫", 3: "–°–µ—Ä–µ–¥–∞", 4: "–ß–µ—Ç–≤–µ—Ä", 5: "–ü'—è—Ç–Ω–∏—Ü—è"} %}
                    {% for day_num, day_name in weekdays.items() %}
                        {% set day_schedules = schedules|selectattr('weekday', 'equalto', day_num)|list %}
                        <p><strong>{{ day_name }}:</strong> {{ day_schedules|length }} –∑–∞–Ω—è—Ç—å</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –∑–∞–Ω—è—Ç—Ç—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addScheduleForm">
                    <div class="mb-3">
                        <label for="scheduleClub" class="form-label">–ì—É—Ä—Ç–æ–∫ *</label>
                        <select class="form-select" id="scheduleClub" name="clubId" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –≥—É—Ä—Ç–æ–∫</option>
                            <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="scheduleTeacher" class="form-label">–í—á–∏—Ç–µ–ª—å *</label>
                        <select class="form-select" id="scheduleTeacher" name="teacherId" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>
                            <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="scheduleWeekday" class="form-label">–î–µ–Ω—å —Ç–∏–∂–Ω—è *</label>
                        <select class="form-select" id="scheduleWeekday" name="weekday" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å</option>
                            <option value="1">–ü–æ–Ω–µ–¥—ñ–ª–æ–∫</option>
                            <option value="2">–í—ñ–≤—Ç–æ—Ä–æ–∫</option>
                            <option value="3">–°–µ—Ä–µ–¥–∞</option>
                            <option value="4">–ß–µ—Ç–≤–µ—Ä</option>
                            <option value="5">–ü'—è—Ç–Ω–∏—Ü—è</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="scheduleTime" class="form-label">–ß–∞—Å –ø–æ—á–∞—Ç–∫—É *</label>
                        <input type="time" class="form-control" id="scheduleTime" name="startTime" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scheduleActive" name="active" checked>
                            <label class="form-check-label" for="scheduleActive">
                                –ê–∫—Ç–∏–≤–Ω–µ –∑–∞–Ω—è—Ç—Ç—è
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Students Modal -->
<div class="modal fade" id="manageStudentsModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —É—á–Ω—è–º–∏ –≥—Ä—É–ø–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row h-100">
                    <div class="col-md-6 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">–î–æ—Å—Ç—É–ø–Ω—ñ —É—á–Ω—ñ</h6>
                            <input type="text" class="form-control form-control-sm w-50" 
                                   id="searchAvailableStudents" placeholder="üîç –ü–æ—à—É–∫ —É—á–Ω—ñ–≤..." 
                                   onkeyup="searchStudents('available')">
                        </div>
                        <div class="border rounded p-3 flex-grow-1" style="overflow-y: auto; min-height: 500px;">
                            <div id="availableStudentsList">
                                <!-- –ë—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">–ó–∞–ø–∏—Å–∞–Ω—ñ —É—á–Ω—ñ</h6>
                            <input type="text" class="form-control form-control-sm w-50" 
                                   id="searchEnrolledStudents" placeholder="üîç –ü–æ—à—É–∫ –∑–∞–ø–∏—Å–∞–Ω–∏—Ö..." 
                                   onkeyup="searchStudents('enrolled')">
                        </div>
                        <div class="border rounded p-3 flex-grow-1" style="overflow-y: auto; min-height: 500px;">
                            <div id="enrolledStudentsList">
                                <!-- –ë—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <span class="badge bg-info me-2">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="availableCount">0</span></span>
                        <span class="badge bg-success">–ó–∞–ø–∏—Å–∞–Ω–æ: <span id="enrolledCount">0</span></span>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –§–Ü–õ–¨–¢–†–Ü–í - –ì–ê–†–ê–ù–¢–û–í–ê–ù–ê –†–û–ë–û–ß–ê –í–ï–†–°–Ü–Ø -->
<script>
// –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –§–Ü–õ–¨–¢–†–Ü–í –†–û–ó–ö–õ–ê–î–£ - –ì–ê–†–ê–ù–¢–û–í–ê–ù–ê –†–û–ë–û–ß–ê –í–ï–†–°–Ü–Ø
// –¶–µ–π –∫–æ–¥ –∑–∞–º—ñ–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ñ —á–∞—Å—Ç–∏–Ω–∏ admin.js

// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ - –æ–≥–æ–ª–æ—à—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ä–∞–∑
window.filtersData = {
    schedules: [],
    clubs: [],
    teachers: [],
    students: [],
    enrollments: []
};

// –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ—é —Ä–æ–±–æ—Ç–æ—é
async function loadFiltersData() {
    console.log('üîÑ [FIX] –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤...');
    
    try {
        const API_BASE = window.location.origin + '/api';
        
        // –ü–∞—Ä–∞–ª–µ–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –ø–æ—Ç—Ä—ñ–±–Ω–∏—Ö –¥–∞–Ω–∏—Ö
        // üîß FIX: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –í–°–Ü —Ä–æ–∑–∫–ª–∞–¥–∏ (–≤–∫–ª—é—á–Ω–æ –∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–º–∏) –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
        const [schedules, clubs, teachers, students, enrollments] = await Promise.all([
            fetch(`${API_BASE}/schedules?include_inactive=true`).then(r => r.json()),
            fetch(`${API_BASE}/clubs`).then(r => r.json()),
            fetch(`${API_BASE}/teachers`).then(r => r.json()),
            fetch(`${API_BASE}/students`).then(r => r.json()),
            fetch(`${API_BASE}/schedule-enrollments`).then(r => r.json())
        ]);
        
        // üîß FIX: –î–æ–¥–∞—î–º–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —É—á–Ω—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É
        schedules.forEach(schedule => {
            schedule.enrolledCount = enrollments.filter(e => e.schedule_id === schedule.id).length;
        });
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É –æ–±'—î–∫—Ç—ñ
        window.filtersData.schedules = schedules;
        window.filtersData.clubs = clubs;
        window.filtersData.teachers = teachers;
        window.filtersData.students = students;
        window.filtersData.enrollments = enrollments;
        
        console.log('‚úÖ [FIX] –î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', {
            schedules: schedules.length,
            clubs: clubs.length,
            teachers: teachers.length,
            students: students.length,
            enrollments: enrollments.length
        });
        
        return true;
        
    } catch (error) {
        console.error('‚ùå [FIX] –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
        return false;
    }
}

// –§—É–Ω–∫—Ü—ñ—è –ø–æ–±—É–¥–æ–≤–∏ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –∑ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ—é —Ä–æ–±–æ—Ç–æ—é
function buildFiltersTable() {
    console.log('üî® [FIX] –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞–±–ª–∏—Ü—ñ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏...');
    
    const tableHead = document.getElementById('schedulesTableHead');
    const tableBody = document.getElementById('schedulesTableBody');
    
    if (!tableHead || !tableBody) {
        console.error('‚ùå [FIX] –ï–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ');
        return false;
    }
    
        // –ì–µ–Ω–µ—Ä—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
        tableHead.innerHTML = `
            <tr>
                <th>–î–µ–Ω—å —Ç–∏–∂–Ω—è</th>
                <th>–ß–∞—Å</th>
                <th>–ì—É—Ä—Ç–æ–∫</th>
                <th>–í—á–∏—Ç–µ–ª—å</th>
                <th>–£—á–Ω—ñ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î—ñ—ó</th>
            </tr>
            <tr style="background: #f8f9fa;">
                <td>
                    <select class="form-select form-select-sm" id="filterDay" onchange="applyFilters()">
                        <option value="">–í—Å—ñ –¥–Ω—ñ</option>
                        <option value="1">–ü–æ–Ω–µ–¥—ñ–ª–æ–∫</option>
                        <option value="2">–í—ñ–≤—Ç–æ—Ä–æ–∫</option>
                        <option value="3">–°–µ—Ä–µ–¥–∞</option>
                        <option value="4">–ß–µ—Ç–≤–µ—Ä</option>
                        <option value="5">–ü'—è—Ç–Ω–∏—Ü—è</option>
                    </select>
                </td>
                <td>
                    <input class="form-control form-control-sm" id="filterTime" placeholder="–ß–∞—Å" onkeyup="applyFilters()">
                </td>
                <td>
                    <select class="form-select form-select-sm" id="filterClub" onchange="applyFilters()">
                        <option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm" id="filterTeacher" onchange="applyFilters()">
                        <option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>
                    </select>
                </td>
                <td>
                    <input class="form-control form-control-sm" id="filterStudentCount" placeholder="–ö-—Ç—å" onkeyup="applyFilters()">
                </td>
                <td>
                    <select class="form-select form-select-sm" id="filterStatus" onchange="applyFilters()">
                        <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                        <option value="true">–ê–∫—Ç–∏–≤–Ω–∏–π</option>
                        <option value="false">–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π</option>
                    </select>
                </td>
                <td></td>
            </tr>
        `;
    
    console.log('‚úÖ [FIX] –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ —Å—Ç–≤–æ—Ä–µ–Ω–æ');
    return true;
}

// –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –∑ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ—é —Ä–æ–±–æ—Ç–æ—é
function populateFilters() {
    console.log('üîß [FIX] –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤...');
    
    const data = window.filtersData;
    
    if (!data.clubs.length || !data.teachers.length) {
        console.warn('‚ö†Ô∏è [FIX] –î–∞–Ω—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ');
        return false;
    }
    
    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –≥—É—Ä—Ç–∫—ñ–≤
    const clubFilter = document.getElementById('filterClub');
    if (clubFilter) {
        clubFilter.innerHTML = '<option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>';
        data.clubs.forEach(club => {
            clubFilter.innerHTML += `<option value="${club.id}">${club.name}</option>`;
        });
        console.log(`‚úÖ [FIX] –§—ñ–ª—å—Ç—Ä –≥—É—Ä—Ç–∫—ñ–≤: ${data.clubs.length} –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤`);
    }
    
    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –≤—á–∏—Ç–µ–ª—ñ–≤
    const teacherFilter = document.getElementById('filterTeacher');
    if (teacherFilter) {
        teacherFilter.innerHTML = '<option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>';
        data.teachers.forEach(teacher => {
            teacherFilter.innerHTML += `<option value="${teacher.id}">${teacher.full_name}</option>`;
        });
        console.log(`‚úÖ [FIX] –§—ñ–ª—å—Ç—Ä –≤—á–∏—Ç–µ–ª—ñ–≤: ${data.teachers.length} –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤`);
    }
    
    return true;
}

// –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—ñ–≤
function displaySchedules(schedules = null) {
    const tableBody = document.getElementById('schedulesTableBody');
    if (!tableBody) return;
    
    const data = schedules || window.filtersData.schedules;
    
    if (!data.length) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">–ù–µ–º–∞—î —Ä–æ–∑–∫–ª–∞–¥—ñ–≤</td></tr>';
        return;
    }
    
    const weekdays = ['', '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', "–ü'—è—Ç–Ω–∏—Ü—è"];
    
        let html = '';
        data.slice(0, 50).forEach(schedule => { // –ü–æ–∫–∞–∑—É—î–º–æ –ø–µ—Ä—à—ñ 50
            const clubName = schedule.club?.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –≥—É—Ä—Ç–æ–∫';
            const teacherName = schedule.teacher?.full_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –≤—á–∏—Ç–µ–ª—å';
            const weekdayName = weekdays[schedule.weekday] || '–ù–µ–≤—ñ–¥–æ–º–∏–π –¥–µ–Ω—å';
            
            html += `
                <tr>
                    <td>${weekdayName}</td>
                    <td>${schedule.start_time}</td>
                    <td>${clubName}</td>
                    <td>${teacherName}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-info" 
                                onclick="manageScheduleStudents && manageScheduleStudents(${schedule.id})" 
                                title="–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —É—á–Ω—è–º–∏">
                            <i class="bi bi-people"></i> ${schedule.enrolledCount || 0}
                        </button>
                    </td>
                    <td>${schedule.active ? '<span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∏–π</span>' : '<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editSchedule && editSchedule(${schedule.id})">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                    </td>
                </tr>
            `;
        });
    
    tableBody.innerHTML = html;
    console.log(`üìã [FIX] –ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(50, data.length)} –∑ ${data.length} —Ä–æ–∑–∫–ª–∞–¥—ñ–≤`);
}

    // –§—É–Ω–∫—Ü—ñ—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
    function applyFilters() {
        console.log('üîç [FIX] –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤...');
        
        const dayFilter = document.getElementById('filterDay')?.value || '';
        const timeFilter = document.getElementById('filterTime')?.value.toLowerCase() || '';
        const clubFilter = document.getElementById('filterClub')?.value || '';
        const teacherFilter = document.getElementById('filterTeacher')?.value || '';
        const studentCountFilter = document.getElementById('filterStudentCount')?.value || '';
        const statusFilter = document.getElementById('filterStatus')?.value || '';
        
        const filteredSchedules = window.filtersData.schedules.filter(schedule => {
            // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–Ω—é —Ç–∏–∂–Ω—è
            if (dayFilter && schedule.weekday.toString() !== dayFilter) return false;
            
            // –§—ñ–ª—å—Ç—Ä –ø–æ —á–∞—Å—É
            if (timeFilter && !schedule.start_time.toLowerCase().includes(timeFilter)) return false;
            
            // –§—ñ–ª—å—Ç—Ä –ø–æ –≥—É—Ä—Ç–∫—É
            if (clubFilter && schedule.club_id.toString() !== clubFilter) return false;
            
            // –§—ñ–ª—å—Ç—Ä –ø–æ –≤—á–∏—Ç–µ–ª—é
            if (teacherFilter && schedule.teacher_id.toString() !== teacherFilter) return false;
            
            // –§—ñ–ª—å—Ç—Ä –ø–æ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —É—á–Ω—ñ–≤
            if (studentCountFilter && !schedule.enrolledCount.toString().includes(studentCountFilter)) return false;
            
            // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if (statusFilter && schedule.active.toString() !== statusFilter) return false;
            
            return true;
        });
        
        console.log(`üìä [FIX] –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${filteredSchedules.length} –∑ ${window.filtersData.schedules.length}`);
        displaySchedules(filteredSchedules);
    }

// –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
async function initializeFilters() {
    console.log('üöÄ [FIX] –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —Ä–æ–∑–∫–ª–∞–¥—É...');
    
    try {
        // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
        const dataLoaded = await loadFiltersData();
        if (!dataLoaded) {
            throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ');
        }
        
        // 2. –ë—É–¥—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é
        const tableBuilt = buildFiltersTable();
        if (!tableBuilt) {
            throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–±—É–¥—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é');
        }
        
        // 3. –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏
        const filtersPopulated = populateFilters();
        if (!filtersPopulated) {
            throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏');
        }
        
        // 4. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ñ—ñ–ª—å—Ç—Ä "–ê–∫—Ç–∏–≤–Ω–∏–π"
        const statusFilter = document.getElementById('filterStatus');
        if (statusFilter) {
            statusFilter.value = 'true'; // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ
            console.log('üìã [FIX] –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ñ—ñ–ª—å—Ç—Ä: –ê–∫—Ç–∏–≤–Ω—ñ —Ä–æ–∑–∫–ª–∞–¥–∏');
        }
        
        // 5. –ü–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        applyFilters(); // –ó–∞–º—ñ—Å—Ç—å displaySchedules() - —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞–≤—Å—è —Ñ—ñ–ª—å—Ç—Ä
        
            console.log('üéâ [FIX] –§—ñ–ª—å—Ç—Ä–∏ —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!');
        
    } catch (error) {
        console.error('‚ùå [FIX] –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:', error);
        
        // –î–æ–¥–∞—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–º–∏–ª–∫–∏
        const indicator = document.createElement('div');
        indicator.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;border-radius:5px;z-index:9999;';
        indicator.innerHTML = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        document.body.appendChild(indicator);
    }
}

// üî• –ö–†–ò–¢–ò–ß–ù–û: –ë–ª–æ–∫—É—î–º–æ —Å—Ç–∞—Ä–∏–π –∫–æ–¥ –∑ admin.js
window.scheduleFixApplied = true;

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–∞—Ç—Ä–∏–º–∫–∞ —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è —â–æ –º–∏ –∑–∞–ø—É—Å–∫–∞—î–º–æ—Å—è –ü–Ü–°–õ–Ø admin.js
        setTimeout(initializeFilters, 100);
    });
} else {
    // DOM –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
    setTimeout(initializeFilters, 100);
}

// üîß FIX: –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å —Ñ—É–Ω–∫—Ü—ñ—ó manageScheduleStudents –∑ admin.js
window.manageScheduleStudents = window.manageScheduleStudents || function(scheduleId) {
    console.log('üë• [FIX] –í–∏–∫–ª–∏–∫ manageScheduleStudents –¥–ª—è —Ä–æ–∑–∫–ª–∞–¥—É:', scheduleId);
    
    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —É—á–Ω—è–º–∏
    const modal = new bootstrap.Modal(document.getElementById('manageStudentsModal'));
    modal.show();
    
    // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –∑ admin.js —è–∫—â–æ –≤–æ–Ω–∞ —ñ—Å–Ω—É—î
    if (typeof window.originalManageScheduleStudents === 'function') {
        window.originalManageScheduleStudents(scheduleId);
    } else {
        console.warn('‚ö†Ô∏è [FIX] –§—É–Ω–∫—Ü—ñ—è manageScheduleStudents –∑ admin.js –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
        console.log('üìã [FIX] –°–ø—Ä–æ–±–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —É—á–Ω—ñ–≤ –¥–ª—è —Ä–æ–∑–∫–ª–∞–¥—É:', scheduleId);
        
        // –ë–∞–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É –ª–æ–≥—ñ–∫—É —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    }
};

console.log('üìù [FIX] –°–∫—Ä–∏–ø—Ç –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
console.log('üë• [FIX] –§—É–Ω–∫—Ü—ñ—è manageScheduleStudents –¥–æ—Å—Ç—É–ø–Ω–∞');
</script>
{% endblock %}
