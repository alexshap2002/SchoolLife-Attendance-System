{% extends "base.html" %}

{% block content %}
<!-- –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –∑–∞–º—ñ—Å—Ç—å –ø–æ–¥–≤—ñ–π–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
<div class="mt-4 pt-3"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>‚úÖ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—é</h2>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="refreshAttendance()">
            <i class="bi bi-arrow-clockwise"></i> –û–Ω–æ–≤–∏—Ç–∏
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAttendanceModal">
            <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å
        </button>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center py-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
    </div>
    <p class="mt-2 text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ...</p>
</div>

<!-- –§—ñ–ª—å—Ç—Ä–∏ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-2">
                <label for="filterDateFrom" class="form-label">–î–∞—Ç–∞ –∑</label>
                <input type="date" class="form-control" id="filterDateFrom" onchange="handleDateFromChange()">
            </div>
            <div class="col-md-2">
                <label for="filterDateTo" class="form-label">–î–∞—Ç–∞ –ø–æ</label>
                <input type="date" class="form-control" id="filterDateTo" onchange="filterAttendance()">
            </div>
            <div class="col-md-2">
                <label for="filterClub" class="form-label">–ì—É—Ä—Ç–æ–∫</label>
                <select class="form-select" id="filterClub" onchange="filterAttendance()">
                    <option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </select>
            </div>
            <div class="col-md-2">
                <label for="filterTeacher" class="form-label">–í—á–∏—Ç–µ–ª—å</label>
                <select class="form-select" id="filterTeacher" onchange="filterAttendance()">
                    <option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </select>
            </div>
            <div class="col-md-2">
                <label for="filterStatus" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" id="filterStatus" onchange="filterAttendance()">
                    <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                    <option value="PRESENT">–ü—Ä–∏—Å—É—Ç–Ω—ñ</option>
                    <option value="ABSENT">–í—ñ–¥—Å—É—Ç–Ω—ñ</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-success me-2" onclick="exportToExcel()" title="–ï–∫—Å–ø–æ—Ä—Ç –≤ Excel">
                    <i class="bi bi-download"></i> Excel
                </button>
                <button class="btn btn-secondary" onclick="resetFilters()" title="–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –º–∞—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π -->
<div class="card mb-4" id="bulkActionsPanel" style="display: none;">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <span id="selectedCount" class="text-muted">–í–∏–±—Ä–∞–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: 0</span>
            </div>
            <div class="col-md-8">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success" onclick="bulkUpdateStatus('PRESENT')">
                        <i class="bi bi-check-circle"></i> –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ–º–∏
                    </button>
                    <button type="button" class="btn btn-warning" onclick="bulkUpdateStatus('ABSENT')">
                        <i class="bi bi-x-circle"></i> –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–º–∏
                    </button>
                    <button type="button" class="btn btn-danger" onclick="bulkDelete()">
                        <i class="bi bi-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearSelection()">
                        <i class="bi bi-x"></i> –°–∫–∞—Å—É–≤–∞—Ç–∏ –≤–∏–±—ñ—Ä
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="attendanceTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th>–ì—É—Ä—Ç–æ–∫</th>
                        <th>–í—á–∏—Ç–µ–ª—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞ –≤—ñ–¥–º—ñ—Ç–∫–∏</th>
                        <th>–ß–∞—Å –≤—ñ–¥–º—ñ—Ç–∫–∏</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ</h5>
                </div>
                <div class="card-body" id="attendanceStats">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó</h5>
                </div>
                <div class="card-body" id="recentEvents">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Attendance Modal -->
<div class="modal fade" id="addAttendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAttendanceForm">
                    <div class="mb-3">
                        <label for="attendanceLessonEvent" class="form-label">–£—Ä–æ–∫ *</label>
                        <select class="form-select" id="attendanceLessonEvent" name="lessonEventId" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫</option>
                            <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="attendanceStudent" class="form-label">–°—Ç—É–¥–µ–Ω—Ç *</label>
                        <select class="form-select" id="attendanceStudent" name="studentId" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</option>
                            <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="attendanceStatus" class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                        <select class="form-select" id="attendanceStatus" name="status" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—É—Å</option>
                            <option value="PRESENT">–ü—Ä–∏—Å—É—Ç–Ω—ñ–π</option>
                            <option value="ABSENT">–í—ñ–¥—Å—É—Ç–Ω—ñ–π</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-primary" onclick="saveAttendance()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
let allAttendanceRecords = [];
let clubs = [];
let teachers = [];
let students = [];
let lessonEvents = [];

// –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function saveFiltersState() {
    const filters = {
        dateFrom: document.getElementById('filterDateFrom').value,
        dateTo: document.getElementById('filterDateTo').value,
        club: document.getElementById('filterClub').value,
        teacher: document.getElementById('filterTeacher').value,
        status: document.getElementById('filterStatus').value
    };
    localStorage.setItem('attendanceFilters', JSON.stringify(filters));
}

function restoreFiltersState() {
    const savedFilters = localStorage.getItem('attendanceFilters');
    if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        // –ù–ï –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –¥–∞—Ç–∏ - –≤–æ–Ω–∏ –∑–∞–≤–∂–¥–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å
        // document.getElementById('filterDateFrom').value = filters.dateFrom || '';
        // document.getElementById('filterDateTo').value = filters.dateTo || '';
        
        // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ —ñ–Ω—à—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
        document.getElementById('filterClub').value = filters.club || '';
        document.getElementById('filterTeacher').value = filters.teacher || '';
        document.getElementById('filterStatus').value = filters.status || '';
        
        // –ù–ï –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ - loadAllAttendanceData() —Å–∞–º –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å –¥–∞–Ω—ñ
        // setTimeout(() => filterAttendance(), 100);
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    loadAllAttendanceData();
    
    // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è —Ñ–æ—Ä–º–∏ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
    const modal = document.getElementById('addAttendanceModal');
    modal.addEventListener('hidden.bs.modal', function () {
        resetAttendanceForm();
    });
});

async function loadAllAttendanceData() {
    try {
        showLoading(true);
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –∑–∞ –û–°–¢–ê–ù–ù–Ü–ô –¢–ò–ñ–î–ï–ù–¨ (7 –¥–Ω—ñ–≤ –Ω–∞–∑–∞–¥ –¥–æ —Å—å–æ–≥–æ–¥–Ω—ñ)
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        
        const dateFrom = weekAgo.toISOString().split('T')[0];
        const dateTo = today.toISOString().split('T')[0];
        
        console.log(`üìÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å: ${dateFrom} - ${dateTo}`);
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –ø–æ–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
        document.getElementById('filterDateFrom').value = dateFrom;
        document.getElementById('filterDateTo').value = dateTo;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å
        const [attendanceData, clubsData, teachersData, studentsData, eventsData] = await Promise.all([
            apiCall(`attendance?date_from=${dateFrom}&date_to=${dateTo}`),
            apiCall('clubs'),
            apiCall('teachers'),
            apiCall('students'),
            apiCall('lesson-events')
        ]);
        
        allAttendanceRecords = attendanceData;
        clubs = clubsData;
        teachers = teachersData;
        students = studentsData;
        lessonEvents = eventsData;
        
        // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
        fillAttendanceFilters();
        
        // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω—É —Ñ–æ—Ä–º—É
        fillAttendanceForm();
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–∞–Ω—ñ
        displayAttendanceRecords(allAttendanceRecords);
        updateAttendanceStats();
        
        // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
        restoreFiltersState();
        
        showLoading(false);
    } catch (error) {
        showLoading(false);
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ:', error);
        showAlert(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ: ${error.message}`, 'danger');
    }
}

function fillAttendanceFilters() {
    // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä –≥—É—Ä—Ç–∫—ñ–≤
    fillSelectOptions('filterClub', clubs, 'id', 'name');
    
    // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä –≤—á–∏—Ç–µ–ª—ñ–≤
    fillSelectOptions('filterTeacher', teachers, 'id', 'full_name');
}

function fillAttendanceForm() {
    // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ - —Å—Ç–≤–æ—Ä—é—î–º–æ display name –∑ first_name —Ç–∞ last_name
    const studentsWithDisplayName = students.map(student => ({
        ...student,
        display_name: `${student.first_name} ${student.last_name}`
    }));
    fillSelectOptions('attendanceStudent', studentsWithDisplayName, 'id', 'display_name');
    
    // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —É—Ä–æ–∫—ñ–≤ (—Ç—ñ–ª—å–∫–∏ –Ω–µ—â–æ–¥–∞–≤–Ω—ñ)
    const recentEvents = lessonEvents.slice(0, 20); // –û—Å—Ç–∞–Ω–Ω—ñ 20 —É—Ä–æ–∫—ñ–≤
    fillSelectOptions('attendanceLessonEvent', recentEvents, 'id', 'display_name');
}

function displayAttendanceRecords(records) {
    const tbody = document.getElementById('attendanceTableBody');
    tbody.innerHTML = '';
    
    if (records.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    <i class="bi bi-calendar-x"></i><br>
                    –ó–∞–ø–∏—Å—ñ–≤ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
                </td>
            </tr>
        `;
        return;
    }
    
    records.forEach(record => {
        const row = document.createElement('tr');
        
        // –î–æ–¥–∞—î–º–æ –ø–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        row.style.cursor = 'pointer';
        row.setAttribute('title', '–ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è');
        row.addEventListener('dblclick', () => editAttendance(record.id));
        // –†–æ–∑–¥—ñ–ª—è—î–º–æ –¥–∞—Ç—É —ñ —á–∞—Å –≤—ñ–¥–º—ñ—Ç–∫–∏
        const markedDateTime = new Date(record.marked_at);
        const markedDate = markedDateTime.toLocaleDateString('uk-UA');
        const markedTime = markedDateTime.toLocaleTimeString('uk-UA', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input record-checkbox" 
                       value="${record.id}" onchange="updateBulkActions()">
            </td>
            <td>${new Date(record.lesson_event.date).toLocaleDateString('uk-UA')}</td>
            <td>${record.student.first_name} ${record.student.last_name}</td>
            <td>${record.lesson_event.club ? record.lesson_event.club.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π –≥—É—Ä—Ç–æ–∫'}</td>
            <td>${record.lesson_event.teacher ? record.lesson_event.teacher.full_name : 'N/A'}</td>
            <td>
                ${record.status === 'PRESENT' ? 
                    '<span class="badge bg-success">–ü—Ä–∏—Å—É—Ç–Ω—ñ–π</span>' : 
                    '<span class="badge bg-danger">–í—ñ–¥—Å—É—Ç–Ω—ñ–π</span>'
                }
            </td>
            <td>${markedDate}</td>
            <td>${markedTime}</td>
        `;
        tbody.appendChild(row);
    });
}

async function filterAttendance() {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    saveFiltersState();
    
    const dateFromFilter = document.getElementById('filterDateFrom').value;
    const dateToFilter = document.getElementById('filterDateTo').value;
    const clubFilter = parseInt(document.getElementById('filterClub').value);
    const teacherFilter = parseInt(document.getElementById('filterTeacher').value);
    const statusFilter = document.getElementById('filterStatus').value;
    
    console.log('üîç –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞–ø—É—â–µ–Ω–∞:', {
        dateFrom: dateFromFilter,
        dateTo: dateToFilter,
        club: clubFilter,
        teacher: teacherFilter,
        status: statusFilter,
        totalRecords: allAttendanceRecords.length
    });
    
    // –í–ê–ñ–õ–ò–í–û: –Ø–∫—â–æ –∑–º—ñ–Ω–∏–ª–∏—Å—å –¥–∞—Ç–∏ - —Ä–æ–±–∏–º–æ –Ω–æ–≤–∏–π API –∑–∞–ø–∏—Ç
    const hasDateFrom = dateFromFilter && dateFromFilter.trim() !== '';
    const hasDateTo = dateToFilter && dateToFilter.trim() !== '';
    
    if (hasDateFrom || hasDateTo) {
        try {
            showLoading(true);
            
            // –†–æ–±–∏–º–æ API –∑–∞–ø–∏—Ç –∑ –Ω–æ–≤–∏–º–∏ –¥–∞—Ç–∞–º–∏
            let url = '/api/attendance?';
            if (hasDateFrom) url += `date_from=${dateFromFilter}&`;
            if (hasDateTo) url += `date_to=${dateToFilter}&`;
            url += 'limit=10000';
            
            console.log(`üåê –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ API: ${url}`);
            const response = await fetch(url);
            if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
            
            allAttendanceRecords = await response.json();
            console.log(`‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${allAttendanceRecords.length} –∑–∞–ø–∏—Å—ñ–≤ –∑ API`);
            
            showLoading(false);
        } catch (error) {
            showLoading(false);
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
            showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: ' + error.message, 'danger');
            return;
        }
    }
    
    // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ –ø–æ —ñ–Ω—à–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
    let filteredRecords = allAttendanceRecords;
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≥—É—Ä—Ç–∫—É
    if (clubFilter) {
        const beforeFilter = filteredRecords.length;
        filteredRecords = filteredRecords.filter(record => 
            record.lesson_event.club_id === clubFilter
        );
        console.log(`üè´ –§—ñ–ª—å—Ç—Ä "–≥—É—Ä—Ç–æ–∫": ${beforeFilter} ‚Üí ${filteredRecords.length} –∑–∞–ø–∏—Å—ñ–≤`);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≤—á–∏—Ç–µ–ª—é
    if (teacherFilter) {
        const beforeFilter = filteredRecords.length;
        filteredRecords = filteredRecords.filter(record => 
            record.lesson_event.teacher_id === teacherFilter
        );
        console.log(`üë®‚Äçüè´ –§—ñ–ª—å—Ç—Ä "–≤—á–∏—Ç–µ–ª—å": ${beforeFilter} ‚Üí ${filteredRecords.length} –∑–∞–ø–∏—Å—ñ–≤`);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (statusFilter) {
        const beforeFilter = filteredRecords.length;
        filteredRecords = filteredRecords.filter(record => 
            record.status === statusFilter
        );
        console.log(`üìä –§—ñ–ª—å—Ç—Ä "—Å—Ç–∞—Ç—É—Å": ${beforeFilter} ‚Üí ${filteredRecords.length} –∑–∞–ø–∏—Å—ñ–≤`);
    }
    
    console.log(`‚úÖ –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${allAttendanceRecords.length} ‚Üí ${filteredRecords.length} –∑–∞–ø–∏—Å—ñ–≤`);
    displayAttendanceRecords(filteredRecords);
    updateAttendanceStats(filteredRecords);
}

function resetFilters() {
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterClub').value = '';
    document.getElementById('filterTeacher').value = '';
    document.getElementById('filterStatus').value = '';
    
    displayAttendanceRecords(allAttendanceRecords);
    updateAttendanceStats(allAttendanceRecords);
}

function updateAttendanceStats(records = allAttendanceRecords) {
    const total = records.length;
    const present = records.filter(r => r.status === 'PRESENT').length;
    const absent = records.filter(r => r.status === 'ABSENT').length;
    const attendanceRate = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
    
    document.getElementById('attendanceStats').innerHTML = `
        <p><strong>–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤:</strong> ${total}</p>
        <p><strong>–ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö:</strong> <span class="text-success">${present}</span></p>
        <p><strong>–í—ñ–¥—Å—É—Ç–Ω—ñ—Ö:</strong> <span class="text-danger">${absent}</span></p>
        <p><strong>–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å:</strong> <span class="badge bg-primary">${attendanceRate}%</span></p>
    `;
}

async function refreshAttendance() {
    await loadAllAttendanceData();
    showAlert('–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –¥–∞–Ω–∏—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
async function refreshAttendanceData() {
    try {
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –¥–∞–Ω—ñ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
        const attendanceData = await apiCall('attendance');
        allAttendanceRecords = attendanceData;
        
        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
        filterAttendance();
        
    } catch (error) {
        console.error('Error refreshing attendance data:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö', 'danger');
    }
}

function resetAttendanceForm() {
    const form = document.getElementById('addAttendanceForm');
    
    // –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É
    form.reset();
    
    // –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    delete form.dataset.editId;
    
    // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
    document.querySelector('#addAttendanceModal .modal-title').textContent = '–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ';
    
    // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –ø–æ–ª—è –≤–∏–±–æ—Ä—É (—è–∫—â–æ –≤–æ–Ω–∏ –±—É–ª–∏ –∑–∞–º—ñ–Ω–µ–Ω—ñ)
    const lessonEventContainer = form.querySelector('[name="lessonEventId"]')?.parentElement;
    const studentContainer = form.querySelector('[name="studentId"]')?.parentElement;
    
    if (lessonEventContainer && !lessonEventContainer.querySelector('select')) {
        lessonEventContainer.innerHTML = `
            <label for="attendanceLessonEvent" class="form-label">–£—Ä–æ–∫ *</label>
            <select class="form-select" id="attendanceLessonEvent" name="lessonEventId" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫</option>
                <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </select>
        `;
        fillSelectOptions('attendanceLessonEvent', lessonEvents.slice(0, 20), 'id', 'display_name');
    }
    
    if (studentContainer && !studentContainer.querySelector('select')) {
        studentContainer.innerHTML = `
            <label for="attendanceStudent" class="form-label">–°—Ç—É–¥–µ–Ω—Ç *</label>
            <select class="form-select" id="attendanceStudent" name="studentId" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</option>
                <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </select>
        `;
        const studentsWithDisplayName = students.map(student => ({
            ...student,
            display_name: `${student.first_name} ${student.last_name}`
        }));
        fillSelectOptions('attendanceStudent', studentsWithDisplayName, 'id', 'display_name');
    }
}

// –ü–æ–≤–Ω—ñ CRUD —Ñ—É–Ω–∫—Ü—ñ—ó
async function saveAttendance() {
    try {
        const form = document.getElementById('addAttendanceForm');
        const formData = new FormData(form);
        const editId = form.dataset.editId;
        
        const data = {
            lesson_event_id: parseInt(formData.get('lessonEventId')),
            student_id: parseInt(formData.get('studentId')),
            status: formData.get('status').toLowerCase(), // API –æ—á—ñ–∫—É—î –Ω–∏–∂–Ω—ñ–π —Ä–µ–≥—ñ—Å—Ç—Ä
            marked_by: 1  // –°–∏—Å—Ç–µ–º–Ω–∏–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä
        };
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
        if (!data.lesson_event_id || !data.student_id || !data.status) {
            showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è', 'warning');
            return;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª—é–≤–∞–Ω–Ω—è (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤)
        if (!editId) {
            const existing = allAttendanceRecords.find(record => 
                record.lesson_event_id === data.lesson_event_id && 
                record.student_id === data.student_id
            );
            if (existing) {
                showAlert('–ó–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –¥–ª—è —Ü—å–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞ —Ü—å–æ–º—É —É—Ä–æ—Ü—ñ –≤–∂–µ —ñ—Å–Ω—É—î', 'warning');
                return;
            }
        }
        
        if (editId) {
            // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ –∑–∞–ø–∏—Å—É
            await apiCall(`attendance/${editId}`, 'PUT', data);
            showAlert('–ó–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        } else {
            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É
            await apiCall('attendance', 'POST', data);
            showAlert('–ó–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –¥–æ–¥–∞–Ω–æ', 'success');
        }
        
        // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        const modal = bootstrap.Modal.getInstance(document.getElementById('addAttendanceModal'));
        modal.hide();
        
        // –û–Ω–æ–≤–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –¥–∞–Ω—ñ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ, –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
        await refreshAttendanceData();
        
        // –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É —Ç–∞ —Å–∫–∏–Ω—É—Ç–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        form.reset();
        delete form.dataset.editId;
        document.querySelector('#addAttendanceModal .modal-title').textContent = '–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ';
        
    } catch (error) {
        console.error('Error saving attendance:', error);
        if (error.message && error.message.includes('already exists')) {
            showAlert('–ó–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ –¥–ª—è —Ü—å–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞ —Ü—å–æ–º—É —É—Ä–æ—Ü—ñ –≤–∂–µ —ñ—Å–Ω—É—î', 'warning');
        } else {
            showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ', 'danger');
        }
    }
}

async function editAttendance(id) {
    try {
        const record = allAttendanceRecords.find(r => r.id === id);
        if (!record) {
            showAlert('–ó–∞–ø–∏—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'warning');
            return;
        }
        
        // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ñ–æ—Ä–º—É –¥–∞–Ω–∏–º–∏ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        document.getElementById('attendanceLessonEvent').value = record.lesson_event_id;
        document.getElementById('attendanceStudent').value = record.student_id;
        document.getElementById('attendanceStatus').value = record.status;
        
        // –í—ñ–¥–∫–ª—é—á–∏—Ç–∏ –ø–æ–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ —Ç–∞ —É—Ä–æ–∫—É –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ (—â–æ–± –Ω–µ –±—É–ª–æ –¥—É–±–ª—é–≤–∞–Ω–Ω—è)
        document.getElementById('attendanceLessonEvent').disabled = true;
        document.getElementById('attendanceStudent').disabled = true;
        
        // –î–æ–¥–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É
        const clubName = record.lesson_event.club ? record.lesson_event.club.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π –≥—É—Ä—Ç–æ–∫';
        const lessonInfo = `${clubName} - ${new Date(record.lesson_event.date).toLocaleDateString('uk-UA')}`;
        const studentInfo = `${record.student.first_name} ${record.student.last_name}`;
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —É—Ä–æ–∫ —Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞
        document.getElementById('attendanceLessonEvent').parentElement.innerHTML = `
            <label class="form-label">–£—Ä–æ–∫</label>
            <div class="form-control bg-light">${lessonInfo}</div>
            <input type="hidden" name="lessonEventId" value="${record.lesson_event_id}">
        `;
        
        document.getElementById('attendanceStudent').parentElement.innerHTML = `
            <label class="form-label">–°—Ç—É–¥–µ–Ω—Ç</label>
            <div class="form-control bg-light">${studentInfo}</div>
            <input type="hidden" name="studentId" value="${record.student_id}">
        `;
        
        // –ó–±–µ—Ä–µ–≥—Ç–∏ ID –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        document.getElementById('addAttendanceForm').dataset.editId = id;
        
        // –ó–º—ñ–Ω–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        document.querySelector('#addAttendanceModal .modal-title').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å';
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        const modal = new bootstrap.Modal(document.getElementById('addAttendanceModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error editing attendance:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è', 'danger');
    }
}

async function updateAttendance(id, data) {
    try {
        await apiCall(`attendance/${id}`, 'PUT', data);
        await refreshAttendanceData();
        showAlert('–ó–∞–ø–∏—Å –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    } catch (error) {
        console.error('Error updating attendance:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É', 'danger');
    }
}

async function deleteAttendance(id) {
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ?')) {
        return;
    }
    
    try {
        await apiCall(`attendance/${id}`, 'DELETE');
        await refreshAttendanceData();
        showAlert('–ó–∞–ø–∏—Å –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
    } catch (error) {
        console.error('Error deleting attendance:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É', 'danger');
    }
}

// –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
function exportToExcel() {
    try {
        // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ
        const currentData = getCurrentFilteredData();
        
        if (currentData.length === 0) {
            showAlert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'warning');
            return;
        }
        
        // –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è Excel
        const excelData = currentData.map(record => {
            const markedDateTime = new Date(record.marked_at);
            const markedDate = markedDateTime.toLocaleDateString('uk-UA');
            const markedTime = markedDateTime.toLocaleTimeString('uk-UA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return {
                '–î–∞—Ç–∞': new Date(record.lesson_event.date).toLocaleDateString('uk-UA'),
                '–°—Ç—É–¥–µ–Ω—Ç': `${record.student.first_name} ${record.student.last_name}`,
                '–ì—É—Ä—Ç–æ–∫': record.lesson_event.club ? record.lesson_event.club.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π –≥—É—Ä—Ç–æ–∫',
                '–í—á–∏—Ç–µ–ª—å': record.lesson_event.teacher ? record.lesson_event.teacher.full_name : 'N/A',
                '–°—Ç–∞—Ç—É—Å': record.status === 'PRESENT' ? '–ü—Ä–∏—Å—É—Ç–Ω—ñ–π' : '–í—ñ–¥—Å—É—Ç–Ω—ñ–π',
                '–î–∞—Ç–∞ –≤—ñ–¥–º—ñ—Ç–∫–∏': markedDate,
                '–ß–∞—Å –≤—ñ–¥–º—ñ—Ç–∫–∏': markedTime
            };
        });
        
        // –°—Ç–≤–æ—Ä–∏—Ç–∏ worksheet
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å');
        
        // –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —ñ–º'—è —Ñ–∞–π–ª—É –∑ –ø–æ—Ç–æ—á–Ω–æ—é –¥–∞—Ç–æ—é
        const today = new Date().toISOString().split('T')[0];
        const filename = `attendance_${today}.xlsx`;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
        XLSX.writeFile(wb, filename);
        
        showAlert('Excel —Ñ–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', 'success');
        
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É –≤ Excel. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ XLSX.', 'danger');
    }
}

function getCurrentFilteredData() {
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç—É —Å–∞–º—É –ª–æ–≥—ñ–∫—É —â–æ –π —É filterAttendance()
    const dateFromFilter = document.getElementById('filterDateFrom').value;
    const dateToFilter = document.getElementById('filterDateTo').value;
    const clubFilter = parseInt(document.getElementById('filterClub').value);
    const teacherFilter = parseInt(document.getElementById('filterTeacher').value);
    const statusFilter = document.getElementById('filterStatus').value;
    
    let filteredRecords = allAttendanceRecords;
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç (–¢–û–ß–ù–û –¢–ê –°–ê–ú–ê –õ–û–ì–Ü–ö–ê —â–æ –≤ filterAttendance)
    const hasDateFrom = dateFromFilter && dateFromFilter.trim() !== '';
    const hasDateTo = dateToFilter && dateToFilter.trim() !== '';
    
    if (hasDateFrom || hasDateTo) {
        // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –≤ Date –æ–±'—î–∫—Ç–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
        const dateFromObj = hasDateFrom ? new Date(dateFromFilter + 'T00:00:00') : null;
        const dateToObj = hasDateTo ? new Date(dateToFilter + 'T23:59:59') : null;
        
        filteredRecords = filteredRecords.filter(record => {
            const recordDateObj = new Date(record.lesson_event.date);
            
            // 1. –Ø–∫—â–æ —î "–¥–∞—Ç–∞ –≤—ñ–¥" —ñ –¥–∞—Ç–∞ –∑–∞–ø–∏—Å—É –º–µ–Ω—à–∞ - –í–Ü–î–•–ò–õ–ò–¢–ò
            if (dateFromObj && recordDateObj < dateFromObj) {
                return false;
            }
            
            // 2. –Ø–∫—â–æ —î "–¥–∞—Ç–∞ –¥–æ" —ñ –¥–∞—Ç–∞ –∑–∞–ø–∏—Å—É –±—ñ–ª—å—à–∞ - –í–Ü–î–•–ò–õ–ò–¢–ò
            if (dateToObj && recordDateObj > dateToObj) {
                return false;
            }
            
            // 3. –Ü–Ω–∞–∫—à–µ - –ü–†–ò–ô–ù–Ø–¢–ò
            return true;
        });
    }
    
    if (clubFilter) {
        filteredRecords = filteredRecords.filter(record => 
            record.lesson_event.club_id === clubFilter
        );
    }
    
    if (teacherFilter) {
        filteredRecords = filteredRecords.filter(record => 
            record.lesson_event.teacher_id === teacherFilter
        );
    }
    
    if (statusFilter) {
        filteredRecords = filteredRecords.filter(record => 
            record.status === statusFilter
        );
    }
    
    return filteredRecords;
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∑–º—ñ–Ω–∏ –ø–æ–ª—è "–î–∞—Ç–∞ –∑"
function handleDateFromChange() {
    const dateFromInput = document.getElementById('filterDateFrom');
    const dateToInput = document.getElementById('filterDateTo');
    
    // –Ø–∫—â–æ "–î–∞—Ç–∞ –∑" –∑–∞–ø–æ–≤–Ω–µ–Ω–∞, –∞ "–î–∞—Ç–∞ –ø–æ" –ø–æ—Ä–æ–∂–Ω—è, –∑–∞–ø–æ–≤–Ω—é—î–º–æ "–î–∞—Ç–∞ –ø–æ" —Ç—ñ—î—é –∂ –¥–∞—Ç–æ—é
    if (dateFromInput.value && !dateToInput.value) {
        dateToInput.value = dateFromInput.value;
        console.log(`üìÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ "–î–∞—Ç–∞ –ø–æ": ${dateToInput.value}`);
    }
    
    // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é
    filterAttendance();
}

// –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –º–∞—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const recordCheckboxes = document.querySelectorAll('.record-checkbox');
    
    recordCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
    const selectedCount = selectedCheckboxes.length;
    const bulkPanel = document.getElementById('bulkActionsPanel');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    selectedCountSpan.textContent = `–í–∏–±—Ä–∞–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: ${selectedCount}`;
    
    if (selectedCount > 0) {
        bulkPanel.style.display = 'block';
    } else {
        bulkPanel.style.display = 'none';
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω "–≤–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ"
    const allCheckboxes = document.querySelectorAll('.record-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (selectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === allCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function getSelectedIds() {
    const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
    return Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
}

function clearSelection() {
    document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateBulkActions();
}

async function bulkUpdateStatus(newStatus) {
    const selectedIds = getSelectedIds();
    
    if (selectedIds.length === 0) {
        showAlert('–û–±–µ—Ä—ñ—Ç—å –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è', 'warning');
        return;
    }
    
    const statusText = newStatus === 'PRESENT' ? '–ø—Ä–∏—Å—É—Ç–Ω—ñ–º–∏' : '–≤—ñ–¥—Å—É—Ç–Ω—ñ–º–∏';
    if (!confirm(`–ü–æ–∑–Ω–∞—á–∏—Ç–∏ ${selectedIds.length} –∑–∞–ø–∏—Å—ñ–≤ —è–∫ ${statusText}?`)) {
        return;
    }
    
    try {
        showLoading(true);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Å
        const promises = selectedIds.map(id => 
            apiCall(`attendance/${id}`, 'PUT', { status: newStatus.toLowerCase() })
        );
        
        await Promise.all(promises);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
        await refreshAttendanceData();
        clearSelection();
        
        showAlert(`${selectedIds.length} –∑–∞–ø–∏—Å—ñ–≤ –æ–Ω–æ–≤–ª–µ–Ω–æ —è–∫ ${statusText}`, 'success');
        showLoading(false);
        
    } catch (error) {
        console.error('Error bulk updating:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –º–∞—Å–æ–≤–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è', 'danger');
        showLoading(false);
    }
}

async function bulkDelete() {
    const selectedIds = getSelectedIds();
    
    if (selectedIds.length === 0) {
        showAlert('–û–±–µ—Ä—ñ—Ç—å –∑–∞–ø–∏—Å–∏ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è', 'warning');
        return;
    }
    
    if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ ${selectedIds.length} –∑–∞–ø–∏—Å—ñ–≤ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.`)) {
        return;
    }
    
    try {
        showLoading(true);
        
        // –í–∏–¥–∞–ª—è—î–º–æ –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Å
        const promises = selectedIds.map(id => 
            apiCall(`attendance/${id}`, 'DELETE')
        );
        
        await Promise.all(promises);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
        await refreshAttendanceData();
        clearSelection();
        
        showAlert(`${selectedIds.length} –∑–∞–ø–∏—Å—ñ–≤ –≤–∏–¥–∞–ª–µ–Ω–æ`, 'success');
        showLoading(false);
        
    } catch (error) {
        console.error('Error bulk deleting:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –º–∞—Å–æ–≤–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è', 'danger');
        showLoading(false);
    }
}
</script>
{% endblock %}
