{% extends "base.html" %}

{% block content %}
<style>
/* –°—Ç–∏–ª—ñ –∑–∞—Ä–ø–ª–∞—Ç –≤ —Å—Ç–∏–ª—ñ —ñ–Ω—à–∏—Ö —Ç–∞–±–ª–∏—Ü—å */
#payrollTable {
    margin-top: 20px;
}

/* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
#payrollTable th:nth-child(1), #payrollTable td:nth-child(1) { min-width: 120px; } /* –î–∞—Ç–∞ */
#payrollTable th:nth-child(2), #payrollTable td:nth-child(2) { min-width: 150px; } /* –í—á–∏—Ç–µ–ª—å */
#payrollTable th:nth-child(3), #payrollTable td:nth-child(3) { min-width: 120px; } /* –ì—É—Ä—Ç–æ–∫ */
#payrollTable th:nth-child(4), #payrollTable td:nth-child(4) { min-width: 100px; } /* –û—Å–Ω–æ–≤–∞ */
#payrollTable th:nth-child(5), #payrollTable td:nth-child(5) { min-width: 100px; } /* –°—É–º–∞ */
#payrollTable th:nth-child(6), #payrollTable td:nth-child(6) { min-width: 200px; } /* –ü—Ä–∏–º—ñ—Ç–∫–∞ */
#payrollTable th:nth-child(7), #payrollTable td:nth-child(7) { min-width: 80px; }  /* –î—ñ—ó */

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑ —è—Å–∫—Ä–∞–≤–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤ */
#payrollTable thead th {
    white-space: nowrap;
    padding: 12px 8px;
}

/* –§—ñ–ª—å—Ç—Ä–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ */
#payrollTable .filter-row td {
    padding: 8px 6px;
}

#payrollTable .filter-input,
#payrollTable .filter-select {
    font-size: 0.85rem;
    padding: 4px 8px;
    min-width: 90px;
}

/* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
#payrollTable .btn-group .btn {
    margin: 0 1px;
    padding: 4px 8px;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.stats-card {
    margin-top: 20px;
}
</style>

<!-- –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –∑–∞–º—ñ—Å—Ç—å –ø–æ–¥–≤—ñ–π–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
<div class="mt-4 pt-3"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üí∞ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–æ—é</h2>
    <div class="btn-group">
        <button type="button" class="btn btn-success" onclick="openAddPayrollModal()">
            <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="exportCurrentData()">
            <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç
        </button>
        <button type="button" class="btn btn-primary" onclick="openCalculateModal()">
            <i class="bi bi-calculator"></i> –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É
        </button>
    </div>
</div>

<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="payrollTable">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–í—á–∏—Ç–µ–ª—å</th>
                        <th>–ì—É—Ä—Ç–æ–∫</th>
                        <th>–û—Å–Ω–æ–≤–∞</th>
                        <th>–°—É–º–∞</th>
                        <th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                    <!-- –†—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
                    <tr class="filter-row">
                        <td>
                            <input type="date" class="form-control form-control-sm filter-input" id="filterDate" 
                                   onchange="filterPayroll()">
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterTeacher" onchange="filterPayroll()">
                                <option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterClub" onchange="filterPayroll()">
                                <option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm filter-select" id="filterBasis" onchange="filterPayroll()">
                                <option value="">–í—Å—ñ –æ—Å–Ω–æ–≤–∏</option>
                                <option value="AUTO">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</option>
                                <option value="MANUAL">–í—Ä—É—á–Ω—É</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm filter-input" id="filterAmount" 
                                   placeholder="–°—É–º–∞ –≤—ñ–¥..." min="0" step="0.01" onkeyup="filterPayroll()">
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm filter-input" id="filterNote" 
                                   placeholder="–ü–æ—à—É–∫ –≤ –ø—Ä–∏–º—ñ—Ç–∫–∞—Ö..." onkeyup="filterPayroll()">
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetPayrollFilters()" title="–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏">
                                <i class="bi bi-x-circle"></i>
                                </button>
                        </td>
                    </tr>
                </thead>
                <tbody id="payrollTableBody">
                    <!-- –î–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="stats-card">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                </div>
                <div class="card-body" id="payrollStats">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–ü–æ –≤—á–∏—Ç–µ–ª—è—Ö</h5>
                </div>
                <div class="card-body" id="payrollByTeachers">
                    <!-- –î–∞–Ω—ñ –ø–æ –≤—á–∏—Ç–µ–ª—è—Ö –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–∞—Ä–ø–ª–∞—Ç–∏ -->
<div class="modal fade" id="addPayrollModal" tabindex="-1" aria-labelledby="addPayrollModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPayrollModalLabel">
                    <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –∑–∞—Ä–ø–ª–∞—Ç—É
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>–í–∞–∂–ª–∏–≤–æ:</strong> –ó–∞—Ä–ø–ª–∞—Ç–∞ –û–ë–û–í'–Ø–ó–ö–û–í–û –º–∞—î –±—É—Ç–∏ –ø—Ä–∏–≤'—è–∑–∞–Ω–∞ –¥–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ–≥–æ —É—Ä–æ–∫—É. 
                    –û–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫ –∑—ñ —Å–ø–∏—Å–∫—É –Ω–∏–∂—á–µ.
                </div>
                <form id="addPayrollForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addTeacherId" class="form-label">–í—á–∏—Ç–µ–ª—å *</label>
                                <select class="form-select" id="addTeacherId" required>
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addLessonEventId" class="form-label">–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–π —É—Ä–æ–∫ *</label>
                                <select class="form-select" id="addLessonEventId" required>
                                    <option value="">‚ö†Ô∏è –û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–π —É—Ä–æ–∫ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</option>
                                </select>
                                <div class="form-text">–ü–æ–∫–∞–∑—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —É—Ä–æ–∫–∏ –±–µ–∑ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ—ó –∑–∞—Ä–ø–ª–∞—Ç–∏</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addBasis" class="form-label">–û—Å–Ω–æ–≤–∞ *</label>
                                <select class="form-select" id="addBasis" required>
                                    <option value="MANUAL">–†—É—á–Ω–µ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</option>
                                    <option value="AUTO">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addAmount" class="form-label">–°—É–º–∞ (‚Ç¥) *</label>
                                <input type="number" class="form-control" id="addAmount" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addNote" class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
                        <textarea class="form-control" id="addNote" rows="3" placeholder="–û–ø–∏—Å –∞–±–æ –∫–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-success" onclick="saveNewPayroll()">
                    <i class="bi bi-check-lg"></i> –î–æ–¥–∞—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏ -->
<div class="modal fade" id="editPayrollModal" tabindex="-1" aria-labelledby="editPayrollModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPayrollModalLabel">
                    <i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPayrollForm">
                    <input type="hidden" id="editPayrollId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTeacherId" class="form-label">–í—á–∏—Ç–µ–ª—å *</label>
                                <select class="form-select" id="editTeacherId" required>
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLessonEventId" class="form-label">–£—Ä–æ–∫ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                                <select class="form-select" id="editLessonEventId">
                                    <option value="">–ë–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏ –¥–æ —É—Ä–æ–∫—É</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editBasis" class="form-label">–û—Å–Ω–æ–≤–∞ *</label>
                                <select class="form-select" id="editBasis" required>
                                    <option value="MANUAL">–†—É—á–Ω–µ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</option>
                                    <option value="AUTO">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAmount" class="form-label">–°—É–º–∞ (‚Ç¥) *</label>
                                <input type="number" class="form-control" id="editAmount" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNote" class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
                        <textarea class="form-control" id="editNote" rows="3" placeholder="–û–ø–∏—Å –∞–±–æ –∫–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-warning" onclick="updatePayroll()">
                    <i class="bi bi-check-lg"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞—Ä–ø–ª–∞—Ç–∏ -->
<div class="modal fade" id="calculatePayrollModal" tabindex="-1" aria-labelledby="calculatePayrollModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calculatePayrollModalLabel">
                    <i class="bi bi-calculator"></i> –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–∞—Ä–ø–ª–∞—Ç—É
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="calcDateFrom" class="form-label">–î–∞—Ç–∞ –≤—ñ–¥</label>
                        <input type="date" class="form-control" id="calcDateFrom">
                    </div>
                    <div class="col-md-4">
                        <label for="calcDateTo" class="form-label">–î–∞—Ç–∞ –¥–æ</label>
                        <input type="date" class="form-control" id="calcDateTo">
                    </div>
                    <div class="col-md-4">
                        <label for="calcTeacher" class="form-label">–í—á–∏—Ç–µ–ª—å</label>
                        <select class="form-select" id="calcTeacher">
                            <option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="calcClub" class="form-label">–ì—É—Ä—Ç–æ–∫</label>
                        <select class="form-select" id="calcClub">
                            <option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="calcBasis" class="form-label">–û—Å–Ω–æ–≤–∞</label>
                        <select class="form-select" id="calcBasis">
                            <option value="">–í—Å—ñ –æ—Å–Ω–æ–≤–∏</option>
                            <option value="AUTO">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</option>
                            <option value="MANUAL">–í—Ä—É—á–Ω—É</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary me-2" onclick="calculateSalary()">
                            <i class="bi bi-search"></i> –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetCalculation()">
                            <i class="bi bi-arrow-clockwise"></i> –°–∫–∏–Ω—É—Ç–∏
                        </button>
                    </div>
                </div>
                
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É -->
                <div id="calculationResults" style="display: none;">
                    <h6 class="mb-3">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É:</h6>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-primary" id="calcTotalRecords">0</h5>
                                    <p class="card-text">–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-success" id="calcTotalAmount">0 ‚Ç¥</h5>
                                    <p class="card-text">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-info" id="calcAutoCount">0</h5>
                                    <p class="card-text">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏—Ö</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                <div class="card-body">
                                    <h5 class="card-title text-warning" id="calcManualCount">0</h5>
                                    <p class="card-text">–†—É—á–Ω–∏—Ö</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –¢–∞–±–ª–∏—Ü—è –¥–µ—Ç–∞–ª–µ–π -->
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–í—á–∏—Ç–µ–ª—å</th>
                                    <th>–ì—É—Ä—Ç–æ–∫</th>
                                    <th>–û—Å–Ω–æ–≤–∞</th>
                                    <th>–°—É–º–∞</th>
                                    <th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
                                </tr>
                            </thead>
                            <tbody id="calculationTableBody">
                            </tbody>
                        </table>
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="exportCalculationBtn" style="display: none;" onclick="exportCalculation()">
                    <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
let allPayrollRecords = [];
let allTeachers = [];
let allClubs = [];

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö
async function loadAllPayrollData() {
    try {
        showLoading(true);
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –∑–∞ –ü–û–¢–û–ß–ù–ò–ô –ú–Ü–°–Ø–¶–¨ (–∑ 1-–≥–æ —á–∏—Å–ª–∞ –¥–æ –∫—ñ–Ω—Ü—è –º—ñ—Å—è—Ü—è)
        // –í–ê–ñ–õ–ò–í–û: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ UTC –¥–∞—Ç–∏, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø—Ä–æ–±–ª–µ–º –∑ —á–∞—Å–æ–≤–∏–º–∏ –∑–æ–Ω–∞–º–∏
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1; // getMonth() returns 0-11, –Ω–∞–º —Ç—Ä–µ–±–∞ 1-12
        
        // –§–æ—Ä–º—É—î–º–æ –¥–∞—Ç–∏ –Ω–∞–ø—Ä—è–º—É –≤ —Ñ–æ—Ä–º–∞—Ç—ñ YYYY-MM-DD –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Date –æ–±'—î–∫—Ç
        const dateFrom = `${year}-${String(month).padStart(2, '0')}-01`;
        const lastDay = new Date(year, month, 0).getDate(); // –û—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å –º—ñ—Å—è—Ü—è
        const dateTo = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å
        const [payrollResponse, teachersResponse, clubsResponse] = await Promise.all([
            fetch(`/api/payroll?date_from=${dateFrom}&date_to=${dateTo}&limit=10000`),
            fetch('/api/teachers'),
            fetch('/api/clubs')
        ]);
        
        if (!payrollResponse.ok || !teachersResponse.ok || !clubsResponse.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
        }
        
        allPayrollRecords = await payrollResponse.json();
        allTeachers = await teachersResponse.json();
        allClubs = await clubsResponse.json();
        
        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏
        fillPayrollFilters();
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ
        displayPayroll(allPayrollRecords);
        updatePayrollStats(allPayrollRecords);
        
        showLoading(false);
    } catch (error) {
        showLoading(false);
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑–∞—Ä–ø–ª–∞—Ç:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑–∞—Ä–ø–ª–∞—Ç', 'danger');
    }
}

// –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function fillPayrollFilters() {
    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—É –≤—á–∏—Ç–µ–ª—ñ–≤
    const filterTeacher = document.getElementById('filterTeacher');
    filterTeacher.innerHTML = '<option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>';
    
    allTeachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.full_name;
        filterTeacher.appendChild(option);
    });
    
    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—É –≥—É—Ä—Ç–∫—ñ–≤
    const filterClub = document.getElementById('filterClub');
    filterClub.innerHTML = '<option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>';
    
    allClubs.forEach(club => {
        const option = document.createElement('option');
        option.value = club.id;
        option.textContent = club.name;
        filterClub.appendChild(option);
    });
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç
function displayPayroll(payrollRecords) {
    const tableBody = document.getElementById('payrollTableBody');
    
    if (payrollRecords.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="bi bi-currency-dollar"></i><br>
                    –ó–∞–ø–∏—Å—ñ–≤ –ø—Ä–æ –∑–∞—Ä–ø–ª–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–¥–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏
                </td>
            </tr>`;
        return;
    }
    
    let bodyHTML = '';
    
    payrollRecords.forEach(payroll => {
        const teacherName = payroll.teacher_name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
        
        // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏ (API —Ç–µ–ø–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î lesson_date –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ)
        const lessonDate = payroll.lesson_date
            ? new Date(payroll.lesson_date).toLocaleDateString('uk-UA')
            : '-';
        
        // –ù–∞–∑–≤–∞ –≥—É—Ä—Ç–∫–∞ (API —Ç–µ–ø–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î club_name –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ)
        const clubName = payroll.club_name || '-';
        
        // HTML –¥–ª—è —Ä—è–¥–∫–∞
        bodyHTML += `
            <tr>
                <td>${lessonDate}</td>
                <td><strong>${teacherName}</strong></td>
                <td>${clubName}</td>
                <td>
                    ${payroll.basis === 'AUTO' 
                        ? '<span class="badge bg-success">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</span>' 
                        : '<span class="badge bg-warning">–í—Ä—É—á–Ω—É</span>'}
                </td>
                <td><strong class="text-success">${payroll.amount_decimal} ‚Ç¥</strong></td>
                <td><small>${payroll.note || '-'}</small></td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-warning"
                                onclick="editPayroll(${payroll.id})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                onclick="deletePayroll(${payroll.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
    });
    
    tableBody.innerHTML = bodyHTML;
}

// –§—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç
function filterPayroll() {
    const dateFilter = document.getElementById('filterDate').value;
    const teacherFilter = parseInt(document.getElementById('filterTeacher').value);
    const clubFilter = parseInt(document.getElementById('filterClub').value);
    const basisFilter = document.getElementById('filterBasis').value;
    const amountFilter = parseFloat(document.getElementById('filterAmount').value);
    const noteFilter = document.getElementById('filterNote').value.toLowerCase();
    
    let filteredRecords = allPayrollRecords;
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ
    if (dateFilter) {
        const filterDate = new Date(dateFilter);
        filteredRecords = filteredRecords.filter(record => {
            if (!record.lesson_date) return false;
            const recordDate = new Date(record.lesson_date);
            return recordDate.toDateString() === filterDate.toDateString();
        });
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≤—á–∏—Ç–µ–ª—é
    if (teacherFilter) {
        filteredRecords = filteredRecords.filter(record => record.teacher_id === teacherFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –≥—É—Ä—Ç–∫—É
    if (clubFilter) {
        filteredRecords = filteredRecords.filter(record => {
            // club_name –≤–∂–µ —î –≤ record –Ω–∞–ø—Ä—è–º—É –≤—ñ–¥ API
            const club = allClubs.find(c => c.name === record.club_name);
            return club && club.id === clubFilter;
        });
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –æ—Å–Ω–æ–≤—ñ
    if (basisFilter) {
        filteredRecords = filteredRecords.filter(record => record.basis === basisFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—É–º—ñ (–≤—ñ–¥ –∑–∞–¥–∞–Ω–æ—ó —Å—É–º–∏ —ñ –≤–∏—â–µ)
    if (!isNaN(amountFilter)) {
        filteredRecords = filteredRecords.filter(record => parseFloat(record.amount_decimal) >= amountFilter);
    }
    
    // –§—ñ–ª—å—Ç—Ä –ø–æ –ø—Ä–∏–º—ñ—Ç—Ü—ñ
    if (noteFilter) {
        filteredRecords = filteredRecords.filter(record => {
            const note = (record.note || '').toLowerCase();
            return note.includes(noteFilter);
        });
    }
    
    displayPayroll(filteredRecords);
    updatePayrollStats(filteredRecords);
}

// –°–∫–∏–¥–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function resetPayrollFilters() {
    document.getElementById('filterDate').value = '';
    document.getElementById('filterTeacher').value = '';
    document.getElementById('filterClub').value = '';
    document.getElementById('filterBasis').value = '';
    document.getElementById('filterAmount').value = '';
    document.getElementById('filterNote').value = '';
    
    displayPayroll(allPayrollRecords);
    updatePayrollStats(allPayrollRecords);
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updatePayrollStats(records = allPayrollRecords) {
    const total = records.length;
    const totalAmount = records.reduce((sum, record) => sum + parseFloat(record.amount_decimal), 0);
    const autoCount = records.filter(r => r.basis === 'AUTO').length;
    const manualCount = records.filter(r => r.basis === 'MANUAL').length;
    
    document.getElementById('payrollStats').innerHTML = `
        <p><strong>–í—Å—å–æ–≥–æ –≤–∏–ø–ª–∞—Ç:</strong> ${total}</p>
        <p><strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</strong> ${totalAmount.toFixed(2)} ‚Ç¥</p>
        <p><strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏—Ö:</strong> ${autoCount}</p>
        <p><strong>–†—É—á–Ω–∏—Ö:</strong> ${manualCount}</p>
    `;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—á–∏—Ç–µ–ª—è—Ö
    const teachersPayroll = {};
    records.forEach(record => {
        const teacher = allTeachers.find(t => t.id === record.teacher_id);
        if (teacher) {
            const teacherName = teacher.full_name;
            teachersPayroll[teacherName] = (teachersPayroll[teacherName] || 0) + parseFloat(record.amount_decimal);
        }
    });
    
    let teachersHTML = '';
    
    // –°–æ—Ä—Ç—É—î–º–æ –ø–æ —Å—É–º—ñ (–≤—ñ–¥ –±—ñ–ª—å—à–æ—ó –¥–æ –º–µ–Ω—à–æ—ó)
    const sortedTeachers = Object.entries(teachersPayroll).sort((a, b) => b[1] - a[1]);
    
    for (const [teacherName, amount] of sortedTeachers) {
        teachersHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${teacherName}</span>
                <span class="badge bg-success">${amount.toFixed(2)} ‚Ç¥</span>
            </div>
        `;
    }
    
    // –î–æ–¥–∞—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É —Å—É–º—É –≤–Ω–∏–∑—É
    if (sortedTeachers.length > 0) {
        teachersHTML += `
            <hr>
            <div class="d-flex justify-content-between align-items-center">
                <strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</strong>
                <strong class="text-primary">${totalAmount.toFixed(2)} ‚Ç¥</strong>
            </div>
        `;
    }
    
    if (teachersHTML === '') {
        teachersHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</p>';
    }
    
    document.getElementById('payrollByTeachers').innerHTML = teachersHTML;
}

// –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
function openAddPayrollModal() {
    console.log('üöÄ PAYROLL DEBUG: –í—ñ–¥–∫—Ä–∏–≤–∞—é –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑–∞—Ä–ø–ª–∞—Ç–∏');
    fillTeacherSelects();
    fillLessonEventSelects();
    document.getElementById('addPayrollForm').reset();
    new bootstrap.Modal(document.getElementById('addPayrollModal')).show();
    console.log('‚úÖ PAYROLL DEBUG: –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ');
}

function openCalculateModal() {
    fillCalculationSelects();
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–∞—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º (–ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å)
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    document.getElementById('calcDateFrom').value = firstDay.toISOString().split('T')[0];
    document.getElementById('calcDateTo').value = lastDay.toISOString().split('T')[0];
    document.getElementById('calculationResults').style.display = 'none';
    new bootstrap.Modal(document.getElementById('calculatePayrollModal')).show();
}

// –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–µ–ª–µ–∫—Ç—ñ–≤
function fillTeacherSelects() {
    const selects = ['addTeacherId', 'editTeacherId'];
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>';
        allTeachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = teacher.full_name;
            select.appendChild(option);
        });
        
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ –≤—á–∏—Ç–µ–ª—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤
        select.addEventListener('change', function() {
            const teacherId = this.value ? parseInt(this.value) : null;
            console.log(`üéØ PAYROLL DEBUG: –í—á–∏—Ç–µ–ª—å –∑–º—ñ–Ω–∏–≤—Å—è –Ω–∞ ID=${teacherId} (${this.selectedOptions[0]?.text})`);
            fillLessonEventSelects(teacherId);
        });
    });
}

function fillCalculationSelects() {
    // –í—á–∏—Ç–µ–ª—ñ
    const teacherSelect = document.getElementById('calcTeacher');
    teacherSelect.innerHTML = '<option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>';
    allTeachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.full_name;
        teacherSelect.appendChild(option);
    });
    
    // –ì—É—Ä—Ç–∫–∏
    const clubSelect = document.getElementById('calcClub');
    clubSelect.innerHTML = '<option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>';
    allClubs.forEach(club => {
        const option = document.createElement('option');
        option.value = club.id;
        option.textContent = club.name;
        clubSelect.appendChild(option);
    });
}

async function fillLessonEventSelects(teacherId = null) {
    try {
        // –ó–ê–í–ê–ù–¢–ê–ñ–£–Ñ–ú–û –ü–†–û–í–ï–î–ï–ù–Ü –£–†–û–ö–ò –ë–ï–ó –ù–ê–†–ê–•–û–í–ê–ù–û–á –ó–ê–†–ü–õ–ê–¢–ò
        let url = '/api/conducted_lessons?only_uncalculated=true&limit=100';
        if (teacherId) {
            url += `&teacher_id=${teacherId}`;
        }
        
        console.log(`üîç PAYROLL DEBUG: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é —É—Ä–æ–∫–∏ –¥–ª—è teacherId=${teacherId}, URL=${url}`);
        
        const response = await fetch(url);
        if (!response.ok) {
            console.error(`‚ùå PAYROLL ERROR: HTTP ${response.status} for ${url}`);
            return;
        }
        const conductedLessons = await response.json();
        
        console.log(`üìö PAYROLL DEBUG: –û—Ç—Ä–∏–º–∞–Ω–æ ${conductedLessons.length} —É—Ä–æ–∫—ñ–≤:`, conductedLessons);
        const selects = ['addLessonEventId', 'editLessonEventId'];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (teacherId) {
                select.innerHTML = '<option value="">‚ö†Ô∏è –û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–π —É—Ä–æ–∫ (–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)</option>';
            } else {
                select.innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>';
            }
            
            if (!teacherId) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            // –°–æ—Ä—Ç—É—î–º–æ –ø–æ –¥–∞—Ç—ñ (–Ω–æ–≤—ñ—à—ñ –∑–≤–µ—Ä—Ö—É)
            conductedLessons.sort((a, b) => new Date(b.lesson_date) - new Date(a.lesson_date));
            
            conductedLessons.forEach(lesson => {
                const lessonDate = new Date(lesson.lesson_date).toLocaleDateString('uk-UA', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const option = document.createElement('option');
                option.value = lesson.lesson_event_id; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ lesson_event_id –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
                option.setAttribute('data-conducted-lesson-id', lesson.id); // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
                option.textContent = `${lesson.club_name} - ${lessonDate} (${lesson.present_students}/${lesson.total_students} —É—á–Ω—ñ–≤)`;
                select.appendChild(option);
                
                console.log(`‚ûï PAYROLL DEBUG: –î–æ–¥–∞–≤ —É—Ä–æ–∫ –≤ —Å–µ–ª–µ–∫—Ç ${selectId}: ${option.textContent}`);
            });
            
            if (conductedLessons.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤';
                option.disabled = true;
                select.appendChild(option);
            }
        });
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤:', error);
    }
}

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏
function editPayroll(id) {
    const payroll = allPayrollRecords.find(p => p.id === id);
    if (!payroll) {
        showAlert('–ó–∞–ø–∏—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'danger');
        return;
    }
    
    fillTeacherSelects();
    fillLessonEventSelects();
    
    document.getElementById('editPayrollId').value = payroll.id;
    document.getElementById('editTeacherId').value = payroll.teacher_id;
    document.getElementById('editLessonEventId').value = payroll.lesson_event_id || '';
    document.getElementById('editBasis').value = payroll.basis;
    document.getElementById('editAmount').value = payroll.amount_decimal;
    document.getElementById('editNote').value = payroll.note || '';
    
    new bootstrap.Modal(document.getElementById('editPayrollModal')).show();
}

// –§—É–Ω–∫—Ü—ñ—ó –¥–æ–ø–æ–º—ñ–∂–Ω—ñ
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function showLoading(show = true) {
    let spinner = document.getElementById('loadingSpinner');
    if (!spinner && show) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></div>';
        spinner.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;';
        document.body.appendChild(spinner);
    }
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–∞—Ä–ø–ª–∞—Ç–∏
async function saveNewPayroll() {
    const lessonEventId = document.getElementById('addLessonEventId').value;
    const teacherId = parseInt(document.getElementById('addTeacherId').value);
    const basis = document.getElementById('addBasis').value;
    const amount = parseFloat(document.getElementById('addAmount').value);
    
    // –û–ë–û–í'–Ø–ó–ö–û–í–ê –ü–ï–†–ï–í–Ü–†–ö–ê –ü–†–ò–í'–Ø–ó–ö–ò –î–û –£–†–û–ö–£
    if (!lessonEventId) {
        showAlert('‚ö†Ô∏è –û–±–æ–≤\'—è–∑–∫–æ–≤–æ –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–π —É—Ä–æ–∫ –¥–ª—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏!', 'danger');
        return;
    }
    
    if (!teacherId || !basis || !amount) {
        showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è', 'danger');
        return;
    }
    
    const formData = {
        teacher_id: teacherId,
        lesson_event_id: lessonEventId,
        basis: basis,
        amount_decimal: amount,
        note: document.getElementById('addNote').value || null
    };
    
    try {
        const response = await fetch('/api/payroll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏');
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
        await loadAllPayrollData();
        bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
        showAlert('–ó–∞—Ä–ø–ª–∞—Ç—É —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ', 'success');
        
    } catch (error) {
        showAlert(error.message, 'danger');
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏
async function updatePayroll() {
    const payrollId = parseInt(document.getElementById('editPayrollId').value);
    const formData = {
        teacher_id: parseInt(document.getElementById('editTeacherId').value),
        basis: document.getElementById('editBasis').value,
        amount_decimal: parseFloat(document.getElementById('editAmount').value),
        note: document.getElementById('editNote').value || null
    };
    
    if (!formData.teacher_id || !formData.basis || !formData.amount_decimal) {
        showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è', 'danger');
        return;
    }
    
    try {
        const response = await fetch(`/api/payroll/${payrollId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏');
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
        await loadAllPayrollData();
        bootstrap.Modal.getInstance(document.getElementById('editPayrollModal')).hide();
        showAlert('–ó–∞—Ä–ø–ª–∞—Ç—É —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        
    } catch (error) {
        showAlert(error.message, 'danger');
    }
}

// –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏
async function deletePayroll(id) {
    const payroll = allPayrollRecords.find(p => p.id === id);
    if (!payroll) {
        showAlert('–ó–∞–ø–∏—Å –ø—Ä–æ –∑–∞—Ä–ø–ª–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'danger');
        return;
    }
    
    const teacher = allTeachers.find(t => t.id === payroll.teacher_id);
    const teacherName = teacher ? teacher.full_name : '–ù–µ–≤—ñ–¥–æ–º–∏–π –≤—á–∏—Ç–µ–ª—å';
    const amount = payroll.amount_decimal;
    
    if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å –ø—Ä–æ –∑–∞—Ä–ø–ª–∞—Ç—É?\n\n–í—á–∏—Ç–µ–ª—å: ${teacherName}\n–°—É–º–∞: ${amount} ‚Ç¥\n\n–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏!`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/payroll/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏');
        }
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
        await loadAllPayrollData();
        showAlert(`–ó–∞—Ä–ø–ª–∞—Ç—É –¥–ª—è ${teacherName} (${amount} ‚Ç¥) —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ`, 'success');
        
    } catch (error) {
        showAlert(error.message, 'danger');
    }
}

// –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞—Ä–ø–ª–∞—Ç–∏ (–∑ –æ–∫—Ä–µ–º–∏–º API –∑–∞–ø–∏—Ç–æ–º)
async function calculateSalary() {
    const dateFrom = document.getElementById('calcDateFrom').value;
    const dateTo = document.getElementById('calcDateTo').value;
    const teacherId = parseInt(document.getElementById('calcTeacher').value);
    const clubId = parseInt(document.getElementById('calcClub').value);
    const basis = document.getElementById('calcBasis').value;
    
    try {
        showLoading(true);
        
        // –ë—É–¥—É—î–º–æ URL –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
        let url = '/api/payroll?limit=10000';
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        if (teacherId) url += `&teacher_id=${teacherId}`;
        if (basis) url += `&basis=${basis}`;
        
        // –†–æ–±–∏–º–æ –æ–∫—Ä–µ–º–∏–π –∑–∞–ø–∏—Ç –¥–æ API –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
        const response = await fetch(url);
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É');
        
        let filteredRecords = await response.json();
        
        // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ñ—ñ–ª—å—Ç—Ä –ø–æ –≥—É—Ä—Ç–∫—É (–∫–ª—ñ—î–Ω—Ç—Å—å–∫–∞ —Å—Ç–æ—Ä–æ–Ω–∞, –±–æ API –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î)
        if (clubId) {
            filteredRecords = filteredRecords.filter(r => {
                const club = allClubs.find(c => c.name === r.club_name);
                return club && club.id === clubId;
            });
        }
        
        displayCalculationResults(filteredRecords);
        window.calculationData = filteredRecords;
        
        showLoading(false);
    } catch (error) {
        showLoading(false);
        console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞—Ä–ø–ª–∞—Ç–∏:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞—Ä–ø–ª–∞—Ç–∏: ' + error.message, 'danger');
    }
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É
function displayCalculationResults(records) {
    const total = records.length;
    const totalAmount = records.reduce((sum, r) => sum + parseFloat(r.amount_decimal), 0);
    const autoCount = records.filter(r => r.basis === 'AUTO').length;
    const manualCount = records.filter(r => r.basis === 'MANUAL').length;
    
    document.getElementById('calcTotalRecords').textContent = total;
    document.getElementById('calcTotalAmount').textContent = `${totalAmount.toFixed(2)} ‚Ç¥`;
    document.getElementById('calcAutoCount').textContent = autoCount;
    document.getElementById('calcManualCount').textContent = manualCount;
    
    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é
    const tableBody = document.getElementById('calculationTableBody');
    let bodyHTML = '';
    
    records.forEach(record => {
        const teacher = allTeachers.find(t => t.id === record.teacher_id);
        const lessonDate = record.lesson_date 
            ? new Date(record.lesson_date).toLocaleDateString('uk-UA') : '-';
        const club = record.club_name 
            ? allClubs.find(c => c.name === record.club_name) : null;
        
        bodyHTML += `
            <tr>
                <td>${lessonDate}</td>
                <td>${teacher ? teacher.full_name : 'N/A'}</td>
                <td>${club ? club.name : '-'}</td>
                <td>${record.basis === 'AUTO' ? '<span class="badge bg-success">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</span>' : '<span class="badge bg-warning">–í—Ä—É—á–Ω—É</span>'}</td>
                <td><strong>${record.amount_decimal} ‚Ç¥</strong></td>
                <td>${record.note || '-'}</td>
            </tr>
        `;
    });
    
    if (bodyHTML === '') {
        bodyHTML = '<tr><td colspan="6" class="text-center text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –∑–∞–¥–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏</td></tr>';
    }
    
    tableBody.innerHTML = bodyHTML;
    document.getElementById('calculationResults').style.display = 'block';
    document.getElementById('exportCalculationBtn').style.display = total > 0 ? 'inline-block' : 'none';
}

// –°–∫–∏–¥–∞–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É
function resetCalculation() {
    document.getElementById('calcDateFrom').value = '';
    document.getElementById('calcDateTo').value = '';
    document.getElementById('calcTeacher').value = '';
    document.getElementById('calcClub').value = '';
    document.getElementById('calcBasis').value = '';
    document.getElementById('calculationResults').style.display = 'none';
    window.calculationData = [];
}

// –ï–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü—ñ—ó
function exportCurrentData() {
    const currentRecords = getCurrentlyDisplayedRecords();
    exportToExcel(currentRecords, 'payroll_current_data');
}

function exportCalculation() {
    if (window.calculationData && window.calculationData.length > 0) {
        exportToExcel(window.calculationData, 'payroll_calculation_results');
    } else {
        showAlert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'warning');
    }
}

function getCurrentlyDisplayedRecords() {
    // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ç—ñ —Å–∞–º—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ —â–æ —ñ –≤ filterPayroll()
    const dateFilter = document.getElementById('filterDate').value;
    const teacherFilter = parseInt(document.getElementById('filterTeacher').value);
    const clubFilter = parseInt(document.getElementById('filterClub').value);
    const basisFilter = document.getElementById('filterBasis').value;
    const amountFilter = parseFloat(document.getElementById('filterAmount').value);
    const noteFilter = document.getElementById('filterNote').value.toLowerCase();
    
    let filtered = allPayrollRecords;
    
    if (dateFilter) {
        const filterDate = new Date(dateFilter);
        filtered = filtered.filter(r => {
            if (!r.lesson_date) return false;
            return new Date(r.lesson_date).toDateString() === filterDate.toDateString();
        });
    }
    if (teacherFilter) filtered = filtered.filter(r => r.teacher_id === teacherFilter);
    if (clubFilter) {
        filtered = filtered.filter(r => {
            const club = allClubs.find(c => c.name === r.club_name);
            return club && club.id === clubFilter;
        });
    }
    if (basisFilter) filtered = filtered.filter(r => r.basis === basisFilter);
    if (!isNaN(amountFilter)) filtered = filtered.filter(r => parseFloat(r.amount_decimal) >= amountFilter);
    if (noteFilter) filtered = filtered.filter(r => (r.note || '').toLowerCase().includes(noteFilter));
    
    return filtered;
}

function exportToExcel(records, filename) {
    if (records.length === 0) {
        showAlert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'warning');
        return;
    }
    
    const exportData = records.map(record => {
        const teacher = allTeachers.find(t => t.id === record.teacher_id);
        const club = record.club_name 
            ? allClubs.find(c => c.name === record.club_name) : null;
        
        return {
            '–î–∞—Ç–∞': record.lesson_date 
                ? new Date(record.lesson_date).toLocaleDateString('uk-UA') : '-',
            '–í—á–∏—Ç–µ–ª—å': teacher ? teacher.full_name : 'N/A',
            '–ì—É—Ä—Ç–æ–∫': club ? club.name : record.club_name || '-',
            '–û—Å–Ω–æ–≤–∞': record.basis === 'AUTO' ? '–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ' : '–í—Ä—É—á–Ω—É',
            '–°—É–º–∞ (‚Ç¥)': parseFloat(record.amount_decimal),
            '–ü—Ä–∏–º—ñ—Ç–∫–∞': record.note || '-'
        };
    });
    
    // –°—Ç–≤–æ—Ä—é—î–º–æ Excel —Ñ–∞–π–ª –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é XLSX.js
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–ó–∞—Ä–ø–ª–∞—Ç–∞');
    
    // –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ —è–∫ .xlsx —Ñ–∞–π–ª
    XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
    
    showAlert(`–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${exportData.length} –∑–∞–ø–∏—Å—ñ–≤ —É Excel —Ñ–∞–π–ª`, 'success');
}

function convertToCSV(data) {
    if (data.length === 0) return '';
    const headers = Object.keys(data[0]);
    const csvRows = [headers.join(',')];
    
    data.forEach(row => {
        const values = headers.map(header => {
            const value = row[header];
            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
        });
        csvRows.push(values.join(','));
    });
    
    return csvRows.join('\n');
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', () => {
    loadAllPayrollData();
});
</script>
{% endblock %}
