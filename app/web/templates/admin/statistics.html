{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-graph-up-arrow text-primary"></i>
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </h2>
        <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="exportStatistics()">
                <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="refreshStatistics()">
                <i class="bi bi-arrow-clockwise"></i> –û–Ω–æ–≤–∏—Ç–∏
            </button>
        </div>
    </div>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <div class="card shadow mb-4">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i> –§—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
            </h5>
        </div>
        <div class="card-body">
            <form id="statisticsFilters" class="row g-3">
                <!-- –ß–∞—Å–æ–≤–∏–π –ø–µ—Ä—ñ–æ–¥ -->
                <div class="col-md-3">
                    <label for="startDate" class="form-label">–í—ñ–¥ –¥–∞—Ç–∏</label>
                    <input type="date" class="form-control" id="startDate" name="start_date">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">–î–æ –¥–∞—Ç–∏</label>
                    <input type="date" class="form-control" id="endDate" name="end_date">
                </div>
                
                <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
                <div class="col-md-3">
                    <label for="clubFilter" class="form-label">–ì—É—Ä—Ç–æ–∫</label>
                    <select class="form-select" id="clubFilter" name="club_id">
                        <option value="">–í—Å—ñ –≥—É—Ä—Ç–∫–∏</option>
                        {% for club in clubs %}
                        <option value="{{ club.id }}">{{ club.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="teacherFilter" class="form-label">–í—á–∏—Ç–µ–ª—å</label>
                    <select class="form-select" id="teacherFilter" name="teacher_id">
                        <option value="">–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ</option>
                        {% for teacher in teachers %}
                        <option value="{{ teacher.id }}">{{ teacher.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- –®–≤–∏–¥–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ -->
                <div class="col-12">
                    <label class="form-label">–®–≤–∏–¥–∫—ñ –ø–µ—Ä—ñ–æ–¥–∏</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="setQuickPeriod('today')">–°—å–æ–≥–æ–¥–Ω—ñ</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setQuickPeriod('week')">–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setQuickPeriod('month')">–¶–µ–π –º—ñ—Å—è—Ü—å</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setQuickPeriod('quarter')">–¶–µ–π –∫–≤–∞—Ä—Ç–∞–ª</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setQuickPeriod('year')">–¶–µ–π —Ä—ñ–∫</button>
                        <button type="button" class="btn btn-outline-danger" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-search"></i> –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="statisticsLoading" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
        </div>
        <p class="mt-2">–û–±—á–∏—Å–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="statisticsContent">
        
        <!-- –ê–õ–ï–†–¢–ò (–∑–≤–µ—Ä—Ö—É, —á–µ—Ä–≤–æ–Ω–∞ –∫–∞—Ä—Ç–∞) -->
        <div id="alertsSection" class="mb-4" style="display: none;">
            <div class="card shadow border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i> –ê–ª–µ—Ä—Ç–∏ —Ç–∞ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
                    </h5>
                </div>
                <div class="card-body" id="alertsContainer">
                    <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4" id="overviewStats">
            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è JavaScript -->
        </div>

        <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart"></i> –í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="attendanceStatsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart"></i> –í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å –ø–æ –¥–Ω—è—Ö —Ç–∏–∂–Ω—è
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="weekdayStatsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–û–í–Ü –°–ï–ö–¶–Ü–á: –¢—Ä–µ–Ω–¥–∏ + –ü—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ + KPI -->
        <div class="row mb-4">
            <!-- –¢—Ä–µ–Ω–¥–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up"></i> –¢—Ä–µ–Ω–¥–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="trendsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ü—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ –∑–∞–Ω—è—Ç—å -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> –ü—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ –∑–∞–Ω—è—Ç—å
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="peakHoursContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI –ø–æ–∫–∞–∑–Ω–∏–∫–∏ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-gradient-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-bullseye"></i> KPI –ø–æ–∫–∞–∑–Ω–∏–∫–∏
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="kpiContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—É—Ä—Ç–∫—ñ–≤ —Ç–∞ –≤—á–∏—Ç–µ–ª—ñ–≤ -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-warning text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-collection"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—É—Ä—Ç–∫—ñ–≤
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="clubsStatsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—á–∏—Ç–µ–ª—ñ–≤
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="teachersStatsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑—ñ –∑–æ–Ω–∏ —Ä–∏–∑–∏–∫—É + –ö–∞–ª–µ–Ω–¥–∞—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ -->
        <div class="row mb-4">
            <!-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑—ñ –∑–æ–Ω–∏ —Ä–∏–∑–∏–∫—É -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle"></i> –°—Ç—É–¥–µ–Ω—Ç–∏ –∑—ñ –∑–æ–Ω–∏ —Ä–∏–∑–∏–∫—É
                        </h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="atRiskStudentsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar3"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
                        </h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="activityCalendarContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–∏ —Ç–∞ –ø—ñ–ª—å–≥–∏ -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-trophy"></i> –¢–æ–ø-10 —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—é
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="topStudentsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-secondary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-award"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—ñ–ª—å–≥
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="benefitsStatsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-lg-12 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-gradient-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-currency-dollar"></i> –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="financialStatsContainer">
                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="clubs-tab" data-bs-toggle="tab" data-bs-target="#clubs-tabpane" type="button" role="tab">
                                    <i class="bi bi-collection"></i> –ì—É—Ä—Ç–∫–∏
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers-tabpane" type="button" role="tab">
                                    <i class="bi bi-person-badge"></i> –í—á–∏—Ç–µ–ª—ñ
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students-tabpane" type="button" role="tab">
                                    <i class="bi bi-person"></i> –°—Ç—É–¥–µ–Ω—Ç–∏
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="clubs-tabpane" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="clubsTable">
                                        <thead>
                                            <tr>
                                                <th>–ì—É—Ä—Ç–æ–∫</th>
                                                <th>–ó–∞–ø–∏—Å–∞–Ω–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</th>
                                                <th>–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</th>
                                                <th>–î—ñ—ó</th>
                                            </tr>
                                        </thead>
                                        <tbody id="clubsTableBody">
                                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="teachers-tabpane" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="teachersTable">
                                        <thead>
                                            <tr>
                                                <th>–í—á–∏—Ç–µ–ª—å</th>
                                                <th>–†–æ–∑–∫–ª–∞–¥—ñ–≤</th>
                                                <th>–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —É—Ä–æ–∫—ñ–≤</th>
                                                <th>–°—Ç—É–¥–µ–Ω—Ç—ñ–≤ –Ω–∞–≤—á–µ–Ω–æ</th>
                                                <th>–î—ñ—ó</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teachersTableBody">
                                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="students-tabpane" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="studentsTable">
                                        <thead>
                                            <tr>
                                                <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                                                <th>–ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö</th>
                                                <th>–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤</th>
                                                <th>–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</th>
                                                <th>–î—ñ—ó</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentsTableBody">
                                            <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Custom styles -->
<style>
.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
}
.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #1e7e34);
}
.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #138496);
}
.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #e0a800);
}
.bg-gradient-danger {
    background: linear-gradient(45deg, #dc3545, #c82333);
}
.bg-gradient-secondary {
    background: linear-gradient(45deg, #6c757d, #5a6268);
}
.bg-gradient-dark {
    background: linear-gradient(45deg, #343a40, #23272b);
}

.stats-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
}
.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.stats-card-primary { border-color: #007bff; }
.stats-card-success { border-color: #28a745; }
.stats-card-info { border-color: #17a2b8; }
.stats-card-warning { border-color: #ffc107; }

.chart-container {
    position: relative;
    height: 300px;
    margin: 10px 0;
}

.progress-ring {
    border-radius: 50%;
    background: conic-gradient(#28a745 0deg, #28a745 var(--progress-deg), #e9ecef var(--progress-deg), #e9ecef 360deg);
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.progress-ring::before {
    content: '';
    position: absolute;
    width: 60px;
    height: 60px;
    background: white;
    border-radius: 50%;
}
.progress-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 0.9rem;
}
</style>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–∞ Chart.js —ñ–Ω—Å—Ç–∞–Ω—Å—ñ–≤
let currentStatistics = null;
let charts = {};

// API –∫–ª—ñ—î–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function fetchStatistics(filters = {}) {
    const params = new URLSearchParams();
    
    if (filters.start_date) params.append('start_date', filters.start_date);
    if (filters.end_date) params.append('end_date', filters.end_date);
    if (filters.club_id) params.append('club_id', filters.club_id);
    if (filters.teacher_id) params.append('teacher_id', filters.teacher_id);
    
    const url = `/api/statistics?${params.toString()}`;
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        console.error('Error fetching statistics:', error);
        throw error;
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function loadStatistics(filters = {}) {
    try {
        document.getElementById('statisticsLoading').style.display = 'block';
        document.getElementById('statisticsContent').style.opacity = '0.5';
        
        const data = await fetchStatistics(filters);
        currentStatistics = data;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—Å—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
        updateOverviewStats(data.overview);
        updateAttendanceCharts(data.attendance);
        updateClubsStats(data.clubs);
        updateTeachersStats(data.teachers);
        updateTopStudents(data.top_students);
        updateBenefitsChart(data.benefits);
        updateFinancialStats(data.financial);
        updateDetailedTables(data);
        
        // –ù–û–í–Ü –ö–û–ú–ü–û–ù–ï–ù–¢–ò
        updateAlerts(data.alerts);
        updateAttendanceTrends(data.attendance_trends);
        updatePeakHours(data.peak_hours);
        updateKPIMetrics(data.kpi_metrics);
        updateAtRiskStudents(data.at_risk_students);
        updateActivityCalendar(data.activity_calendar);
        
        console.log('‚úÖ Statistics loaded successfully (including new metrics)');
        
    } catch (error) {
        console.error('‚ùå Error loading statistics:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'danger');
    } finally {
        document.getElementById('statisticsLoading').style.display = 'none';
        document.getElementById('statisticsContent').style.opacity = '1';
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateOverviewStats(overview) {
    const container = document.getElementById('overviewStats');
    
    const filterInfo = overview.filter_period;
    const periodText = filterInfo.start_date || filterInfo.end_date ? 
        `(${filterInfo.start_date || '...'} - ${filterInfo.end_date || '...'})` : 
        '(–í–µ—Å—å –ø–µ—Ä—ñ–æ–¥)';
    
    container.innerHTML = `
        <div class="col-md-3 mb-3">
            <div class="card stats-card stats-card-primary shadow">
                <div class="card-body text-center">
                    <i class="bi bi-people fs-1 text-primary mb-2"></i>
                    <h3 class="text-primary">${overview.total_students}</h3>
                    <p class="mb-0">–°—Ç—É–¥–µ–Ω—Ç—ñ–≤</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card stats-card-success shadow">
                <div class="card-body text-center">
                    <i class="bi bi-person-badge fs-1 text-success mb-2"></i>
                    <h3 class="text-success">${overview.total_teachers}</h3>
                    <p class="mb-0">–í—á–∏—Ç–µ–ª—ñ–≤</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card stats-card-info shadow">
                <div class="card-body text-center">
                    <i class="bi bi-collection fs-1 text-info mb-2"></i>
                    <h3 class="text-info">${overview.total_clubs}</h3>
                    <p class="mb-0">–ì—É—Ä—Ç–∫—ñ–≤</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card stats-card-warning shadow">
                <div class="card-body text-center">
                    <i class="bi bi-calendar3 fs-1 text-warning mb-2"></i>
                    <h3 class="text-warning">${overview.total_schedules}</h3>
                    <p class="mb-0">–†–æ–∑–∫–ª–∞–¥—ñ–≤</p>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>–ü–µ—Ä—ñ–æ–¥ –∞–Ω–∞–ª—ñ–∑—É:</strong> ${periodText}
                ${filterInfo.club_id ? `<br><strong>–ì—É—Ä—Ç–æ–∫:</strong> ID ${filterInfo.club_id}` : ''}
                ${filterInfo.teacher_id ? `<br><strong>–í—á–∏—Ç–µ–ª—å:</strong> ID ${filterInfo.teacher_id}` : ''}
            </div>
        </div>
    `;
}

// –®–≤–∏–¥–∫—ñ –ø–µ—Ä—ñ–æ–¥–∏
function setQuickPeriod(period) {
    const now = new Date();
    let startDate, endDate;
    
    switch(period) {
        case 'today':
            startDate = endDate = now.toISOString().split('T')[0];
            break;
        case 'week':
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay() + 1); // –ü–æ–Ω–µ–¥—ñ–ª–æ–∫
            startDate = weekStart.toISOString().split('T')[0];
            endDate = now.toISOString().split('T')[0];
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            endDate = now.toISOString().split('T')[0];
            break;
        case 'quarter':
            const quarter = Math.floor(now.getMonth() / 3);
            startDate = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
            endDate = now.toISOString().split('T')[0];
            break;
        case 'year':
            startDate = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
            endDate = now.toISOString().split('T')[0];
            break;
    }
    
    if (startDate) document.getElementById('startDate').value = startDate;
    if (endDate) document.getElementById('endDate').value = endDate;
}

function clearFilters() {
    document.getElementById('statisticsFilters').reset();
}

// –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('statisticsFilters');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const filters = {};
        
        for (let [key, value] of formData.entries()) {
            if (value) filters[key] = value;
        }
        
        loadStatistics(filters);
    });
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    loadStatistics();
});

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π (–∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è Chart.js –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤)
function updateAttendanceCharts(attendance) {
    console.log('Updating attendance charts:', attendance);
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ
    const attendanceContainer = document.getElementById('attendanceStatsContainer');
    if (!attendance) {
        attendanceContainer.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</p>';
        return;
    }
    
    attendanceContainer.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-primary">${attendance.total_records || 0}</h4>
                    <p class="mb-0">–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-success">${attendance.present_count || 0}</h4>
                    <p class="mb-0">–ü—Ä–∏—Å—É—Ç–Ω—ñ</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-danger">${attendance.absent_count || 0}</h4>
                    <p class="mb-0">–í—ñ–¥—Å—É—Ç–Ω—ñ</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-info">${attendance.attendance_rate || 0}%</h4>
                    <p class="mb-0">–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</p>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <div class="progress">
                <div class="progress-bar bg-success" style="width: ${attendance.attendance_rate || 0}%">
                    ${attendance.present_count || 0} –ø—Ä–∏—Å—É—Ç–Ω—ñ—Ö
                </div>
                <div class="progress-bar bg-danger" style="width: ${100 - (attendance.attendance_rate || 0)}%">
                    ${attendance.absent_count || 0} –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö
                </div>
            </div>
        </div>
    `;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–Ω—è—Ö —Ç–∏–∂–Ω—è
    const weekdayContainer = document.getElementById('weekdayStatsContainer');
    if (weekdayContainer && attendance.weekday_stats) {
        const weekdayStats = attendance.weekday_stats;
        
        if (weekdayStats.length === 0 || weekdayStats.every(day => day.total === 0)) {
            weekdayContainer.innerHTML = `
                <div class="text-center p-4">
                    <i class="bi bi-calendar-week text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å –ø–æ –¥–Ω—è—Ö —Ç–∏–∂–Ω—è</p>
                </div>
            `;
            return;
        }
        
        weekdayContainer.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>–î–µ–Ω—å —Ç–∏–∂–Ω—è</th>
                            <th class="text-center">–í—Å—å–æ–≥–æ</th>
                            <th class="text-center">–ü—Ä–∏—Å—É—Ç–Ω—ñ</th>
                            <th class="text-center">–í—ñ–¥—Å—É—Ç–Ω—ñ</th>
                            <th class="text-center">–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${weekdayStats.map(day => `
                            <tr>
                                <td><strong>${day.day}</strong></td>
                                <td class="text-center">${day.total}</td>
                                <td class="text-center text-success">${day.present}</td>
                                <td class="text-center text-danger">${day.absent}</td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">${day.attendance_rate}%</span>
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar bg-success" 
                                                 style="width: ${day.attendance_rate}%"></div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
}

function updateClubsStats(clubs) {
    const container = document.getElementById('clubsStatsContainer');
    
    // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ undefined/null clubs
    if (!clubs || !Array.isArray(clubs)) {
        container.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≥—É—Ä—Ç–∫–∏</p>';
        return;
    }
    
    container.innerHTML = clubs.map(club => `
        <div class="mb-2">
            <div class="d-flex justify-content-between">
                <span>${club.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –≥—É—Ä—Ç–æ–∫'}</span>
                <span class="badge bg-primary">${club.enrolled_students || 0} —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</span>
            </div>
            <div class="progress">
                <div class="progress-bar" style="width: ${club.attendance_rate || 0}%">${club.attendance_rate || 0}%</div>
            </div>
        </div>
    `).join('');
}

function updateTeachersStats(teachers) {
    const container = document.getElementById('teachersStatsContainer');
    
    // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ undefined/null teachers
    if (!teachers || !Array.isArray(teachers)) {
        container.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤—á–∏—Ç–µ–ª—ñ–≤</p>';
        return;
    }
    
    container.innerHTML = teachers.map(teacher => `
        <div class="mb-3 p-2 border rounded">
            <strong>${teacher.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –≤—á–∏—Ç–µ–ª—å'}</strong>
            <br>
            <small>–†–æ–∑–∫–ª–∞–¥—ñ–≤: ${teacher.schedules_count || 0} | –£—Ä–æ–∫—ñ–≤: ${teacher.lessons_conducted || 0} | –°—Ç—É–¥–µ–Ω—Ç—ñ–≤: ${teacher.students_taught || 0}</small>
        </div>
    `).join('');
}

function updateTopStudents(students) {
    const container = document.getElementById('topStudentsContainer');
    
    // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ undefined/null students
    if (!students || !Array.isArray(students)) {
        container.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</p>';
        return;
    }
    
    container.innerHTML = students.map((student, index) => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>
                <span class="badge bg-secondary me-2">${index + 1}</span>
                ${student.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç—É–¥–µ–Ω—Ç'}
            </span>
            <span class="badge bg-success">${student.attendance_rate || 0}%</span>
        </div>
    `).join('');
}

function updateBenefitsChart(benefits) {
    console.log('Updating benefits chart:', benefits);
    
    const benefitsContainer = document.getElementById('benefitsStatsContainer');
    if (!benefits) {
        benefitsContainer.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –ø—ñ–ª—å–≥–∏</p>';
        return;
    }
    
    // –î–∞–Ω—ñ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø—ñ–ª—å–≥
    const benefitsData = [
        { label: '–ú–∞–ª–æ–∑–∞–±–µ–∑–ø–µ—á–µ–Ω—ñ', value: benefits.low_income || 0, color: '#ff6384' },
        { label: '–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω—ñ —Å—ñ–º\'—ó', value: benefits.large_family || 0, color: '#36a2eb' },
        { label: '–°—ñ–º\'—ó –≤—ñ–π—Å—å–∫–æ–≤–∏—Ö', value: benefits.military_family || 0, color: '#ffce56' },
        { label: '–í–Ω—É—Ç—Ä—ñ—à–Ω—å–æ –ø–µ—Ä–µ–º—ñ—â–µ–Ω—ñ', value: benefits.internally_displaced || 0, color: '#4bc0c0' },
        { label: '–°–∏—Ä–æ—Ç–∏', value: benefits.orphan || 0, color: '#9966ff' },
        { label: '–Ü–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å', value: benefits.disability || 0, color: '#ff9f40' },
        { label: '–°–æ—Ü—ñ–∞–ª—å–Ω–∏–π —Ä–∏–∑–∏–∫', value: benefits.social_risk || 0, color: '#ff6384' },
        { label: '–ë–µ–∑ –ø—ñ–ª—å–≥', value: benefits.no_benefits || 0, color: '#c9cbcf' }
    ];
    
    // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –ø—ñ–ª—å–≥–∏, —â–æ –º–∞—é—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è > 0
    const nonZeroBenefits = benefitsData.filter(benefit => benefit.value > 0);
    
    if (nonZeroBenefits.length === 0) {
        benefitsContainer.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –ø—ñ–ª—å–≥–∞–º–∏</p>';
        return;
    }
    
    // –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –ø—ñ–ª—å–≥–∞–º–∏
    const totalWithBenefits = nonZeroBenefits.reduce((sum, benefit) => sum + benefit.value, 0);
    
    benefitsContainer.innerHTML = `
        <div class="row">
            ${nonZeroBenefits.map(benefit => `
                <div class="col-md-6 mb-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div style="width: 20px; height: 20px; background-color: ${benefit.color}; border-radius: 3px;"></div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small">${benefit.label}</span>
                                <strong>${benefit.value}</strong>
                            </div>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar" 
                                     style="width: ${(benefit.value / totalWithBenefits * 100).toFixed(1)}%; background-color: ${benefit.color};">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        <div class="mt-3 p-3 bg-light rounded">
            <div class="row text-center">
                <div class="col-md-6">
                    <h5 class="text-primary">${totalWithBenefits}</h5>
                    <small class="text-muted">–°—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –ø—ñ–ª—å–≥–∞–º–∏</small>
                </div>
                <div class="col-md-6">
                    <h5 class="text-secondary">${((totalWithBenefits / (totalWithBenefits + (benefits.no_benefits || 0))) * 100).toFixed(1)}%</h5>
                    <small class="text-muted">–í—ñ–¥—Å–æ—Ç–æ–∫ –∑ –ø—ñ–ª—å–≥–∞–º–∏</small>
                </div>
            </div>
        </div>
    `;
}

function updateFinancialStats(financial) {
    const container = document.getElementById('financialStatsContainer');
    
    // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ undefined –∑–Ω–∞—á–µ–Ω—å
    const payrollRecords = financial?.total_payroll_records || 0;
    const totalAmount = financial?.total_amount || 0;
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="text-center">
                    <h4 class="text-primary">${payrollRecords}</h4>
                    <p class="mb-0">–ó–∞–ø–∏—Å—ñ–≤ –∑–∞—Ä–ø–ª–∞—Ç–∏</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="text-center">
                    <h4 class="text-success">${totalAmount.toFixed(2)} ‚Ç¥</h4>
                    <p class="mb-0">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞</p>
                </div>
            </div>
        </div>
    `;
}

function updateDetailedTables(data) {
    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–±–ª–∏—Ü—ñ –≤ —Ç–∞–±–∞—Ö
    const clubsTableBody = document.getElementById('clubsTableBody');
    const teachersTableBody = document.getElementById('teachersTableBody');
    const studentsTableBody = document.getElementById('studentsTableBody');
    
    // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ undefined data
    if (!data) {
        console.error('Data is undefined in updateDetailedTables');
        return;
    }
    
    // –¢–∞–±–ª–∏—Ü—è –≥—É—Ä—Ç–∫—ñ–≤
    const clubs = data.clubs || [];
    clubsTableBody.innerHTML = clubs.map(club => `
        <tr>
            <td>${club.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –≥—É—Ä—Ç–æ–∫'}</td>
            <td>${club.enrolled_students || 0}</td>
            <td>
                <div class="progress">
                    <div class="progress-bar bg-success" style="width: ${club.attendance_rate || 0}%">${club.attendance_rate || 0}%</div>
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="filterByClub(${club.id || 0})">
                    <i class="bi bi-funnel"></i>
                </button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="4" class="text-center text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≥—É—Ä—Ç–∫–∏</td></tr>';
    
    // –¢–∞–±–ª–∏—Ü—è –≤—á–∏—Ç–µ–ª—ñ–≤
    const teachers = data.teachers || [];
    teachersTableBody.innerHTML = teachers.map(teacher => `
        <tr>
            <td>${teacher.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –≤—á–∏—Ç–µ–ª—å'}</td>
            <td>${teacher.schedules_count || 0}</td>
            <td>${teacher.lessons_conducted || 0}</td>
            <td>${teacher.students_taught || 0}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="filterByTeacher(${teacher.id || 0})">
                    <i class="bi bi-funnel"></i>
                </button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="5" class="text-center text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤—á–∏—Ç–µ–ª—ñ–≤</td></tr>';
    
    // –¢–∞–±–ª–∏—Ü—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
    const students = data.top_students || [];
    studentsTableBody.innerHTML = students.map(student => `
        <tr>
            <td>${student.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç—É–¥–µ–Ω—Ç'}</td>
            <td>${student.present_count || 0}</td>
            <td>${student.total_attendance || 0}</td>
            <td>
                <div class="progress">
                    <div class="progress-bar bg-success" style="width: ${student.attendance_rate || 0}%">${student.attendance_rate || 0}%</div>
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="viewStudentDetails(${student.id || 0})">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="5" class="text-center text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</td></tr>';
}

// –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
function filterByClub(clubId) {
    document.getElementById('clubFilter').value = clubId;
    document.getElementById('statisticsFilters').dispatchEvent(new Event('submit'));
}

function filterByTeacher(teacherId) {
    document.getElementById('teacherFilter').value = teacherId;
    document.getElementById('statisticsFilters').dispatchEvent(new Event('submit'));
}

function viewStudentDetails(studentId) {
    window.open(`/admin/students/${studentId}/full`, '_blank');
}

function refreshStatistics() {
    const form = document.getElementById('statisticsFilters');
    form.dispatchEvent(new Event('submit'));
}

function exportStatistics() {
    if (!currentStatistics) {
        showAlert('–°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É', 'warning');
        return;
    }
    
    // TODO: Implement export functionality
    showAlert('–§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –±—É–¥–µ –¥–æ–¥–∞–Ω–∞ –ø—ñ–∑–Ω—ñ—à–µ', 'info');
}

// –£—Ç–∏–ª—ñ—Ç–∞—Ä–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// ============ –ù–û–í–Ü –§–£–ù–ö–¶–Ü–á –î–õ–Ø –ù–û–í–ò–• –ú–ï–¢–†–ò–ö ============

// 1. –ê–õ–ï–†–¢–ò –¢–ê –ü–û–ü–ï–†–ï–î–ñ–ï–ù–ù–Ø
function updateAlerts(alerts) {
    console.log('üîî Updating alerts:', alerts);
    const alertsSection = document.getElementById('alertsSection');
    const alertsContainer = document.getElementById('alertsContainer');
    
    if (!alerts || alerts.length === 0) {
        alertsSection.style.display = 'none';
        return;
    }
    
    alertsSection.style.display = 'block';
    
    const alertTypeColors = {
        'danger': 'danger',
        'warning': 'warning',
        'info': 'info'
    };
    
    alertsContainer.innerHTML = alerts.map(alert => `
        <div class="alert alert-${alertTypeColors[alert.type] || 'info'} mb-2">
            <i class="bi bi-${alert.icon}"></i>
            <strong>${alert.message}</strong>
            ${alert.count ? `<span class="badge bg-${alertTypeColors[alert.type] || 'info'} ms-2">${alert.count}</span>` : ''}
        </div>
    `).join('');
}

// 2. –¢–†–ï–ù–î–ò –í–Ü–î–í–Ü–î–£–í–ê–ù–û–°–¢–Ü
function updateAttendanceTrends(trends) {
    console.log('üìà Updating attendance trends:', trends);
    const container = document.getElementById('trendsContainer');
    
    if (!trends || trends.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ —Ç—Ä–µ–Ω–¥—ñ–≤</p>';
        return;
    }
    
    // –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç—Ä–µ–Ω–¥—ñ–≤ —è–∫ —Ç–∞–±–ª–∏—Ü—è –∑ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–∞–º–∏
    const avgRate = (trends.reduce((sum, t) => sum + t.attendance_rate, 0) / trends.length).toFixed(2);
    
    container.innerHTML = `
        <div class="mb-3 text-center">
            <h4 class="text-primary">${avgRate}%</h4>
            <small class="text-muted">–°–µ—Ä–µ–¥–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å –∑–∞ –ø–µ—Ä—ñ–æ–¥</small>
        </div>
        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>–ü–µ—Ä—ñ–æ–¥</th>
                        <th class="text-center">–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</th>
                        <th class="text-center">–£—Ä–æ–∫—ñ–≤</th>
                    </tr>
                </thead>
                <tbody>
                    ${trends.map(trend => `
                        <tr title="–ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö: ${trend.present} –∑ ${trend.total_attendance_records || trend.total} –∑–∞–ø–∏—Å—ñ–≤ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ">
                            <td><strong>${trend.period}</strong></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="me-2">${trend.attendance_rate}%</span>
                                    <div class="progress flex-grow-1" style="height: 8px;">
                                        <div class="progress-bar ${trend.attendance_rate >= 80 ? 'bg-success' : trend.attendance_rate >= 60 ? 'bg-warning' : 'bg-danger'}" 
                                             style="width: ${trend.attendance_rate}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <strong>${trend.total}</strong>
                                <small class="text-muted d-block">—É—Ä–æ–∫—ñ–≤</small>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// 3. –ü–Ü–ö–û–í–Ü –ì–û–î–ò–ù–ò –ó–ê–ù–Ø–¢–¨
function updatePeakHours(peakHours) {
    console.log('‚è∞ Updating peak hours:', peakHours);
    const container = document.getElementById('peakHoursContainer');
    
    if (!peakHours || !peakHours.hours || peakHours.hours.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –ø—Ä–æ –≥–æ–¥–∏–Ω–∏ –∑–∞–Ω—è—Ç—å</p>';
        return;
    }
    
    const maxLessons = Math.max(...peakHours.hours.map(h => h.lessons_count));
    const peakHourInfo = peakHours.peak_hour;
    
    container.innerHTML = `
        ${peakHourInfo ? `
        <div class="mb-3 text-center">
            <h4 class="text-info">${peakHourInfo.hour}</h4>
            <small class="text-muted">–ù–∞–π–∞–∫—Ç–∏–≤–Ω—ñ—à–∞ –≥–æ–¥–∏–Ω–∞ (${peakHourInfo.lessons_count} —É—Ä–æ–∫—ñ–≤)</small>
        </div>
        ` : ''}
        <div style="max-height: 300px; overflow-y: auto;">
            ${peakHours.hours.map(hour => {
                const percentage = (hour.lessons_count / maxLessons * 100).toFixed(0);
                return `
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>${hour.hour}</span>
                        <span class="badge bg-info">${hour.lessons_count} —É—Ä–æ–∫—ñ–≤</span>
                    </div>
                    <div class="progress" style="height: 15px;">
                        <div class="progress-bar bg-info" style="width: ${percentage}%"></div>
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    `;
}

// 4. KPI –ú–ï–¢–†–ò–ö–ò
function updateKPIMetrics(kpi) {
    console.log('üéØ Updating KPI metrics:', kpi);
    const container = document.getElementById('kpiContainer');
    
    if (!kpi) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö KPI</p>';
        return;
    }
    
    const lessonsKpi = kpi.lessons_plan || {};
    const attendanceKpi = kpi.attendance_target || {};
    const occupancyKpi = kpi.club_occupancy || {};
    
    container.innerHTML = `
        <div class="alert alert-info mb-3">
            <strong><i class="bi bi-info-circle"></i> –ü–æ—è—Å–Ω–µ–Ω–Ω—è KPI:</strong>
            <ul class="mb-0 mt-2 small">
                <li><strong>–í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–ª–∞–Ω—É —É—Ä–æ–∫—ñ–≤:</strong> –°–∫—ñ–ª—å–∫–∏ –∑ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤ –±—É–ª–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ</li>
                <li><strong>–¶—ñ–ª—å–æ–≤–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å:</strong> –ù–∞—Å–∫—ñ–ª—å–∫–∏ –±–ª–∏–∑—å–∫–æ –¥–æ —Ü—ñ–ª—ñ 85% –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ</li>
                <li><strong>–ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å –≥—É—Ä—Ç–∫—ñ–≤:</strong> –°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –Ω–∞ –≥—É—Ä—Ç–æ–∫ (–º–∞–∫—Å. 15)</li>
            </ul>
        </div>
        <div class="row">
            <!-- –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–ª–∞–Ω—É —É—Ä–æ–∫—ñ–≤ -->
            <div class="col-md-4 mb-3">
                <h6><i class="bi bi-clipboard-check"></i> –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–ª–∞–Ω—É —É—Ä–æ–∫—ñ–≤</h6>
                <small class="text-muted">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —É—Ä–æ–∫—ñ–≤ –∑ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö</small>
                <div class="mb-2 mt-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span>–ü–ª–∞–Ω: ${lessonsKpi.planned || 0}</span>
                        <span>–§–∞–∫—Ç: ${lessonsKpi.completed || 0}</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar ${lessonsKpi.completion_rate >= 85 ? 'bg-success' : lessonsKpi.completion_rate >= 70 ? 'bg-warning' : 'bg-danger'}" 
                             style="width: ${lessonsKpi.completion_rate || 0}%">
                            ${lessonsKpi.completion_rate || 0}%
                        </div>
                    </div>
                    <small class="text-muted">
                        ${lessonsKpi.completion_rate >= 85 ? '‚úì –í—ñ–¥–º—ñ–Ω–Ω–æ!' : lessonsKpi.completion_rate >= 70 ? '‚ö† –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏' : '‚ùå –ù–∏–∑—å–∫–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫'}
                    </small>
                </div>
            </div>
            
            <!-- –¶—ñ–ª—å–æ–≤–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å -->
            <div class="col-md-4 mb-3">
                <h6><i class="bi bi-graph-up-arrow"></i> –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è —Ü—ñ–ª—å–æ–≤–æ—ó –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ</h6>
                <small class="text-muted">–ù–∞—Å–∫—ñ–ª—å–∫–∏ –±–ª–∏–∑—å–∫–æ –¥–æ —Ü—ñ–ª—ñ 85%</small>
                <div class="mb-2 mt-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span>–¶—ñ–ª—å: ${attendanceKpi.target || 85}%</span>
                        <span>–§–∞–∫—Ç: ${attendanceKpi.actual || 0}%</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar ${attendanceKpi.actual >= attendanceKpi.target ? 'bg-success' : 'bg-warning'}" 
                             style="width: ${Math.min(attendanceKpi.achievement_rate || 0, 100)}%">
                            ${attendanceKpi.achievement_rate || 0}%
                        </div>
                    </div>
                    ${attendanceKpi.actual >= attendanceKpi.target ? '<small class="text-success">‚úì –¶—ñ–ª—å –¥–æ—Å—è–≥–Ω—É—Ç–∞!</small>' : '<small class="text-warning">‚ö† –ü—Ä–∞—Ü—é—î–º–æ –Ω–∞–¥ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è–º</small>'}
                </div>
            </div>
            
            <!-- –ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å –≥—É—Ä—Ç–∫—ñ–≤ -->
            <div class="col-md-4 mb-3">
                <h6><i class="bi bi-people-fill"></i> –ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å –≥—É—Ä—Ç–∫—ñ–≤</h6>
                <small class="text-muted">–°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –Ω–∞ –≥—É—Ä—Ç–æ–∫</small>
                <div class="mb-2 mt-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span>–°–µ—Ä–µ–¥–Ω—è: ${occupancyKpi.avg_students || 0}</span>
                        <span>–ú–∞–∫—Å: ${occupancyKpi.max_students || 15}</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar ${occupancyKpi.occupancy_rate >= 70 ? 'bg-success' : occupancyKpi.occupancy_rate >= 50 ? 'bg-warning' : 'bg-danger'}" 
                             style="width: ${occupancyKpi.occupancy_rate || 0}%">
                            ${occupancyKpi.occupancy_rate || 0}%
                        </div>
                    </div>
                    <small class="text-muted">
                        ${occupancyKpi.occupancy_rate >= 70 ? '‚úì –ì—É—Ä—Ç–∫–∏ –¥–æ–±—Ä–µ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ' : occupancyKpi.occupancy_rate >= 50 ? '‚ö† –ú–æ–∂–Ω–∞ –Ω–∞–±—Ä–∞—Ç–∏ –±—ñ–ª—å—à–µ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤' : '‚ùå –ù–∏–∑—å–∫–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å'}
                    </small>
                </div>
            </div>
        </div>
    `;
}

// 5. –°–¢–£–î–ï–ù–¢–ò –ó–Ü –ó–û–ù–ò –†–ò–ó–ò–ö–£
function updateAtRiskStudents(students) {
    console.log('‚ö†Ô∏è Updating at-risk students:', students);
    const container = document.getElementById('atRiskStudentsContainer');
    
    if (!students || students.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <p class="text-success mt-2"><strong>–í—ñ–¥–º—ñ–Ω–Ω–æ!</strong></p>
                <p class="text-muted">–ù–µ–º–∞—î —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑—ñ –∑–æ–Ω–∏ —Ä–∏–∑–∏–∫—É</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = students.map(student => {
        const rateColor = student.attendance_rate < 50 ? 'danger' : 'warning';
        const icon = student.attendance_rate < 50 ? 'üî¥' : 'üü°';
        
        return `
        <div class="card mb-2 border-${rateColor}">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <strong>${icon} ${student.name}</strong>
                        <br>
                        <small class="text-muted">
                            –í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å: ${student.attendance_rate}% 
                            (–ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö: ${student.present_count} –∑ ${student.total_attendance})
                        </small>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-sm btn-primary" onclick="showStudentDetails(${student.id}, '${student.name}', ${student.attendance_rate}, ${student.present_count}, ${student.total_attendance}, '${student.phone || ''}')">
                            <i class="bi bi-info-circle"></i> –î–µ—Ç–∞–ª—ñ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∑—ñ –∑–æ–Ω–∏ —Ä–∏–∑–∏–∫—É
function showStudentDetails(studentId, studentName, attendanceRate, presentCount, totalAttendance, phone) {
    // –°—Ç–≤–æ—Ä—é—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    const modalHtml = `
        <div class="modal fade" id="studentDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle"></i> 
                            –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∑—ñ –∑–æ–Ω–∏ —Ä–∏–∑–∏–∫—É
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="card border-warning mb-3">
                            <div class="card-body">
                                <h4>${studentName}</h4>
                                <hr>
                                
                                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-light rounded">
                                            <h2 class="text-${attendanceRate < 50 ? 'danger' : 'warning'}">${attendanceRate}%</h2>
                                            <small class="text-muted">–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—ñ—Å—Ç—å</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-light rounded">
                                            <h2 class="text-success">${presentCount}</h2>
                                            <small class="text-muted">–ü—Ä–∏—Å—É—Ç–Ω—ñ—Ö</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-light rounded">
                                            <h2 class="text-danger">${totalAttendance - presentCount}</h2>
                                            <small class="text-muted">–í—ñ–¥—Å—É—Ç–Ω—ñ—Ö</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Progress bar -->
                                <div class="mb-3">
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-success" style="width: ${attendanceRate}%">
                                            –ü—Ä–∏—Å—É—Ç–Ω—ñ–π: ${attendanceRate}%
                                        </div>
                                        <div class="progress-bar bg-danger" style="width: ${100 - attendanceRate}%">
                                            –í—ñ–¥—Å—É—Ç–Ω—ñ–π: ${100 - attendanceRate}%
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
                                ${phone ? `
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-telephone"></i> –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</strong>
                                    <br>
                                    <a href="tel:${phone}" class="btn btn-primary btn-sm mt-2">
                                        <i class="bi bi-telephone-fill"></i> –ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏: ${phone}
                                    </a>
                                </div>
                                ` : '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –≤—ñ–¥—Å—É—Ç–Ω—è</div>'}
                                
                                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó -->
                                <div class="alert alert-${attendanceRate < 50 ? 'danger' : 'warning'}">
                                    <strong><i class="bi bi-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:</strong>
                                    <ul class="mb-0 mt-2">
                                        ${attendanceRate < 50 ? `
                                        <li>üî¥ <strong>–ö—Ä–∏—Ç–∏—á–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è!</strong> –¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –±–µ—Å—ñ–¥–∞ –∑ –±–∞—Ç—å–∫–∞–º–∏</li>
                                        <li>–†–æ–∑–≥–ª—è–Ω—É—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É</li>
                                        <li>–ó'—è—Å—É–≤–∞—Ç–∏ –ø—Ä–∏—á–∏–Ω–∏ —á–∞—Å—Ç–∏—Ö –ø—Ä–æ–ø—É—Å–∫—ñ–≤</li>
                                        ` : `
                                        <li>üü° –ù–µ–æ–±—Ö—ñ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–æ—Å—Ç—ñ</li>
                                        <li>–ó–≤'—è–∑–∞—Ç–∏—Å—å –∑ –±–∞—Ç—å–∫–∞–º–∏ –¥–ª—è –∑'—è—Å—É–≤–∞–Ω–Ω—è —Å–∏—Ç—É–∞—Ü—ñ—ó</li>
                                        <li>–ú–æ—Ç–∏–≤—É–≤–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –¥–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—è</li>
                                        `}
                                    </ul>
                                </div>
                                
                                <!-- –®–≤–∏–¥–∫—ñ –¥—ñ—ó -->
                                <div class="d-grid gap-2">
                                    <a href="/admin/students/${studentId}/full" class="btn btn-primary" target="_blank">
                                        <i class="bi bi-person-lines-fill"></i> –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ–≤–Ω—É –∫–∞—Ä—Ç–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —è–∫—â–æ —î
    const oldModal = document.getElementById('studentDetailsModal');
    if (oldModal) {
        oldModal.remove();
    }
    
    // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
    modal.show();
    
    // –í–∏–¥–∞–ª—è—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è
    document.getElementById('studentDetailsModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// 6. –ö–ê–õ–ï–ù–î–ê–† –ê–ö–¢–ò–í–ù–û–°–¢–Ü - –ù–û–í–ò–ô –î–ò–ó–ê–ô–ù
function updateActivityCalendar(calendar) {
    console.log('üìÖ Updating activity calendar:', calendar);
    const container = document.getElementById('activityCalendarContainer');
    
    if (!calendar || calendar.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</p>';
        return;
    }
    
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å. –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É—Ä–æ–∫—ñ–≤ –¥–ª—è –≤—ñ–¥–Ω–æ—Å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è
    const maxLessons = Math.max(...calendar.map(d => d.lessons_count), 1);
    
    container.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="bi bi-circle-fill text-success"></i> –í–∏—Å–æ–∫–µ (10+ —É—Ä–æ–∫—ñ–≤) | 
                    <i class="bi bi-circle-fill text-warning"></i> –°–µ—Ä–µ–¥–Ω—î (5-9) | 
                    <i class="bi bi-circle-fill text-secondary"></i> –ù–∏–∑—å–∫–µ (0-4)
                </small>
                <small class="text-muted">–í—Å—å–æ–≥–æ –¥–Ω—ñ–≤: ${calendar.length}</small>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">–î–∞—Ç–∞</th>
                        <th class="text-center">–î–µ–Ω—å —Ç–∏–∂–Ω—è</th>
                        <th>–£—Ä–æ–∫—ñ–≤</th>
                        <th>–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                    </tr>
                </thead>
                <tbody>
                    ${calendar.map(day => {
                        const date = new Date(day.date);
                        const dateStr = date.toLocaleDateString('uk-UA', { day: '2-digit', month: '2-digit' });
                        const weekday = date.toLocaleDateString('uk-UA', { weekday: 'short' });
                        
                        const badgeClass = 
                            day.activity_level === 'high' ? 'success' :
                            day.activity_level === 'medium' ? 'warning' :
                            'secondary';
                        
                        const barWidth = (day.lessons_count / maxLessons * 100).toFixed(0);
                        
                        return `
                        <tr>
                            <td class="text-center"><strong>${dateStr}</strong></td>
                            <td class="text-center text-muted">${weekday}</td>
                            <td class="text-center">
                                <span class="badge bg-${badgeClass}">${day.lessons_count}</span>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-${badgeClass}" style="width: ${barWidth}%">
                                        ${barWidth}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}
</script>
{% endblock %}
